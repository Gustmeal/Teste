{% extends "base.html" %}

{% block title %}Penalidades ANS - SUMOV{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">
                <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                Penalidades ANS
            </h2>
            <p class="text-muted mb-0">Gestão de deliberações de penalidades ANS</p>
        </div>
        <div>
            <a href="{{ url_for('sumov.penalidade_ans_consultar') }}" class="btn btn-success me-2">
                <i class="fas fa-calculator me-2"></i>Nova Consulta / Cálculo
            </a>
            <a href="{{ url_for('sumov.index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Voltar
            </a>
        </div>
    </div>

    <!-- Cards de Estatísticas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm border-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Deliberações Salvas</p>
                            <h3 class="fw-bold mb-0">{{ deliberacoes|length }}</h3>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-3 rounded">
                            <i class="fas fa-file-contract fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Contratos ANS Cadastrados</p>
                            <h3 class="fw-bold mb-0">{{ total_contratos_ans }}</h3>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-3 rounded">
                            <i class="fas fa-clipboard-list fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-danger">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1">Valor Total Penalidades</p>
                            <h3 class="fw-bold mb-0 text-danger">
                                {% set total_valor = deliberacoes|sum(attribute='VR_ANS') %}
                                R$ {{ "{:,.2f}".format(total_valor).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                            </h3>
                        </div>
                        <div class="bg-danger bg-opacity-10 p-3 rounded">
                            <i class="fas fa-dollar-sign fa-2x text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de Deliberações Salvas -->
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white py-3">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Deliberações de Penalidades ANS Salvas
            </h5>
        </div>
        <div class="card-body p-0">
            {% if deliberacoes %}
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Nº Contrato</th>
                            <th class="text-center">Data Estoque</th>
                            <th class="text-center">S/Nº</th>
                            <th class="text-center">03/2014</th>
                            <th class="text-center">13/2019</th>
                            <th class="text-end">Total ANS</th>
                            <th class="text-center" style="width: 100px;">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in deliberacoes %}
                        <tr>
                            <td>
                                <strong class="text-primary">{{ d.NU_CONTRATO }}</strong>
                            </td>
                            <td class="text-center">
                                <small>{{ d.DT_ESTOQUE.strftime('%d/%m/%Y') }}</small>
                            </td>
                            <td class="text-center">
                                {% if d.QTD_MESES_SN and d.QTD_MESES_SN > 0 %}
                                    <span class="badge bg-warning text-dark">{{ d.QTD_MESES_SN }}m</span>
                                    <br><small>R$ {{ "{:,.2f}".format(d.VR_PENALIDADE_SN).replace(',', 'X').replace('.', ',').replace('X', '.') }}</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if d.QTD_MESES_03_2014 and d.QTD_MESES_03_2014 > 0 %}
                                    <span class="badge bg-warning text-dark">{{ d.QTD_MESES_03_2014 }}m</span>
                                    <br><small>R$ {{ "{:,.2f}".format(d.VR_PENALIDADE_03_2014).replace(',', 'X').replace('.', ',').replace('X', '.') }}</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if d.QTD_MESES_13_2019 and d.QTD_MESES_13_2019 > 0 %}
                                    <span class="badge bg-warning text-dark">{{ d.QTD_MESES_13_2019 }}m</span>
                                    <br><small>R$ {{ "{:,.2f}".format(d.VR_PENALIDADE_13_2019).replace(',', 'X').replace('.', ',').replace('X', '.') }}</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                <strong class="text-danger">R$ {{ "{:,.2f}".format(d.VR_ANS).replace(',', 'X').replace('.', ',').replace('X', '.') }}</strong>
                            </td>
                            <td class="text-center">
                                <button type="button"
                                        class="btn btn-sm btn-danger"
                                        onclick="excluirDeliberacao('{{ d.NU_CONTRATO }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5>Nenhuma deliberação salva</h5>
                <p class="text-muted">Comece fazendo uma nova consulta e salvando os resultados.</p>
                <a href="{{ url_for('sumov.penalidade_ans_consultar') }}" class="btn btn-success">
                    <i class="fas fa-calculator me-2"></i>Nova Consulta
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function excluirDeliberacao(nuContrato) {
    if (!confirm(`Deseja realmente excluir a deliberação do contrato ${nuContrato}?`)) {
        return;
    }

    fetch('/sumov/penalidade-ans/excluir-deliberacao', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            nu_contrato: nuContrato
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao excluir deliberação');
    });
}
</script>
{% endblock %}