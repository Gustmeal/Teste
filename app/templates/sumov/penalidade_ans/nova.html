{% extends "base.html" %}

{% block title %}Nova Penalidade ANS - SUMOV{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">
                <i class="fas fa-plus-circle text-success me-2"></i>
                Cadastrar Penalidade ANS
            </h2>
            <p class="text-muted mb-0">Cadastro de nova penalidade ANS para contratos condominiais</p>
        </div>
        <div>
            <a href="{{ url_for('sumov.penalidade_ans_index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Voltar
            </a>
        </div>
    </div>

    <div class="row">
        <!-- COLUNA ESQUERDA: Formulário -->
        <div class="col-md-7">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>Dados da Penalidade
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST" id="formPenalidade">
                        <!-- Número do Contrato -->
                        <div class="mb-4">
                            <label for="nu_contrato" class="form-label fw-bold">
                                <i class="fas fa-file-contract text-primary me-1"></i>
                                Número do Contrato <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input type="text"
                                       class="form-control form-control-lg"
                                       id="nu_contrato"
                                       name="nu_contrato"
                                       placeholder="Digite o número do contrato"
                                       required>
                                <button type="button"
                                        class="btn btn-info"
                                        id="btnBuscarDados">
                                    <i class="fas fa-search me-2"></i>Buscar Dados
                                </button>
                            </div>
                            <small class="form-text text-muted">
                                Clique em "Buscar Dados" para carregar informações e calcular penalidades
                            </small>
                        </div>

                        <hr class="my-4">

                        <!-- Data Início Vigência -->
                        <div class="mb-3">
                            <label for="ini_vigencia" class="form-label fw-bold">
                                <i class="fas fa-calendar-alt text-success me-1"></i>
                                Data Início Vigência <span class="text-danger">*</span>
                            </label>
                            <input type="date"
                                   class="form-control"
                                   id="ini_vigencia"
                                   name="ini_vigencia"
                                   required>
                        </div>

                        <!-- Data Fim Vigência -->
                        <div class="mb-3">
                            <label for="fim_vigencia" class="form-label fw-bold">
                                <i class="fas fa-calendar-check text-danger me-1"></i>
                                Data Fim Vigência <span class="text-danger">*</span>
                            </label>
                            <input type="date"
                                   class="form-control"
                                   id="fim_vigencia"
                                   name="fim_vigencia"
                                   required>
                        </div>

                        <!-- Valor da Tarifa -->
                        <div class="mb-3">
                            <label for="vr_tarifa" class="form-label fw-bold">
                                <i class="fas fa-dollar-sign text-success me-1"></i>
                                Valor da Tarifa <span class="text-danger">*</span>
                            </label>
                            <input type="text"
                                   class="form-control"
                                   id="vr_tarifa"
                                   name="vr_tarifa"
                                   placeholder="0,00"
                                   required>
                        </div>

                        <!-- Prazo em Dias -->
                        <div class="mb-4">
                            <label for="prazo_dias" class="form-label fw-bold">
                                <i class="fas fa-clock text-warning me-1"></i>
                                Prazo em Dias
                            </label>
                            <input type="number"
                                   class="form-control"
                                   id="prazo_dias"
                                   name="prazo_dias"
                                   placeholder="Ex: 120">
                            <small class="form-text text-muted">Prazo para quitação dos débitos</small>
                        </div>

                        <!-- Botões -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save me-2"></i>Salvar Penalidade
                            </button>
                            <a href="{{ url_for('sumov.penalidade_ans_index') }}"
                               class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- COLUNA DIREITA: Dados do Contrato e Cálculos -->
        <div class="col-md-5">
            <!-- Card de Informações do Contrato -->
            <div class="card shadow-sm mb-3" id="cardInfoContrato" style="display: none;">
                <div class="card-header bg-info text-white py-2">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Informações do Contrato
                    </h6>
                </div>
                <div class="card-body">
                    <div id="dadosContrato"></div>
                </div>
            </div>

            <!-- Card de Cálculo de Penalidades -->
            <div class="card shadow-sm border-warning" id="cardCalculoPenalidades" style="display: none;">
                <div class="card-header bg-warning text-dark py-3">
                    <h6 class="mb-0">
                        <i class="fas fa-calculator me-2"></i>Cálculo de Penalidades ANS
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0" id="tabelaPenalidades">
                            <thead class="table-light">
                                <tr style="font-size: 0.85rem;">
                                    <th>Contrato</th>
                                    <th class="text-center">Meses</th>
                                    <th class="text-end">Vlr Unit.</th>
                                    <th class="text-end">Total</th>
                                </tr>
                            </thead>
                            <tbody id="corpoTabelaPenalidades">
                                <!-- Será preenchido via JavaScript -->
                            </tbody>
                            <tfoot class="table-warning">
                                <tr>
                                    <td colspan="3" class="text-end fw-bold">
                                        <strong>Total Penalidades:</strong>
                                    </td>
                                    <td class="text-end fw-bold" id="totalPenalidades">
                                        R$ 0,00
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Máscara monetária no campo VR_TARIFA
document.getElementById('vr_tarifa').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    value = (value / 100).toFixed(2);
    value = value.replace('.', ',');
    value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    e.target.value = value;
});

// Buscar dados do contrato
document.getElementById('btnBuscarDados').addEventListener('click', function() {
    const contrato = document.getElementById('nu_contrato').value.trim();

    if (!contrato) {
        alert('Informe o número do contrato');
        return;
    }

    // Exibir loading
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Buscando...';

    fetch('{{ url_for("sumov.penalidade_ans_buscar_dados") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ contrato: contrato })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Exibir dados informativos
            let html = '';

            if (data.dt_entrada_estoque) {
                html += `<p class="mb-2"><strong><i class="fas fa-calendar text-primary me-1"></i> Data Entrada Estoque:</strong> ${data.dt_entrada_estoque}</p>`;
            }

            if (data.vr_venda) {
                html += `<p class="mb-2"><strong><i class="fas fa-dollar-sign text-success me-1"></i> Valor Venda:</strong> R$ ${data.vr_venda.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>`;
                if (data.dt_venda) {
                    html += `<p class="mb-2"><strong><i class="fas fa-calendar-check text-info me-1"></i> Data Venda:</strong> ${data.dt_venda}</p>`;
                }
            }

            if (data.vr_avaliacao) {
                html += `<p class="mb-2"><strong><i class="fas fa-file-invoice-dollar text-warning me-1"></i> Valor Avaliação:</strong> R$ ${data.vr_avaliacao.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>`;
                if (data.dt_laudo) {
                    html += `<p class="mb-0"><strong><i class="fas fa-file-alt text-secondary me-1"></i> Data Laudo:</strong> ${data.dt_laudo}</p>`;
                }
            }

            if (html) {
                document.getElementById('dadosContrato').innerHTML = html;
                document.getElementById('cardInfoContrato').style.display = 'block';
            }

            // Exibir cálculos de penalidades
            if (data.penalidades && data.penalidades.length > 0) {
                let htmlPenalidades = '';

                data.penalidades.forEach(function(p) {
                    htmlPenalidades += `
                        <tr style="font-size: 0.85rem;">
                            <td><small><strong>${p.nome_contrato}</strong></small></td>
                            <td class="text-center"><span class="badge bg-warning text-dark">${p.qtd_meses_atraso}</span></td>
                            <td class="text-end"><small>R$ ${p.vr_unitario_tarifa.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</small></td>
                            <td class="text-end"><strong class="text-danger"><small>R$ ${p.valor_penalidade.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</small></strong></td>
                        </tr>
                    `;
                });

                document.getElementById('corpoTabelaPenalidades').innerHTML = htmlPenalidades;
                document.getElementById('totalPenalidades').innerHTML = `<strong class="text-danger">R$ ${data.total_penalidades.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>`;
                document.getElementById('cardCalculoPenalidades').style.display = 'block';
            } else {
                document.getElementById('cardCalculoPenalidades').style.display = 'none';
            }

        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao buscar dados do contrato');
    })
    .finally(() => {
        // Restaurar botão
        document.getElementById('btnBuscarDados').disabled = false;
        document.getElementById('btnBuscarDados').innerHTML = '<i class="fas fa-search me-2"></i>Buscar Dados';
    });
});

// Validação de datas antes do submit
document.getElementById('formPenalidade').addEventListener('submit', function(e) {
    const dataInicio = new Date(document.getElementById('ini_vigencia').value);
    const dataFim = new Date(document.getElementById('fim_vigencia').value);

    if (dataFim <= dataInicio) {
        e.preventDefault();
        alert('A data de fim da vigência deve ser posterior à data de início.');
        return false;
    }
});
</script>
{% endblock %}