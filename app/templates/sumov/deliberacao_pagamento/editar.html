{% extends "base.html" %}

{% block content %}
<div class="container-fluid fade-in">
    <a href="{{ url_for('sumov.deliberacao_pagamento') }}" class="btn-back">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold header-with-back">
            <i class="fas fa-edit text-warning me-2"></i> Editar Deliberação - Contrato {{ deliberacao.NU_CONTRATO }}
        </h1>
        <button type="button"
                class="btn btn-success"
                onclick="baixarPDFDetalhado('{{ deliberacao.NU_CONTRATO }}', this)">
            <i class="fas fa-file-pdf me-2"></i>Baixar PDF
        </button>
    </div>

    <!-- Card do Formulário -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-gradient-warning text-white">
            <h5 class="mb-0">
                <i class="fas fa-edit me-2"></i>Dados da Deliberação
            </h5>
        </div>
        <div class="card-body p-4">
            <form method="POST" action="{{ url_for('sumov.deliberacao_pagamento_editar', contrato=deliberacao.NU_CONTRATO) }}">

                <!-- Campo Hidden: Contrato (NÃO EDITÁVEL) -->
                <input type="hidden" name="contrato" value="{{ deliberacao.NU_CONTRATO }}">

                <!-- ==== SEÇÃO 1: IDENTIFICAÇÃO ==== -->
                <div class="border-bottom pb-3 mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-id-card me-2"></i>Identificação
                    </h5>

                    <!-- Contrato/Imóvel (readonly - NÃO EDITÁVEL) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-file-contract text-primary me-1"></i>
                            Contrato/Imóvel (ID)
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               value="{{ deliberacao.NU_CONTRATO }}"
                               readonly>
                        <small class="text-muted">
                            <i class="fas fa-lock me-1"></i>
                            O número do contrato não pode ser alterado
                        </small>
                    </div>

                    <!-- Analista (readonly) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-user text-success me-1"></i>
                            Colaborador que Analisou
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               value="{{ deliberacao.COLABORADOR_ANALISOU or '-' }}"
                               readonly>
                        <small class="text-muted">
                            <i class="fas fa-database me-1"></i>Dado obtido automaticamente
                        </small>
                    </div>

                    <!-- Data da Análise (readonly) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-calendar text-info me-1"></i>
                            Data da Análise
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               value="{{ deliberacao.DT_ANALISE.strftime('%d/%m/%Y') if deliberacao.DT_ANALISE else '-' }}"
                               readonly>
                        <small class="text-muted">
                            <i class="fas fa-database me-1"></i>Dado obtido automaticamente
                        </small>
                    </div>

                    <!-- Matrícula (EDITÁVEL) -->
                    <div class="mb-3">
                        <label for="matricula" class="form-label fw-bold">
                            <i class="fas fa-id-badge text-secondary me-1"></i>
                            Matrícula (Caixa/Emgea)
                        </label>
                        <input type="text"
                               class="form-control"
                               id="matricula"
                               name="matricula"
                               value="{{ deliberacao.MATRICULA_CAIXA_EMGEA or '' }}"
                               placeholder="Ex: 18.133 - Emgea">
                        <small class="text-success">
                            <i class="fas fa-edit me-1"></i>Campo editável
                        </small>
                    </div>

                    <!-- Data de Arrematação (EDITÁVEL) -->
                    <div class="mb-3">
                        <label for="dt_arrematacao" class="form-label fw-bold">
                            <i class="fas fa-calendar-plus text-warning me-1"></i>
                            Data da Arrematação/Aquisição (RM)
                        </label>
                        <input type="date"
                               class="form-control"
                               id="dt_arrematacao"
                               name="dt_arrematacao"
                               value="{{ deliberacao.DT_ARREMATACAO_AQUISICAO.strftime('%Y-%m-%d') if deliberacao.DT_ARREMATACAO_AQUISICAO else '' }}">
                        <small class="text-success">
                            <i class="fas fa-edit me-1"></i>Campo editável
                        </small>
                    </div>

                    <!-- Data de Entrada no Estoque (readonly) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-warehouse text-primary me-1"></i>
                            Data de Entrada no Estoque
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               value="{{ deliberacao.DT_ENTRADA_ESTOQUE.strftime('%d/%m/%Y') if deliberacao.DT_ENTRADA_ESTOQUE else '-' }}"
                               readonly>
                        <small class="text-muted">
                            <i class="fas fa-database me-1"></i>Dado obtido automaticamente do sistema
                        </small>
                    </div>
                </div>

                <!-- ==== SEÇÃO 2: COBRANÇA E DÍVIDA ==== -->
                <div class="border-bottom pb-3 mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-file-invoice-dollar me-2"></i>Cobrança e Dívida
                    </h5>

                    <!-- Período Prescrito (readonly) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-clock text-danger me-1"></i>
                            Período Prescrito
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               value="{{ deliberacao.PERIODO_PRESCRITO or '-' }}"
                               readonly>
                        <small class="text-muted">
                            <i class="fas fa-database me-1"></i>Dado obtido automaticamente do SISCalculo
                        </small>
                    </div>

                    <!-- Período da Cobrança (readonly) -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-calendar-alt text-info me-1"></i>
                                Período Cobrança - Início
                            </label>
                            <input type="text"
                                   class="form-control bg-light"
                                   value="{{ deliberacao.DT_PERIODO_COBRANCA_INICIO.strftime('%d/%m/%Y') if deliberacao.DT_PERIODO_COBRANCA_INICIO else '-' }}"
                                   readonly>
                            <small class="text-muted">
                                <i class="fas fa-database me-1"></i>Dado obtido automaticamente do SISCalculo
                            </small>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-calendar-alt text-info me-1"></i>
                                Período Cobrança - Fim
                            </label>
                            <input type="text"
                                   class="form-control bg-light"
                                   value="{{ deliberacao.DT_PERIODO_COBRANCA_FIM.strftime('%d/%m/%Y') if deliberacao.DT_PERIODO_COBRANCA_FIM else '-' }}"
                                   readonly>
                            <small class="text-muted">
                                <i class="fas fa-database me-1"></i>Dado obtido automaticamente do SISCalculo
                            </small>
                        </div>
                    </div>

                    <!-- Campos Hidden para período de cobrança -->
                    <input type="hidden" name="dt_periodo_cobranca_inicio" value="{{ deliberacao.DT_PERIODO_COBRANCA_INICIO.strftime('%Y-%m-%d') if deliberacao.DT_PERIODO_COBRANCA_INICIO else '' }}">
                    <input type="hidden" name="dt_periodo_cobranca_fim" value="{{ deliberacao.DT_PERIODO_COBRANCA_FIM.strftime('%Y-%m-%d') if deliberacao.DT_PERIODO_COBRANCA_FIM else '' }}">

                    <!-- Valor da Dívida Cobrada (readonly) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-dollar-sign text-warning me-1"></i>
                            Valor da Dívida Cobrada pelo Condomínio (SISCalculo)
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               value="{{ 'R$ {:,.2f}'.format(deliberacao.VR_DIVIDA_CONDOMINIO_1).replace(',', 'X').replace('.', ',').replace('X', '.') if deliberacao.VR_DIVIDA_CONDOMINIO_1 else 'R$ 0,00' }}"
                               readonly>
                        <small class="text-muted">
                            <i class="fas fa-database me-1"></i>Dado obtido automaticamente do SISCalculo
                        </small>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-12">
                            <label for="indice_usado_condominio" class="form-label fw-bold">
                                <i class="fas fa-percent text-info me-1"></i>
                                Índice Usado pelo Condomínio
                            </label>
                            <input type="text"
                                   class="form-control"
                                   id="indice_usado_condominio"
                                   name="indice_usado_condominio"
                                   maxlength="5"
                                   value="{{ deliberacao.INDICE_USADO_CONDOMINIO or '' }}"
                                   placeholder="Ex: IGPM, IPCA, INPC">
                            <small class="text-success">
                                <i class="fas fa-edit me-1"></i>Campo editável (opcional - máximo 5 caracteres)
                            </small>
                        </div>
                    </div>


                    <!-- Valor da Dívida Manual (EDITÁVEL) -->
                    <div class="mb-3">
                        <label for="vr_divida_condominio_2" class="form-label fw-bold">
                            <i class="fas fa-edit text-secondary me-1"></i>
                            Valor da Dívida (Manual)
                        </label>
                        <input type="text"
                               class="form-control"
                               id="vr_divida_condominio_2"
                               name="vr_divida_condominio_2"
                               value="{{ 'R$ {:,.2f}'.format(deliberacao.VR_DIVIDA_CONDOMINIO_2).replace(',', 'X').replace('.', ',').replace('X', '.') if deliberacao.VR_DIVIDA_CONDOMINIO_2 else '' }}"
                               placeholder="R$ 0,00">
                        <small class="text-success">
                            <i class="fas fa-edit me-1"></i>Campo editável - deixe em branco para usar o valor automático
                        </small>
                    </div>

                    <!-- Valor Excluído (readonly) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-ban text-danger me-1"></i>
                            Valor do Débito Excluído (Parcelas Prescritas)
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               value="{{ 'R$ {:,.2f}'.format(deliberacao.VR_DEBITO_EXCLUIDO_PRESCRITAS).replace(',', 'X').replace('.', ',').replace('X', '.') if deliberacao.VR_DEBITO_EXCLUIDO_PRESCRITAS else 'R$ 0,00' }}"
                               readonly>
                        <small class="text-muted">
                            <i class="fas fa-database me-1"></i>Valor calculado automaticamente
                        </small>
                    </div>
                </div>

                <!-- ==== SEÇÃO 3: CÁLCULO EMGEA ==== -->
                <div class="border-bottom pb-3 mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-calculator me-2"></i>Cálculo da EMGEA
                    </h5>

                    <!-- Índice Econômico (readonly) -->
                    <div class="mb-3">
                        <label for="indice_economico" class="form-label fw-bold">
                            <i class="fas fa-chart-line text-primary me-1"></i>
                            Índice Econômico Utilizado
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               id="indice_economico_display"
                               value="{{ deliberacao.INDICE_DEBITO_EMGEA or '-' }}"
                               readonly>
                        <input type="hidden" name="indice_economico" value="{{ deliberacao.INDICE_DEBITO_EMGEA or '' }}">
                        <small class="text-warning">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            Para alterar o índice econômico, é necessário criar uma nova deliberação
                        </small>
                    </div>

                    <!-- Valor Calculado (readonly) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-money-bill-wave text-success me-1"></i>
                            Valor do Débito Calculado pela EMGEA
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               value="{{ 'R$ {:,.2f}'.format(deliberacao.VR_DEBITO_CALCULADO_EMGEA).replace(',', 'X').replace('.', ',').replace('X', '.') if deliberacao.VR_DEBITO_CALCULADO_EMGEA else 'R$ 0,00' }}"
                               readonly>
                        <small class="text-muted">
                            <i class="fas fa-database me-1"></i>Valor calculado automaticamente
                        </small>
                    </div>

                    <!-- Percentual de Honorários (readonly) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-percent text-info me-1"></i>
                            Percentual de Honorários da EMGEA
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               value="{{ '{:,.2f}%'.format(deliberacao.PERC_HONORARIOS_EMGEA).replace(',', 'X').replace('.', ',').replace('X', '.') if deliberacao.PERC_HONORARIOS_EMGEA else '0,00%' }}"
                               readonly>
                        <small class="text-muted">
                            <i class="fas fa-database me-1"></i>Percentual calculado automaticamente (10% ou 20%)
                        </small>
                    </div>

                    <!-- Valor dos Honorários (readonly) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-gavel text-warning me-1"></i>
                            Valor dos Honorários
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               value="{{ 'R$ {:,.2f}'.format(deliberacao.VR_HONORARIOS_EMGEA).replace(',', 'X').replace('.', ',').replace('X', '.') if deliberacao.VR_HONORARIOS_EMGEA else 'R$ 0,00' }}"
                               readonly>
                        <small class="text-muted">
                            <i class="fas fa-database me-1"></i>Valor calculado automaticamente
                        </small>
                    </div>

                    <!-- Data do Registro (EDITÁVEL) -->
                    <div class="mb-3">
                        <label for="dt_registro" class="form-label fw-bold">
                            <i class="fas fa-calendar-check text-secondary me-1"></i>
                            Data do Registro
                        </label>
                        <input type="date"
                               class="form-control"
                               id="dt_registro"
                               name="dt_registro"
                               value="{{ deliberacao.DT_REGISTRO.strftime('%Y-%m-%d') if deliberacao.DT_REGISTRO else '' }}">
                        <small class="text-success">
                            <i class="fas fa-edit me-1"></i>Campo editável (obrigatório)
                        </small>
                    </div>

                    <!-- ✅ RESUMO POR TIPO DE PARCELA - TABELA BEM FORMATADA -->
                    {% if totais_por_tipo and totais_por_tipo|length > 0 %}
                    <div class="card border-primary shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-pie me-2"></i>Resumo por Tipo de Parcela
                            </h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="text-center" style="width: 10%;">ID</th>
                                            <th style="width: 50%;">
                                                <i class="fas fa-tag me-1"></i>Tipo de Parcela
                                            </th>
                                            <th class="text-center" style="width: 15%;">
                                                <i class="fas fa-list-ol me-1"></i>Quantidade
                                            </th>
                                            <th class="text-end" style="width: 25%;">
                                                <i class="fas fa-dollar-sign me-1"></i>Valor Total
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for tipo in totais_por_tipo %}
                                        <tr>
                                            <td class="text-center">
                                                <span class="badge bg-secondary">{{ tipo.id_tipo }}</span>
                                            </td>
                                            <td><strong>{{ tipo.descricao }}</strong></td>
                                            <td class="text-center fw-bold">{{ tipo.quantidade }}</td>
                                            <td class="text-end fw-bold text-success">
                                                R$ {{ '{:,.2f}'.format(tipo.valor_total).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="table-active">
                                        <tr class="fw-bold">
                                            <td colspan="2" class="text-end">TOTAL GERAL:</td>
                                            <td class="text-center text-primary">
                                                {{ totais_por_tipo|sum(attribute='quantidade') }}
                                            </td>
                                            <td class="text-end text-primary">
                                                R$ {{ '{:,.2f}'.format(totais_por_tipo|sum(attribute='valor_total')).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- ==== SEÇÃO 4: AVALIAÇÃO E VENDA ==== -->
                <div class="border-bottom pb-3 mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-home me-2"></i>Avaliação e Venda do Imóvel
                    </h5>

                    <!-- Valor da Avaliação (readonly) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-file-invoice text-primary me-1"></i>
                            Valor da Avaliação
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               value="{{ 'R$ {:,.2f}'.format(deliberacao.VR_AVALIACAO).replace(',', 'X').replace('.', ',').replace('X', '.') if deliberacao.VR_AVALIACAO else 'R$ 0,00' }}"
                               readonly>
                        <small class="text-muted">
                            <i class="fas fa-database me-1"></i>Dado obtido automaticamente da tabela de avaliações
                        </small>
                    </div>

                    <!-- Data do Laudo (readonly) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-calendar text-info me-1"></i>
                            Data do Laudo de Avaliação
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               value="{{ deliberacao.DT_LAUDO.strftime('%d/%m/%Y') if deliberacao.DT_LAUDO else '-' }}"
                               readonly>
                        <small class="text-muted">
                            <i class="fas fa-database me-1"></i>Dado obtido automaticamente da tabela de avaliações
                        </small>
                    </div>

                    <!-- Status do Imóvel (readonly) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-info-circle text-secondary me-1"></i>
                            Status do Imóvel
                        </label>
                        <div class="form-control bg-light">
                            {% if deliberacao.STATUS_IMOVEL == 'VENDIDO' %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle me-1"></i>Vendido
                                </span>
                            {% elif deliberacao.STATUS_IMOVEL == 'ESTOQUE' %}
                                <span class="badge bg-warning text-dark">
                                    <i class="fas fa-warehouse me-1"></i>Em Estoque
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">{{ deliberacao.STATUS_IMOVEL or '-' }}</span>
                            {% endif %}
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-database me-1"></i>Dado obtido automaticamente do RM Totvs
                        </small>
                    </div>

                    <!-- Campo Hidden para tipo_pagamento_venda -->
                    <input type="hidden" name="tipo_pagamento_venda" value="{{ deliberacao.TIPO_PAGAMENTO_VENDA or '' }}">

                    {% if deliberacao.STATUS_IMOVEL == 'VENDIDO' %}
                    <!-- Dados da Venda (readonly) -->
                    <div class="card bg-light border-success mb-3">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-handshake me-2"></i>Dados da Venda
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Valor da venda (readonly) -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-dollar-sign text-success me-1"></i>
                                    Valor da Venda
                                </label>
                                <input type="text"
                                       class="form-control bg-white"
                                       value="{{ 'R$ {:,.2f}'.format(deliberacao.VR_VENDA).replace(',', 'X').replace('.', ',').replace('X', '.') if deliberacao.VR_VENDA else 'R$ 0,00' }}"
                                       readonly>
                                <small class="text-muted">
                                    <i class="fas fa-database me-1"></i>Dado obtido automaticamente da tabela de vendas
                                </small>
                            </div>

                            <!-- Data da venda (readonly) -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-calendar-check text-success me-1"></i>
                                    Data da Venda
                                </label>
                                <input type="text"
                                       class="form-control bg-white"
                                       value="{{ deliberacao.DT_VENDA.strftime('%d/%m/%Y') if deliberacao.DT_VENDA else '-' }}"
                                       readonly>
                                <small class="text-muted">
                                    <i class="fas fa-database me-1"></i>Dado obtido automaticamente da tabela de vendas
                                </small>
                            </div>

                            <!-- Nome do Comprador (readonly) -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-user-check text-primary me-1"></i>
                                    Nome do Adquirente
                                </label>
                                <input type="text"
                                       class="form-control bg-white"
                                       value="{{ deliberacao.NOME_COMPRADOR or '-' }}"
                                       readonly>
                                <small class="text-muted">
                                    <i class="fas fa-database me-1"></i>Dado obtido automaticamente da tabela de vendas
                                </small>
                            </div>

                            <!-- Tipo de Pagamento da Venda (readonly) -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-credit-card text-info me-1"></i>
                                    Tipo de Pagamento
                                </label>
                                <div class="form-control bg-white">
                                    {% if deliberacao.TIPO_PAGAMENTO_VENDA == 'A_VISTA' %}
                                        <i class="fas fa-money-bill-wave text-success me-2"></i>
                                        <span class="badge bg-success">À Vista</span>
                                    {% elif deliberacao.TIPO_PAGAMENTO_VENDA == 'PARCELADO' %}
                                        <i class="fas fa-calendar-alt text-warning me-2"></i>
                                        <span class="badge bg-warning text-dark">Parcelado</span>
                                    {% else %}
                                        {{ deliberacao.TIPO_PAGAMENTO_VENDA or '-' }}
                                    {% endif %}
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-database me-1"></i>Detectado automaticamente (À Vista se VR_SD_DEVEDOR = 0, Parcelado se > 0)
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Gravame na Matrícula (EDITÁVEL) -->
                    <div class="mb-3">
                        <label for="gravame_matricula" class="form-label fw-bold">
                            <i class="fas fa-bookmark text-danger me-1"></i>
                            Gravame na Matrícula
                        </label>
                        <textarea class="form-control"
                                  id="gravame_matricula"
                                  name="gravame_matricula"
                                  rows="3"
                                  placeholder="Descreva o gravame na matrícula do imóvel">{{ deliberacao.GRAVAME_MATRICULA or '' }}</textarea>
                        <small class="text-success">
                            <i class="fas fa-edit me-1"></i>Campo editável
                        </small>
                    </div>

                    <!-- Ações Negociais Administrativas (EDITÁVEL) -->
                    <div class="mb-3">
                        <label for="acoes_negociais_administrativas" class="form-label fw-bold">
                            <i class="fas fa-clipboard-list text-primary me-1"></i>
                            Ações Negociais Administrativas
                        </label>
                        <textarea class="form-control"
                                  id="acoes_negociais_administrativas"
                                  name="acoes_negociais_administrativas"
                                  rows="3"
                                  placeholder="Descreva as ações negociais administrativas">{{ deliberacao.ACOES_NEGOCIAIS_ADMINISTRATIVAS or '' }}</textarea>
                        <small class="text-success">
                            <i class="fas fa-edit me-1"></i>Campo editável
                        </small>
                    </div>

                    <!-- Processos judiciais (readonly - vem do banco) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-gavel text-warning me-1"></i>
                            Situação Judicial - Ações Negociais Judiciais
                        </label>
                        <textarea class="form-control bg-light"
                                  rows="3"
                                  readonly>{{ deliberacao.NR_PROCESSOS_JUDICIAIS or '-' }}</textarea>
                        <small class="text-muted">
                            <i class="fas fa-database me-1"></i>Dado obtido automaticamente do SISJUD
                        </small>
                    </div>

                    <!-- Campos Hidden para processos -->
                    <input type="hidden" name="nr_processos_judiciais" value="{{ deliberacao.NR_PROCESSOS_JUDICIAIS or '' }}">

                    <!-- Vara do processo (readonly - vem do banco) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-landmark text-primary me-1"></i>
                            Vara do Processo
                        </label>
                        <textarea class="form-control bg-light"
                                  rows="3"
                                  readonly>{{ deliberacao.VARA_PROCESSO or '-' }}</textarea>
                        <small class="text-muted">
                            <i class="fas fa-database me-1"></i>Dado obtido automaticamente do SISJUD
                        </small>
                    </div>

                    <!-- Campos Hidden para vara -->
                    <input type="hidden" name="vara_processo" value="{{ deliberacao.VARA_PROCESSO or '' }}">

                    <!-- Fase do processo (readonly - vem do banco) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-tasks text-info me-1"></i>
                            Fase do Processo
                        </label>
                        <textarea class="form-control bg-light"
                                  rows="3"
                                  readonly>{{ deliberacao.FASE_PROCESSO or '-' }}</textarea>
                        <small class="text-muted">
                            <i class="fas fa-database me-1"></i>Dado obtido automaticamente do SISJUD
                        </small>
                    </div>

                    <!-- Campos Hidden para fase -->
                    <input type="hidden" name="fase_processo" value="{{ deliberacao.FASE_PROCESSO or '' }}">

                    <!-- Relatório da assessoria jurídica (EDITÁVEL) -->
                    <div class="mb-3">
                        <label for="relatorio_assessoria_juridica" class="form-label fw-bold">
                            <i class="fas fa-file-alt text-secondary me-1"></i>
                            Relatório da Assessoria Jurídica
                        </label>
                        <textarea class="form-control"
                                  id="relatorio_assessoria_juridica"
                                  name="relatorio_assessoria_juridica"
                                  rows="4"
                                  placeholder="Digite o relatório da assessoria jurídica">{{ deliberacao.RELATORIO_ASSESSORIA_JURIDICA or '' }}</textarea>
                        <small class="text-success">
                            <i class="fas fa-edit me-1"></i>Campo editável
                        </small>
                    </div>
                </div>

                <!-- ==== SEÇÃO 5: DÉBITOS PAGOS ==== -->
                <div class="border-bottom pb-3 mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-receipt me-2"></i>Demais Débitos Pagos pela EMGEA
                    </h5>

                    <!-- Card com totais -->
                    <div class="card bg-light border-secondary mb-3">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-calculator me-2"></i>Resumo de Débitos Pagos
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- SISDEX -->
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-wrench text-primary me-1"></i>
                                        SISDEX
                                    </label>
                                    <input type="text"
                                           class="form-control bg-white"
                                           value="{{ 'R$ {:,.2f}'.format(deliberacao.VR_DEBITOS_SISDEX).replace(',', 'X').replace('.', ',').replace('X', '.') if deliberacao.VR_DEBITOS_SISDEX else 'R$ 0,00' }}"
                                           readonly>
                                    <small class="text-muted">
                                        <i class="fas fa-database me-1"></i>Dado obtido automaticamente do SISDEX
                                    </small>
                                </div>

                                <!-- SISGEA -->
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-building text-success me-1"></i>
                                        SISGEA
                                    </label>
                                    <input type="text"
                                           class="form-control bg-white"
                                           value="{{ 'R$ {:,.2f}'.format(deliberacao.VR_DEBITOS_SISGEA).replace(',', 'X').replace('.', ',').replace('X', '.') if deliberacao.VR_DEBITOS_SISGEA else 'R$ 0,00' }}"
                                           readonly>
                                    <small class="text-muted">
                                        <i class="fas fa-database me-1"></i>Dado obtido automaticamente do SISGEA
                                    </small>
                                </div>

                                <div class="col-md-3 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-gavel text-info me-1"></i>
                                        SISINC
                                    </label>
                                    <input type="text"
                                           class="form-control bg-white"
                                           value="{{ 'R$ {:,.2f}'.format(deliberacao.VR_DEBITOS_SISINC).replace(',', 'X').replace('.', ',').replace('X', '.') if deliberacao.VR_DEBITOS_SISINC else 'R$ 0,00' }}"
                                           readonly>
                                    <small class="text-muted">
                                        <i class="fas fa-database me-1"></i>Dado obtido automaticamente do SISINC
                                    </small>
                                </div>

                                <!-- TOTAL -->
                                <div class="col-md-3 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-calculator text-danger me-1"></i>
                                        Total
                                    </label>
                                    <input type="text"
                                           class="form-control bg-white border-danger fw-bold"
                                           value="{{ 'R$ {:,.2f}'.format(deliberacao.VR_DEBITOS_TOTAL).replace(',', 'X').replace('.', ',').replace('X', '.') if deliberacao.VR_DEBITOS_TOTAL else 'R$ 0,00' }}"
                                           readonly>
                                    <small class="text-muted">
                                        <i class="fas fa-calculator me-1"></i>Soma automática (SISDEX + SISGEA + SISINC)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Penalidade ANS/Caixa (EDITÁVEL) -->
                    <div class="mb-3">
                        <label for="penalidade_ans_caixa" class="form-label fw-bold">
                            <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                            Penalidade ANS Caixa
                        </label>
                        <textarea class="form-control"
                                  id="penalidade_ans_caixa"
                                  name="penalidade_ans_caixa"
                                  rows="3"
                                  placeholder="Descreva as penalidades ANS Caixa">{{ deliberacao.PENALIDADE_ANS_CAIXA or '' }}</textarea>
                        <small class="text-success">
                            <i class="fas fa-edit me-1"></i>Campo editável
                        </small>
                    </div>

                    <!-- Prejuízo Financeiro (EDITÁVEL) -->
                    <div class="mb-3">
                        <label for="prejuizo_financeiro_caixa" class="form-label fw-bold">
                            <i class="fas fa-chart-line text-danger me-1"></i>
                            Prejuízo Financeiro Caixa
                        </label>
                        <textarea class="form-control"
                                  id="prejuizo_financeiro_caixa"
                                  name="prejuizo_financeiro_caixa"
                                  rows="3"
                                  placeholder="Descreva o prejuízo financeiro Caixa">{{ deliberacao.PREJUIZO_FINANCEIRO_CAIXA or '' }}</textarea>
                        <small class="text-success">
                            <i class="fas fa-edit me-1"></i>Campo editável
                        </small>
                    </div>
                </div>

                <!-- ==== SEÇÃO 6: CONSIDERAÇÕES FINAIS ==== -->
                <div class="mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-comments me-2"></i>Considerações Finais
                    </h5>

                    <!-- Considerações do Analista (EDITÁVEL) -->
                    <div class="mb-3">
                        <label for="consideracoes_analista" class="form-label fw-bold">
                            <i class="fas fa-user-edit text-info me-1"></i>
                            Considerações do Analista GEADI
                        </label>
                        <textarea class="form-control"
                                  id="consideracoes_analista"
                                  name="consideracoes_analista"
                                  rows="5"
                                  placeholder="Digite as considerações do analista GEADI">{{ deliberacao.CONSIDERACOES_ANALISTA_GEADI or '' }}</textarea>
                        <small class="text-success">
                            <i class="fas fa-edit me-1"></i>Campo editável
                        </small>
                    </div>

                    <!-- Considerações do Gestor GEADI (EDITÁVEL) -->
                    <div class="mb-3">
                        <label for="consideracoes_gestor" class="form-label fw-bold">
                            <i class="fas fa-user-tie text-primary me-1"></i>
                            Considerações do Gestor GEADI
                        </label>
                        <textarea class="form-control"
                                  id="consideracoes_gestor"
                                  name="consideracoes_gestor"
                                  rows="5"
                                  placeholder="Digite as considerações do gestor GEADI">{{ deliberacao.CONSIDERACOES_GESTOR_GEADI or '' }}</textarea>
                        <small class="text-success">
                            <i class="fas fa-edit me-1"></i>Campo editável
                        </small>
                    </div>

                    <!-- Considerações do Gestor SUMOV (EDITÁVEL) -->
                    <div class="mb-3">
                        <label for="consideracoes_gestor_sumov" class="form-label fw-bold">
                            <i class="fas fa-user-tie text-warning me-1"></i>
                            Considerações Finais do Gestor da SUMOV
                        </label>
                        <textarea class="form-control"
                                  id="consideracoes_gestor_sumov"
                                  name="consideracoes_gestor_sumov"
                                  rows="5"
                                  placeholder="Digite as considerações finais do gestor SUMOV">{{ deliberacao.CONSIDERACOES_GESTOR_SUMOV or '' }}</textarea>
                        <small class="text-success">
                            <i class="fas fa-edit me-1"></i>Campo editável
                        </small>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <a href="{{ url_for('sumov.deliberacao_pagamento') }}" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save me-2"></i>Salvar Alterações
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
// Função para baixar PDF com feedback visual
function baixarPDFDetalhado(contrato, botao) {
    const conteudoOriginal = botao.innerHTML;

    botao.disabled = true;
    botao.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Gerando PDF...';

    const link = document.createElement('a');
    link.href = `/sumov/deliberacao-pagamento/pdf/${contrato}`;
    link.download = `Deliberacao_Pagamento_${contrato}.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    setTimeout(() => {
        botao.disabled = false;
        botao.innerHTML = conteudoOriginal;
    }, 3000);
}

// Máscara de moeda para o campo de valor manual
document.addEventListener('DOMContentLoaded', function() {
    const campoValor = document.getElementById('vr_divida_condominio_2');

    if (campoValor) {
        campoValor.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');

            if (value === '') {
                e.target.value = '';
                return;
            }

            value = parseInt(value, 10);
            const valorFormatado = (value / 100).toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });

            e.target.value = 'R$ ' + valorFormatado;
        });

        // Permitir que o campo seja limpo
        campoValor.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && e.target.value === 'R$ 0,00') {
                e.target.value = '';
            }
        });
    }
});
</script>
{% endblock %}