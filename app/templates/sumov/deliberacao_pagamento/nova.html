{% extends "base.html" %}

{% block content %}
<div class="container-fluid fade-in">
    <a href="{{ url_for('sumov.deliberacao_pagamento') }}" class="btn-back">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold header-with-back">
            <i class="fas fa-gavel text-warning me-2"></i> Nova Deliberação de Pagamento
        </h1>
        <a href="{{ url_for('sumov.deliberacao_pagamento') }}" class="btn btn-info">
            <i class="fas fa-list me-2"></i>Ver Deliberações Salvas
        </a>
    </div>

    <!-- Card do Formulário -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-gradient-warning text-white">
            <h5 class="mb-0">
                <i class="fas fa-edit me-2"></i>Dados da Deliberação - GEADI
            </h5>
        </div>
        <div class="card-body p-4">
            <form method="POST" action="{{ url_for('sumov.deliberacao_pagamento_nova') }}" id="formDeliberacao">

                <!-- ==== SEÇÃO 1: IDENTIFICAÇÃO ==== -->
                <div class="border-bottom pb-3 mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-id-card me-2"></i>Identificação
                    </h5>

                    <!-- Contrato/Imóvel -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="contrato" class="form-label fw-bold">
                                <i class="fas fa-file-contract text-primary me-1"></i>
                                Contrato/Imóvel (ID) <span class="text-danger">*</span>
                            </label>
                            <input type="text"
                                   class="form-control"
                                   id="contrato"
                                   name="contrato"
                                   placeholder="Digite o número do contrato"
                                   required>
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button"
                                    class="btn btn-primary w-100"
                                    id="btnBuscar">
                                <i class="fas fa-search me-2"></i>Buscar Dados
                            </button>
                        </div>
                    </div>

                    <div id="loadingBusca" class="text-center mb-3" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Buscando...</span>
                        </div>
                        <p class="text-muted mt-2">Buscando dados do contrato...</p>
                    </div>

                    <!-- Analista (readonly) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-user text-success me-1"></i>
                            Colaborador que Analisou
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               value="{{ current_user.nome }}"
                               readonly>
                    </div>

                    <!-- Data da Análise (readonly) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-calendar text-info me-1"></i>
                            Data da Análise
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               value=""
                               id="dt_analise_display"
                               readonly>
                    </div>

                    <!-- Matrícula (manual) -->
                    <div class="mb-3">
                        <label for="matricula" class="form-label fw-bold">
                            <i class="fas fa-id-badge text-secondary me-1"></i>
                            Matrícula (Caixa/Emgea)
                        </label>
                        <input type="text"
                               class="form-control"
                               id="matricula"
                               name="matricula"
                               placeholder="Ex: 18.133 - Emgea">
                    </div>

                    <!-- Data de Arrematação (manual) -->
                    <div class="mb-3">
                        <label for="dt_arrematacao" class="form-label fw-bold">
                            <i class="fas fa-calendar-plus text-warning me-1"></i>
                            Data da Arrematação/Aquisição (RM)
                        </label>
                        <input type="date"
                               class="form-control"
                               id="dt_arrematacao"
                               name="dt_arrematacao">
                    </div>

                    <!-- Data de Entrada no Estoque (automático) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-warehouse text-primary me-1"></i>
                            Data de Entrada no Estoque
                        </label>
                        <input type="date"
                               class="form-control bg-light"
                               id="dt_entrada_estoque"
                               name="dt_entrada_estoque"
                               readonly>
                        <small class="text-muted">
                            <span id="msgEstoque">Será preenchido automaticamente após buscar o contrato</span>
                        </small>
                    </div>
                </div>

                <!-- ==== SEÇÃO 2: COBRANÇA E DÍVIDA ==== -->
                <div class="border-bottom pb-3 mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-file-invoice-dollar me-2"></i>Cobrança e Dívida
                    </h5>

                    <!-- Período Prescrito (automático) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-clock text-danger me-1"></i>
                            Período Prescrito
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               id="periodo_prescricao"
                               name="periodo_prescricao"
                               readonly>
                        <small class="text-muted">
                            <span id="msgPrescricao">Será preenchido automaticamente após buscar o contrato</span>
                        </small>
                    </div>

                    <!-- NOVO: Período da Cobrança dos Débitos -->
                    <div class="card bg-light border-info mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-calendar-alt me-2"></i>Período da Cobrança dos Débitos
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Data Início -->
                                <div class="col-md-6 mb-3">
                                    <label for="dt_periodo_cobranca_inicio" class="form-label fw-bold">
                                        <i class="fas fa-calendar-plus text-success me-1"></i>
                                        Data Início do Período
                                    </label>
                                    <input type="date"
                                           class="form-control"
                                           id="dt_periodo_cobranca_inicio"
                                           name="dt_periodo_cobranca_inicio">
                                    <small class="text-muted">
                                        <span id="msgPeriodoInicio">Aguardando busca do contrato</span>
                                    </small>
                                </div>

                                <!-- Data Fim -->
                                <div class="col-md-6 mb-3">
                                    <label for="dt_periodo_cobranca_fim" class="form-label fw-bold">
                                        <i class="fas fa-calendar-check text-danger me-1"></i>
                                        Data Fim do Período
                                    </label>
                                    <input type="date"
                                           class="form-control"
                                           id="dt_periodo_cobranca_fim"
                                           name="dt_periodo_cobranca_fim">
                                    <small class="text-muted">
                                        <span id="msgPeriodoFim">Aguardando busca do contrato</span>
                                    </small>
                                </div>

                                <!-- Alerta de informação -->
                                <div class="col-md-12">
                                    <div class="alert alert-info mb-0" id="alertPeriodoAutomatico" style="display: none;">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Detectado automaticamente:</strong> As datas foram preenchidas com base nos dados do SISCalculo. Você pode alterá-las manualmente se necessário.
                                    </div>
                                    <div class="alert alert-warning mb-0" id="alertPeriodoManual" style="display: none;">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Atenção:</strong> Este contrato não possui dados no SISCalculo. Por favor, preencha manualmente o período de cobrança dos débitos.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Valor Inicial da Dívida (automático) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-dollar-sign text-info me-1"></i>
                            Valor Inicial da Dívida (Soma das Cotas)
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               id="vr_divida_inicial"
                               name="vr_divida_inicial"
                               readonly>
                        <small class="text-muted">
                            <span id="msgValorInicial">Soma de todas as cotas do SISCalculo</span>
                        </small>
                    </div>

                    <!-- NOVO: Valor da Dívida (Manual) -->
                    <div class="mb-3">
                        <label for="vr_divida_condominio_2" class="form-label fw-bold">
                            <i class="fas fa-edit text-warning me-1"></i>
                            demais encargos (Manual)
                        </label>
                        <input type="text"
                               class="form-control"
                               id="vr_divida_condominio_2"
                               name="vr_divida_condominio_2"
                               placeholder="R$ 0,00">
                        <small class="text-muted">
                            Campo opcional para inserir valor manualmente (se houver valor diferente do calculado)
                        </small>
                    </div>

                    <!-- Valor de débito excluídos as cotas prescritas -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-minus-circle text-danger me-1"></i>
                            Valor de Débito Excluídos as Cotas Prescritas
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               id="vr_debito_excluido_prescritas"
                               name="vr_debito_excluido_prescritas"
                               readonly>
                        <small class="text-muted">
                            <span id="msgDebitoExcluido">Será calculado automaticamente</span>
                        </small>
                    </div>

                    <!-- Seleção do Índice Econômico -->
                    <div class="mb-3" id="divIndices" style="display: none;">
                        <label for="indice_economico" class="form-label fw-bold">
                            <i class="fas fa-chart-line text-primary me-1"></i>
                            Índice Econômico <span class="text-danger">*</span>
                        </label>
                        <select class="form-select"
                                id="indice_economico"
                                name="indice_economico"
                                required>
                            <option value="">Selecione o índice...</option>
                        </select>
                        <small class="text-muted">
                            Selecione o índice econômico para o cálculo
                        </small>
                    </div>

                    <!-- CARD COM DETALHES DO CÁLCULO (aparece após selecionar índice) -->
                    <div id="divDetalhesCalculo" class="card bg-light border-primary mb-3" style="display: none;">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-calculator me-2"></i>Detalhes do Cálculo - <span id="nomeIndiceDetalhes"></span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Valor SEM Honorários -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold text-secondary">
                                        <i class="fas fa-file-invoice me-1"></i>
                                        Valor da Dívida (sem Honorários)
                                    </label>
                                    <input type="text"
                                           class="form-control bg-white"
                                           id="vr_divida_sem_honorarios"
                                           readonly>
                                </div>

                                <!-- Percentual de Honorários -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold text-secondary">
                                        <i class="fas fa-percent me-1"></i>
                                        Percentual de Honorários
                                    </label>
                                    <input type="text"
                                           class="form-control bg-white"
                                           id="perc_honorarios_display"
                                           readonly>
                                </div>

                                <!-- Valor dos Honorários -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold text-warning">
                                        <i class="fas fa-gavel me-1"></i>
                                        Valor dos Honorários
                                    </label>
                                    <input type="text"
                                           class="form-control bg-white border-warning"
                                           id="vr_honorarios_display"
                                           readonly>
                                </div>

                                <!-- Valor TOTAL COM Honorários -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold text-success">
                                        <i class="fas fa-money-bill-wave me-1"></i>
                                        VALOR TOTAL (com Honorários)
                                    </label>
                                    <input type="text"
                                           class="form-control bg-white border-success fw-bold"
                                           id="vr_total_com_honorarios_display"
                                           readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                        <!-- ✅ NOVO: CARD COM RESUMO POR TIPO DE PARCELA -->
                    <div id="divTiposParcela" class="card shadow-sm mb-3" style="display: none;">
                        <div class="card-header bg-success text-white py-2">
                            <h6 class="mb-0">
                                <i class="fas fa-chart-pie me-2"></i>Resumo por Tipo de Parcela - <span id="nomeIndiceTipos"></span>
                            </h6>
                        </div>
                        <div class="card-body py-3">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered table-hover mb-0" id="tabelaTiposParcela">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="text-center" style="width: 15%;">ID Tipo</th>
                                            <th style="width: 35%;">Descrição do Tipo</th>
                                            <th class="text-center" style="width: 20%;">Quantidade</th>
                                            <th class="text-end" style="width: 30%;">Valor Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="corpoTabelaTiposParcela">
                                        <!-- Será preenchido dinamicamente -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-info">
                                            <th colspan="2" class="text-end">TOTAL GERAL:</th>
                                            <th class="text-center" id="totalQuantidade"><strong>-</strong></th>
                                            <th class="text-end" id="totalValor"><strong>-</strong></th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Valor do débito calculado pela Emgea (campo hidden usado no POST) -->
                    <input type="hidden" id="vr_debito_calculado_emgea" name="vr_debito_calculado_emgea">
                </div>

                <!-- ==== SEÇÃO 3: AVALIAÇÃO E VENDA ==== -->
                <div class="border-bottom pb-3 mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-home me-2"></i>Avaliação e Venda
                    </h5>

                    <!-- Valor de avaliação -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-home text-primary me-1"></i>
                            Valor de Avaliação
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               id="vr_avaliacao"
                               name="vr_avaliacao"
                               readonly>
                        <small class="text-muted">
                            <span id="msgAvaliacao">Busca automática do laudo de avaliação</span>
                        </small>
                    </div>

                    <!-- Data do laudo -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-calendar-alt text-info me-1"></i>
                            Data do Laudo
                        </label>
                        <input type="date"
                               class="form-control bg-light"
                               id="dt_laudo"
                               name="dt_laudo"
                               readonly>
                        <small class="text-muted">
                            <span id="msgDtLaudo">Busca automática</span>
                        </small>
                    </div>

                    <!-- Status do imóvel -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-info-circle text-warning me-1"></i>
                            Status do Imóvel
                        </label>
                        <input type="text"
                               class="form-control bg-light"
                               id="status_imovel"
                               name="status_imovel"
                               readonly>
                        <small class="text-muted">
                            <span id="msgStatus">Busca automática do status atual</span>
                        </small>
                    </div>

                    <!-- SEÇÃO CONDICIONAL - APARECE SE STATUS = VENDIDO -->
                    <div id="divVendaDetalhes" style="display: none;">
                        <div class="alert alert-success">
                            <h6 class="alert-heading">
                                <i class="fas fa-check-circle me-2"></i>Imóvel Vendido - Informações da Venda
                            </h6>
                            <hr>

                            <!-- Valor de venda -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-dollar-sign text-success me-1"></i>
                                    Valor de Venda
                                </label>
                                <input type="text"
                                       class="form-control bg-white"
                                       id="vr_venda"
                                       name="vr_venda"
                                       readonly>
                            </div>

                            <!-- Data da venda -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-calendar-check text-success me-1"></i>
                                    Data da Venda
                                </label>
                                <input type="date"
                                       class="form-control bg-white"
                                       id="dt_venda"
                                       name="dt_venda"
                                       readonly>
                            </div>

                            <!-- Nome do adquirente -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-user text-info me-1"></i>
                                    Nome do Adquirente
                                </label>
                                <input type="text"
                                       class="form-control bg-white"
                                       id="nome_comprador"
                                       name="nome_comprador"
                                       readonly>
                            </div>

                            <!-- NOVO: Tipo de Pagamento -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-credit-card text-primary me-1"></i>
                                    Tipo de Pagamento
                                </label>
                                <input type="hidden" id="tipo_pagamento_venda" name="tipo_pagamento_venda">
                                <div class="form-control bg-white" id="tipo_pagamento_display" style="min-height: 38px;">
                                    -
                                </div>
                                <small class="text-muted">
                                    <span id="msgTipoPagamento">Busca automática</span>
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Data do registro (INPUT MANUAL) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-edit text-primary me-1"></i>
                            Data do Registro <span class="text-danger">*</span>
                        </label>
                        <input type="date"
                               class="form-control"
                               id="dt_registro"
                               name="dt_registro"
                               required>
                        <small class="text-muted">
                            Campo de preenchimento manual obrigatório
                        </small>
                    </div>
                </div>

                <!-- ==== SEÇÃO 4: PARTE FINAL - AÇÕES E PROCESSOS ==== -->
                <div class="border-bottom pb-3 mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-balance-scale me-2"></i>Ações e Processos Judiciais
                    </h5>

                    <!-- Gravame na matrícula -->
                    <div class="mb-3">
                        <label for="gravame_matricula" class="form-label fw-bold">
                            <i class="fas fa-file-signature text-danger me-1"></i>
                            Gravame na Matrícula
                        </label>
                        <textarea class="form-control"
                                  id="gravame_matricula"
                                  name="gravame_matricula"
                                  rows="3"
                                  placeholder="Descreva o gravame na matrícula do imóvel"></textarea>
                    </div>

                    <!-- Ações negociais administrativas -->
                    <div class="mb-3">
                        <label for="acoes_negociais_administrativas" class="form-label fw-bold">
                            <i class="fas fa-handshake text-success me-1"></i>
                            Ações Negociais Administrativas
                        </label>
                        <textarea class="form-control"
                                  id="acoes_negociais_administrativas"
                                  name="acoes_negociais_administrativas"
                                  rows="3"
                                  placeholder="Descreva as ações negociais administrativas"></textarea>
                    </div>

                    <!-- Número dos processos judiciais (automático) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-gavel text-warning me-1"></i>
                            Nº da Ação Judicial - Ações Negociais Judiciais
                        </label>
                        <textarea class="form-control bg-light"
                                  id="nr_processos_judiciais"
                                  name="nr_processos_judiciais"
                                  rows="3"
                                  readonly></textarea>
                        <small class="text-muted">
                            <span id="msgProcessos">Será preenchido automaticamente após buscar o contrato</span>
                        </small>
                    </div>

                    <!-- Vara do processo (automático) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-landmark text-primary me-1"></i>
                            Vara do Processo
                        </label>
                        <textarea class="form-control bg-light"
                                  id="vara_processo"
                                  name="vara_processo"
                                  rows="3"
                                  readonly></textarea>
                        <small class="text-muted">
                            <span id="msgVara">Será preenchido automaticamente após buscar o contrato</span>
                        </small>
                    </div>

                    <!-- Fase do processo (automático) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-tasks text-info me-1"></i>
                            Fase do Processo
                        </label>
                        <textarea class="form-control bg-light"
                                  id="fase_processo"
                                  name="fase_processo"
                                  rows="3"
                                  readonly></textarea>
                        <small class="text-muted">
                            <span id="msgFase">Será preenchido automaticamente após buscar o contrato</span>
                        </small>
                    </div>

                    <!-- Relatório da assessoria jurídica (manual) -->
                    <div class="mb-3">
                        <label for="relatorio_assessoria_juridica" class="form-label fw-bold">
                            <i class="fas fa-file-alt text-secondary me-1"></i>
                            Relatório da Assessoria Jurídica
                        </label>
                        <div id="infoProcessosRelatorio" class="alert alert-info" style="display: none;">
                            <strong>Processos encontrados:</strong>
                            <ul id="listaProcessosRelatorio" class="mb-0 mt-2"></ul>
                        </div>
                        <textarea class="form-control"
                                  id="relatorio_assessoria_juridica"
                                  name="relatorio_assessoria_juridica"
                                  rows="5"
                                  placeholder="Digite o relatório da assessoria jurídica sobre os processos"></textarea>
                    </div>
                </div>

                <!-- ==== SEÇÃO 5: DÉBITOS E PENALIDADES ==== -->
                <div class="border-bottom pb-3 mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-money-check-alt me-2"></i>Débitos e Penalidades
                    </h5>

                    <!-- Demais débitos pagos -->
                    <div class="card bg-light mb-3">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-receipt me-2"></i>Demais Débitos Pagos para o Imóvel
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Sisdex -->
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-file-invoice-dollar text-primary me-1"></i>
                                        Sisdex
                                    </label>
                                    <input type="text"
                                           class="form-control bg-white"
                                           id="vr_debitos_sisdex"
                                           readonly>
                                    <small class="text-muted">
                                        <span id="msgSisdex">Busca automática</span>
                                    </small>
                                </div>

                                <!-- Sisgea -->
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-file-invoice-dollar text-success me-1"></i>
                                        Sisgea
                                    </label>
                                    <input type="text"
                                           class="form-control bg-white"
                                           id="vr_debitos_sisgea"
                                           readonly>
                                    <small class="text-muted">
                                        <span id="msgSisgea">Busca automática</span>
                                    </small>
                                </div>

                                <!-- Total -->
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-calculator text-warning me-1"></i>
                                        Total
                                    </label>
                                    <input type="text"
                                           class="form-control bg-white border-warning fw-bold"
                                           id="vr_debitos_total"
                                           readonly>
                                    <small class="text-muted">
                                        <span id="msgDebitosTotal">Soma automática</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Penalidade de ANS - CAIXA -->
                    <div class="mb-3">
                        <label for="penalidade_ans_caixa" class="form-label fw-bold">
                            <i class="fas fa-exclamation-triangle text-danger me-1"></i>
                            Penalidade de ANS - CAIXA
                        </label>
                        <textarea class="form-control"
                                  id="penalidade_ans_caixa"
                                  name="penalidade_ans_caixa"
                                  rows="3"
                                  placeholder="Descreva as penalidades de ANS aplicadas pela CAIXA"></textarea>
                    </div>

                    <!-- Prejuízo Financeiro - CAIXA -->
                    <div class="mb-3">
                        <label for="prejuizo_financeiro_caixa" class="form-label fw-bold">
                            <i class="fas fa-chart-line text-danger me-1"></i>
                            Prejuízo Financeiro - CAIXA
                        </label>
                        <textarea class="form-control"
                                  id="prejuizo_financeiro_caixa"
                                  name="prejuizo_financeiro_caixa"
                                  rows="3"
                                  placeholder="Descreva o prejuízo financeiro da CAIXA"></textarea>
                    </div>
                </div>

                <!-- ==== SEÇÃO 6: CONSIDERAÇÕES FINAIS ==== -->
                <div class="mb-4">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-comments me-2"></i>Considerações Finais
                    </h5>

                    <!-- Considerações da analista Geadi -->
                    <div class="mb-3">
                        <label for="consideracoes_analista" class="form-label fw-bold">
                            <i class="fas fa-user-edit text-info me-1"></i>
                            Considerações da Analista GEADI
                        </label>
                        <textarea class="form-control"
                                  id="consideracoes_analista"
                                  name="consideracoes_analista"
                                  rows="5"
                                  placeholder="Digite as considerações da analista GEADI"></textarea>
                    </div>

                    <!-- Considerações finais do gestor da Geadi -->
                    <div class="mb-3">
                        <label for="consideracoes_gestor" class="form-label fw-bold">
                            <i class="fas fa-user-tie text-success me-1"></i>
                            Considerações Finais do Gestor da GEADI
                        </label>
                        <textarea class="form-control"
                                  id="consideracoes_gestor"
                                  name="consideracoes_gestor"
                                  rows="5"
                                  placeholder="Digite as considerações finais do gestor GEADI"></textarea>
                    </div>

                    <!-- NOVO: Considerações finais do gestor da SUMOV -->
                    <div class="mb-3">
                        <label for="consideracoes_gestor_sumov" class="form-label fw-bold">
                            <i class="fas fa-user-tie text-warning me-1"></i>
                            Considerações Finais do Gestor da SUMOV
                        </label>
                        <textarea class="form-control"
                                  id="consideracoes_gestor_sumov"
                                  name="consideracoes_gestor_sumov"
                                  rows="5"
                                  placeholder="Digite as considerações finais do gestor SUMOV"></textarea>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="d-flex justify-content-end gap-2">
                    <a href="{{ url_for('sumov.deliberacao_pagamento') }}" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save me-2"></i>Salvar Deliberação
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
// Variável global para armazenar índices e processos
let indicesDisponiveis = [];
let processosJudiciais = [];

// Preencher data de análise automaticamente ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    const hoje = new Date();
    const dia = String(hoje.getDate()).padStart(2, '0');
    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
    const ano = hoje.getFullYear();
    const dataFormatada = `${dia}/${mes}/${ano}`;

    const campoData = document.getElementById('dt_analise_display');
    if (campoData) {
        campoData.value = dataFormatada;
    }
});

// Função para formatar valores monetários
function formatarMoeda(valor) {
    if (!valor) return 'R$ 0,00';
    return 'R$ ' + parseFloat(valor).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Função para formatar percentual
function formatarPercentual(valor) {
    if (!valor) return '0,00%';
    return parseFloat(valor).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }) + '%';
}

// Máscara de moeda para o campo de valor manual
document.getElementById('vr_divida_condominio_2').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');

    if (value === '') {
        e.target.value = '';
        return;
    }

    value = parseInt(value, 10);
    const valorFormatado = (value / 100).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });

    e.target.value = 'R$ ' + valorFormatado;
});

// Permitir que o campo seja limpo
document.getElementById('vr_divida_condominio_2').addEventListener('keydown', function(e) {
    if (e.key === 'Backspace' && e.target.value === 'R$ 0,00') {
        e.target.value = '';
    }
});

// Evento do botão Buscar
document.getElementById('btnBuscar').addEventListener('click', function() {
    const contrato = document.getElementById('contrato').value.trim();

    if (!contrato) {
        alert('Por favor, informe o número do contrato.');
        return;
    }

    document.getElementById('loadingBusca').style.display = 'block';
    document.getElementById('btnBuscar').disabled = true;

    fetch('{{ url_for("sumov.buscar_dados_contrato") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ contrato: contrato })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingBusca').style.display = 'none';
        document.getElementById('btnBuscar').disabled = false;

        if (!data.success) {
            alert(data.message || 'Erro ao buscar dados do contrato.');
            return;
        }

        // 1. Preencher Data de Entrada no Estoque
        if (data.dt_entrada_estoque) {
            document.getElementById('dt_entrada_estoque').value = data.dt_entrada_estoque;
            document.getElementById('msgEstoque').innerHTML = '<i class="fas fa-check text-success me-1"></i>Encontrado no sistema';
        } else {
            document.getElementById('msgEstoque').innerHTML = '<i class="fas fa-times text-danger me-1"></i>Não encontrado';
        }

        // 2. Preencher Período de Prescrição
        if (data.periodo_prescricao) {
            document.getElementById('periodo_prescricao').value = data.periodo_prescricao;
            document.getElementById('msgPrescricao').innerHTML = '<i class="fas fa-check text-success me-1"></i>Encontrado no sistema';
        } else {
            document.getElementById('msgPrescricao').innerHTML = '<i class="fas fa-times text-danger me-1"></i>Não encontrado';
        }

        // NOVO: 2.5 Preencher Período da Cobrança dos Débitos
        if (data.periodo_cobranca_encontrado) {
            document.getElementById('dt_periodo_cobranca_inicio').value = data.dt_periodo_cobranca_inicio;
            document.getElementById('dt_periodo_cobranca_fim').value = data.dt_periodo_cobranca_fim;
            document.getElementById('dt_periodo_cobranca_inicio').removeAttribute('readonly');
            document.getElementById('dt_periodo_cobranca_fim').removeAttribute('readonly');

            const dtInicio = new Date(data.dt_periodo_cobranca_inicio + 'T00:00:00');
            const dtFim = new Date(data.dt_periodo_cobranca_fim + 'T00:00:00');
            const dtInicioFormatada = dtInicio.toLocaleDateString('pt-BR');
            const dtFimFormatada = dtFim.toLocaleDateString('pt-BR');

            document.getElementById('msgPeriodoInicio').innerHTML =
                `<i class="fas fa-check text-success me-1"></i>Detectado: ${dtInicioFormatada}`;
            document.getElementById('msgPeriodoFim').innerHTML =
                `<i class="fas fa-check text-success me-1"></i>Detectado: ${dtFimFormatada}`;

            document.getElementById('alertPeriodoAutomatico').style.display = 'block';
            document.getElementById('alertPeriodoManual').style.display = 'none';
        } else {
            document.getElementById('dt_periodo_cobranca_inicio').value = '';
            document.getElementById('dt_periodo_cobranca_fim').value = '';
            document.getElementById('dt_periodo_cobranca_inicio').removeAttribute('readonly');
            document.getElementById('dt_periodo_cobranca_fim').removeAttribute('readonly');

            document.getElementById('msgPeriodoInicio').innerHTML =
                '<i class="fas fa-exclamation-triangle text-warning me-1"></i>Não encontrado - preencha manualmente';
            document.getElementById('msgPeriodoFim').innerHTML =
                '<i class="fas fa-exclamation-triangle text-warning me-1"></i>Não encontrado - preencha manualmente';

            document.getElementById('alertPeriodoAutomatico').style.display = 'none';
            document.getElementById('alertPeriodoManual').style.display = 'block';
        }

        // 3. Preencher Valor Inicial
        if (data.valor_inicial > 0) {
            document.getElementById('vr_divida_inicial').value = formatarMoeda(data.valor_inicial);
            document.getElementById('msgValorInicial').innerHTML =
                `<i class="fas fa-check text-success me-1"></i>${data.qtd_parcelas_inicial} parcela(s) encontrada(s)`;
        } else {
            document.getElementById('msgValorInicial').innerHTML = '<i class="fas fa-times text-danger me-1"></i>Não encontrado';
        }

        // 4. Preencher Valor de Avaliação
        if (data.vr_avaliacao) {
            document.getElementById('vr_avaliacao').value = formatarMoeda(data.vr_avaliacao);
            document.getElementById('msgAvaliacao').innerHTML =
                '<i class="fas fa-check text-success me-1"></i>Encontrado';
        } else {
            document.getElementById('msgAvaliacao').innerHTML =
                '<i class="fas fa-times text-danger me-1"></i>Não encontrado';
        }

        // 5. Preencher Data do Laudo
        if (data.dt_laudo) {
            document.getElementById('dt_laudo').value = data.dt_laudo;
            document.getElementById('msgDtLaudo').innerHTML =
                '<i class="fas fa-check text-success me-1"></i>Encontrado';
        } else {
            document.getElementById('msgDtLaudo').innerHTML =
                '<i class="fas fa-times text-danger me-1"></i>Não encontrado';
        }

        // 6. Preencher Status do Imóvel
        if (data.status_imovel) {
            document.getElementById('status_imovel').value = data.status_imovel;
            document.getElementById('msgStatus').innerHTML =
                '<i class="fas fa-check text-success me-1"></i>Encontrado';

            if (data.status_imovel.toUpperCase().includes('VENDIDO')) {
                document.getElementById('divVendaDetalhes').style.display = 'block';

                if (data.vr_venda) {
                    document.getElementById('vr_venda').value = formatarMoeda(data.vr_venda);
                }
                if (data.dt_venda) {
                    document.getElementById('dt_venda').value = data.dt_venda;
                }
                if (data.nome_comprador) {
                    document.getElementById('nome_comprador').value = data.nome_comprador;
                }

                if (data.tipo_pagamento_venda) {
                    document.getElementById('tipo_pagamento_venda').value = data.tipo_pagamento_venda;

                    let tipoPagamentoDisplay = '';
                    let icone = '';
                    let cor = '';

                    if (data.tipo_pagamento_venda === 'A_VISTA') {
                        tipoPagamentoDisplay = 'À Vista';
                        icone = '<i class="fas fa-money-bill-wave text-success me-2"></i>';
                        cor = 'success';
                    } else if (data.tipo_pagamento_venda === 'PARCELADO') {
                        tipoPagamentoDisplay = 'Parcelado';
                        icone = '<i class="fas fa-credit-card text-primary me-2"></i>';
                        cor = 'primary';
                    }

                    document.getElementById('tipo_pagamento_display').innerHTML =
                        `${icone}<span class="badge bg-${cor}">${tipoPagamentoDisplay}</span>`;
                    document.getElementById('msgTipoPagamento').innerHTML =
                        '<i class="fas fa-check text-success me-1"></i>Detectado automaticamente';
                } else {
                    document.getElementById('msgTipoPagamento').innerHTML =
                        '<i class="fas fa-times text-danger me-1"></i>Não foi possível determinar';
                }
            } else {
                document.getElementById('divVendaDetalhes').style.display = 'none';
            }
        } else {
            document.getElementById('msgStatus').innerHTML =
                '<i class="fas fa-times text-danger me-1"></i>Não encontrado';
        }

        // 7. Preencher Select de Índices
        if (data.indices_disponiveis && data.indices_disponiveis.length > 0) {
            indicesDisponiveis = data.indices_disponiveis;

            const selectIndice = document.getElementById('indice_economico');
            selectIndice.innerHTML = '<option value="">Selecione o índice...</option>';

            data.indices_disponiveis.forEach((indice, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${indice.nome_indice} - ${formatarMoeda(indice.valor_com_honorarios)}`;
                selectIndice.appendChild(option);
            });

            document.getElementById('divIndices').style.display = 'block';
        } else {
            alert('Nenhum cálculo encontrado no SISCalculo para este contrato. Por favor, processe os cálculos primeiro.');
        }

        // 8. Preencher Processos Judiciais
        if (data.processos_judiciais && data.processos_judiciais.length > 0) {
            processosJudiciais = data.processos_judiciais;

            let nrProcessos = [];
            let varas = [];
            let fases = [];
            let listaProcessos = [];

            data.processos_judiciais.forEach(processo => {
                nrProcessos.push(processo.numero);
                varas.push(`${processo.numero}: ${processo.vara}`);
                fases.push(`${processo.numero}: ${processo.fase}`);
                listaProcessos.push(`<li><strong>${processo.numero}</strong> - Vara: ${processo.vara} - Fase: ${processo.fase}</li>`);
            });

            document.getElementById('nr_processos_judiciais').value = nrProcessos.join('\n');
            document.getElementById('vara_processo').value = varas.join('\n');
            document.getElementById('fase_processo').value = fases.join('\n');

            document.getElementById('msgProcessos').innerHTML =
                `<i class="fas fa-check text-success me-1"></i>${data.processos_judiciais.length} processo(s) encontrado(s)`;
            document.getElementById('msgVara').innerHTML =
                '<i class="fas fa-check text-success me-1"></i>Informações carregadas';
            document.getElementById('msgFase').innerHTML =
                '<i class="fas fa-check text-success me-1"></i>Informações carregadas';

            document.getElementById('infoProcessosRelatorio').style.display = 'block';
            document.getElementById('listaProcessosRelatorio').innerHTML = listaProcessos.join('');
        } else {
            document.getElementById('nr_processos_judiciais').value = '';
            document.getElementById('vara_processo').value = '';
            document.getElementById('fase_processo').value = '';
            document.getElementById('msgProcessos').innerHTML =
                '<i class="fas fa-info text-info me-1"></i>Nenhum processo encontrado';
            document.getElementById('msgVara').innerHTML =
                '<i class="fas fa-info text-info me-1"></i>Não aplicável';
            document.getElementById('msgFase').innerHTML =
                '<i class="fas fa-info text-info me-1"></i>Não aplicável';
            document.getElementById('infoProcessosRelatorio').style.display = 'none';
        }

        // 9. Preencher Débitos
        if (data.vr_debitos_sisdex !== undefined) {
            document.getElementById('vr_debitos_sisdex').value = formatarMoeda(data.vr_debitos_sisdex);
            document.getElementById('msgSisdex').innerHTML =
                '<i class="fas fa-check text-success me-1"></i>Encontrado';
        }

        if (data.vr_debitos_sisgea !== undefined) {
            document.getElementById('vr_debitos_sisgea').value = formatarMoeda(data.vr_debitos_sisgea);
            document.getElementById('msgSisgea').innerHTML =
                '<i class="fas fa-check text-success me-1"></i>Encontrado';
        }

        if (data.vr_debitos_total !== undefined) {
            document.getElementById('vr_debitos_total').value = formatarMoeda(data.vr_debitos_total);
            document.getElementById('msgDebitosTotal').innerHTML =
                '<i class="fas fa-check text-success me-1"></i>Calculado';
        }

    })
    .catch(error => {
        document.getElementById('loadingBusca').style.display = 'none';
        document.getElementById('btnBuscar').disabled = false;
        alert('Erro ao buscar dados: ' + error);
    });
});

// Evento ao selecionar índice - MOSTRAR DETALHES DOS HONORÁRIOS E TIPOS DE PARCELA
document.getElementById('indice_economico').addEventListener('change', function() {
    const idx = parseInt(this.value);

    if (!isNaN(idx) && indicesDisponiveis[idx]) {
        const indice = indicesDisponiveis[idx];

        // Preencher valores do cálculo
        document.getElementById('vr_debito_calculado_emgea').value = indice.valor_com_honorarios;
        document.getElementById('divDetalhesCalculo').style.display = 'block';
        document.getElementById('nomeIndiceDetalhes').textContent = indice.nome_indice;
        document.getElementById('vr_divida_sem_honorarios').value = formatarMoeda(indice.valor_divida);
        document.getElementById('perc_honorarios_display').value = formatarPercentual(indice.perc_honorarios);
        document.getElementById('vr_honorarios_display').value = formatarMoeda(indice.valor_honorarios);
        document.getElementById('vr_total_com_honorarios_display').value = formatarMoeda(indice.valor_com_honorarios);

        // ✅ NOVO: Preencher tabela de tipos de parcela
        if (indice.totais_por_tipo && indice.totais_por_tipo.length > 0) {
            const tbody = document.getElementById('corpoTabelaTiposParcela');
            tbody.innerHTML = '';

            let totalQtd = 0;
            let totalValor = 0;

            indice.totais_por_tipo.forEach(tipo => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center">${tipo.id_tipo}</td>
                    <td>${tipo.descricao}</td>
                    <td class="text-center">${tipo.quantidade}</td>
                    <td class="text-end"><strong>${formatarMoeda(tipo.valor_total)}</strong></td>
                `;
                tbody.appendChild(tr);

                totalQtd += tipo.quantidade;
                totalValor += tipo.valor_total;
            });

            // Atualizar totais no footer
            document.getElementById('totalQuantidade').innerHTML = `<strong>${totalQtd}</strong>`;
            document.getElementById('totalValor').innerHTML = `<strong>${formatarMoeda(totalValor)}</strong>`;

            // Atualizar nome do índice no card de tipos
            document.getElementById('nomeIndiceTipos').textContent = indice.nome_indice;

            // Mostrar card de tipos de parcela
            document.getElementById('divTiposParcela').style.display = 'block';
        } else {
            // Esconder card se não houver tipos
            document.getElementById('divTiposParcela').style.display = 'none';
        }

        // Scroll suave para os detalhes
        document.getElementById('divDetalhesCalculo').scrollIntoView({
            behavior: 'smooth',
            block: 'nearest'
        });
    } else {
        document.getElementById('divDetalhesCalculo').style.display = 'none';
        document.getElementById('divTiposParcela').style.display = 'none';  // ✅ NOVO
    }
});
</script>
{% endblock %}