{% extends "base.html" %}

{% block title %}SISCalculo - Sistema de Cálculo de Atualização{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Cabeçalho -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="h2">
                    <i class="fas fa-calculator text-warning me-2"></i>
                    SISCalculo - Cálculo de Atualização Monetária
                </h1>
                <p class="text-muted mb-0">
                    Cálculo de correção monetária com juros, multa e índices econômicos
                </p>
            </div>
            <div class="col-auto">
                <a href="{{ url_for('sumov.index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Voltar ao SUMOV
                </a>
            </div>
        </div>
    </div>

    <!-- Card de Processamento -->
    <div class="card shadow mb-4">
        <div class="card-header bg-warning text-dark py-3">
            <h5 class="mb-0">
                <i class="fas fa-upload me-2"></i>Novo Processamento
            </h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('siscalculo.processar') }}"
                  enctype="multipart/form-data" id="formSiscalculo">

                <!-- Linha 1: Data e Índice -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="dt_atualizacao" class="form-label">
                            Data de Atualização <span class="text-danger">*</span>
                        </label>
                        <input type="date" class="form-control" id="dt_atualizacao"
                               name="dt_atualizacao" required
                               value="{{ data_atual.strftime('%Y-%m-%d') }}">
                        <small class="text-muted">Data base para o cálculo da atualização</small>
                    </div>

                    <div class="col-md-6">
                        <label for="id_indice" class="form-label">
                            Índice Econômico <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="id_indice" name="id_indice" required>
                            <option value="">Selecione...</option>
                            {% for indice in indices %}
                            <option value="{{ indice.ID_INDICE_ECONOMICO }}">
                                {{ indice.DSC_INDICE_ECONOMICO }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Índice para correção monetária</small>
                    </div>
                </div>

                <!-- Linha 2: Honorários e Upload do arquivo -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="perc_honorarios" class="form-label">
                            Honorários (%) <span class="text-danger">*</span>
                        </label>
                        <input type="number" class="form-control" id="perc_honorarios"
                               name="perc_honorarios" min="0" max="100" step="0.01"
                               value="10.00" required>
                        <small class="text-muted">Percentual de honorários advocatícios</small>
                    </div>

                    <div class="col-md-8">
                        <label for="arquivo_excel" class="form-label">
                            Arquivo Excel <span class="text-danger">*</span>
                        </label>
                        <input type="file" class="form-control" id="arquivo_excel"
                               name="arquivo_excel" accept=".xlsx,.xls" required>
                        <small class="text-muted">
                            Arquivo Excel com as cotas a serem calculadas
                        </small>
                    </div>
                </div>

                <!-- Informações sobre o formato -->
                <div class="alert alert-info" role="alert">
                    <h6 class="alert-heading">
                        <i class="fas fa-info-circle me-2"></i>Formato do Arquivo Excel
                    </h6>
                    <p class="mb-2">O arquivo deve conter as seguintes colunas:</p>
                    <ul class="mb-0">
                        <li><strong>Coluna A:</strong> Imóvel (opcional)</li>
                        <li><strong>Coluna B:</strong> Data de Vencimento (formato DD/MM/AAAA)</li>
                        <li><strong>Coluna C:</strong> Valor da Cota (formato numérico)</li>
                    </ul>
                </div>

                <!-- Botões -->
                <div class="row mt-4">
                    <div class="col-md-12 text-center">
                        <button type="button" class="btn btn-secondary me-2" onclick="limparFormulario()">
                            <i class="fas fa-eraser me-2"></i>Limpar
                        </button>
                        <button type="submit" class="btn btn-warning btn-lg text-dark" id="btnProcessar">
                            <i class="fas fa-calculator me-2"></i>Processar Cálculo
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Histórico de Processamentos -->
    {% if historico %}
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-history me-2"></i>Últimos Processamentos
            </h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th>Data Atualização</th>
                            <th>Qtd. Registros</th>
                            <th>Valor Total</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for h in historico %}
                        <tr>
                            <td>{{ h.DT_ATUALIZACAO.strftime('%d/%m/%Y') }}</td>
                            <td>{{ h.qtd_registros }}</td>
                            <td>R$ {{ "{:,.2f}".format(h.valor_total or 0).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                            <td>
                                <a href="{{ url_for('siscalculo.resultados', dt_atualizacao=h.DT_ATUALIZACAO.strftime('%Y-%m-%d')) }}"
                                   class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> Ver Resultados
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Função para limpar formulário
function limparFormulario() {
    document.getElementById('formSiscalculo').reset();
    // Resetar honorários para 10%
    document.getElementById('perc_honorarios').value = '10.00';
}

// Adicionar listener de submit com debug
document.getElementById('formSiscalculo').addEventListener('submit', function(e) {
    console.log('========================================');
    console.log('FORMULÁRIO SUBMETIDO!');
    console.log('========================================');

    const formData = new FormData(this);

    console.log('Dados do formulário:');
    console.log('- dt_atualizacao:', formData.get('dt_atualizacao'));
    console.log('- id_indice:', formData.get('id_indice'));
    console.log('- perc_honorarios:', formData.get('perc_honorarios'));
    console.log('- arquivo_excel:', formData.get('arquivo_excel')?.name);

    // Validações básicas
    if (!formData.get('dt_atualizacao')) {
        alert('Por favor, informe a data de atualização!');
        e.preventDefault();
        return false;
    }

    if (!formData.get('id_indice')) {
        alert('Por favor, selecione um índice econômico!');
        e.preventDefault();
        return false;
    }

    if (!formData.get('perc_honorarios')) {
        alert('Por favor, informe o percentual de honorários!');
        e.preventDefault();
        return false;
    }

    if (!formData.get('arquivo_excel')?.name) {
        alert('Por favor, selecione um arquivo Excel!');
        e.preventDefault();
        return false;
    }

    console.log('Validações OK! Enviando formulário...');

    // Mostrar loading
    const btn = document.getElementById('btnProcessar');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';

    console.log('Action URL:', this.action);
    console.log('Method:', this.method);
    console.log('========================================');

    // Deixar o submit acontecer normalmente
    return true;
});

// Debug ao carregar a página
console.log('Página SISCalculo carregada!');
console.log('Action do formulário:', document.getElementById('formSiscalculo').action);
</script>
{% endblock %}