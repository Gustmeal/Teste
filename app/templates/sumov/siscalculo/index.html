{% extends "base.html" %}

{% block title %}SISCalculo - Sistema de Cálculo de Atualização{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Cabeçalho -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="h2">
                    <i class="fas fa-calculator text-warning me-2"></i>
                    SISCalculo - Cálculo de Atualização Monetária
                </h1>
                <p class="text-muted mb-0">
                    Cálculo de correção monetária com juros, multa e índices econômicos
                </p>
            </div>
            <div class="col-auto">
                <a href="{{ url_for('sumov.index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Voltar ao SUMOV
                </a>
            </div>
        </div>
    </div>

    <!-- Card de Processamento -->
    <div class="card shadow mb-4">
        <div class="card-header bg-warning text-dark py-3">
            <h5 class="mb-0">
                <i class="fas fa-upload me-2"></i>Novo Processamento
            </h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('siscalculo.processar') }}"
                  enctype="multipart/form-data" id="formSiscalculo">

                <!-- Linha 1: Data e Índice -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="dt_atualizacao" class="form-label">
                            Data de Atualização <span class="text-danger">*</span>
                        </label>
                        <input type="date" class="form-control" id="dt_atualizacao"
                               name="dt_atualizacao" required
                               value="{{ data_atual.strftime('%Y-%m-%d') }}">
                        <small class="text-muted">Data base para o cálculo da atualização</small>
                    </div>

                    <div class="col-md-6">
                        <label for="id_indice" class="form-label">
                            Índice Econômico <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="id_indice" name="id_indice" required>
                            <option value="">Selecione...</option>
                            {% for indice in indices %}
                            <option value="{{ indice.ID_INDICE_ECONOMICO }}">
                                {{ indice.DSC_INDICE_ECONOMICO }}
                            </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Índice para correção monetária</small>
                    </div>
                </div>

                <!-- Linha 2: Honorários e Upload do arquivo -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="perc_honorarios" class="form-label">
                            Honorários (%) <span class="text-danger">*</span>
                        </label>
                        <input type="number" class="form-control" id="perc_honorarios"
                               name="perc_honorarios" min="0" max="100" step="0.01"
                               value="10.00" required>
                        <small class="text-muted">Percentual de honorários advocatícios</small>
                    </div>

                    <div class="col-md-8">
                        <label for="arquivo_excel" class="form-label">
                            Arquivo Excel <span class="text-danger">*</span>
                        </label>
                        <input type="file" class="form-control" id="arquivo_excel"
                               name="arquivo_excel" accept=".xlsx,.xls" required>
                        <small class="text-muted">
                            Arquivo Excel com as cotas a serem calculadas
                        </small>
                    </div>
                </div>

                <!-- Linha 3 - Período da Prescrição (MÊS/ANO) -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="aplicar_prescricao"
                                   name="aplicar_prescricao" onchange="togglePrescricao()">
                            <label class="form-check-label fw-bold" for="aplicar_prescricao">
                                <i class="fas fa-ban text-danger me-2"></i>Aplicar Período da Prescrição
                            </label>
                            <small class="text-muted d-block ms-4">
                                Marque esta opção para excluir datas prescritas do cálculo (por mês/ano)
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Campos de MÊS/ANO do período de prescrição (inicialmente ocultos) -->
                <div class="row mb-4" id="campos_prescricao" style="display: none;">
                    <div class="col-md-6">
                        <label for="mes_ano_prescricao_inicio" class="form-label">
                            <i class="fas fa-calendar-alt me-2"></i>Mês/Ano Início da Prescrição
                        </label>
                        <input type="month" class="form-control" id="mes_ano_prescricao_inicio"
                               name="mes_ano_prescricao_inicio">
                        <small class="text-muted">Mês e ano inicial do período prescrito (ex: Janeiro/2015)</small>
                    </div>

                    <div class="col-md-6">
                        <label for="mes_ano_prescricao_fim" class="form-label">
                            <i class="fas fa-calendar-alt me-2"></i>Mês/Ano Fim da Prescrição
                        </label>
                        <input type="month" class="form-control" id="mes_ano_prescricao_fim"
                               name="mes_ano_prescricao_fim">
                        <small class="text-muted">Mês e ano final do período prescrito (ex: Dezembro/2018)</small>
                    </div>

                    <div class="col-md-12 mt-2">
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Atenção:</strong> Todas as datas de vencimento que estiverem dentro
                            deste período (mês/ano) serão <strong>excluídas</strong> e <strong>não participarão do cálculo</strong>.
                            <br>
                            <strong>Exemplo:</strong> Se escolher Janeiro/2015 até Dezembro/2018, todos os vencimentos
                            de 01/01/2015 até 31/12/2018 serão excluídos.
                        </div>
                    </div>
                </div>

                <!-- Informações sobre o formato -->
                <div class="alert alert-info" role="alert">
                    <h6 class="alert-heading">
                        <i class="fas fa-info-circle me-2"></i>Formato do Arquivo Excel
                    </h6>
                    <p class="mb-2">O arquivo deve conter as seguintes colunas:</p>
                    <ul class="mb-0">
                        <li><strong>Coluna A:</strong> Imóvel (opcional)</li>
                        <li><strong>Coluna B:</strong> Data de Vencimento (formato DD/MM/AAAA)</li>
                        <li><strong>Coluna C:</strong> Valor da Cota (formato numérico)</li>
                    </ul>
                </div>

                <!-- Botões -->
                <div class="row mt-4">
                    <div class="col-md-12 text-center">
                        <button type="button" class="btn btn-secondary me-2" onclick="limparFormulario()">
                            <i class="fas fa-eraser me-2"></i>Limpar
                        </button>
                        <button type="submit" class="btn btn-warning btn-lg text-dark" id="btnProcessar">
                            <i class="fas fa-calculator me-2"></i>Processar Cálculo
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Filtro de Número de Contrato -->
    {% if historico %}
    <div class="card shadow mb-3">
        <div class="card-body">
            <form method="GET" action="{{ url_for('siscalculo.index') }}" class="row g-3">
                <div class="col-md-10">
                    <label for="filtro_contrato" class="form-label">
                        <i class="fas fa-filter me-2"></i>Filtrar por Número de Contrato
                    </label>
                    <input type="text" class="form-control" id="filtro_contrato"
                           name="filtro_contrato" value="{{ filtro_contrato or '' }}"
                           placeholder="Digite o número do contrato...">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-2"></i>Filtrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Histórico de Processamentos -->
    <div class="card shadow">
        <div class="card-header bg-primary text-white py-3">
            <h5 class="mb-0">
                <i class="fas fa-history me-2"></i>Histórico de Processamentos
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Nº Contrato</th>
                            <th>Data de Atualização</th>
                            <th>Índice</th>
                            <th class="text-center">Qtd. Parcelas</th>
                            <th class="text-end">Valor Total</th>
                            <th class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for h in historico %}
                        <tr>
                            <td><strong>{{ h.IMOVEL }}</strong></td>
                            <td>{{ h.DT_ATUALIZACAO.strftime('%d/%m/%Y') }}</td>
                            <td><span class="badge bg-info">{{ h.DSC_INDICE_ECONOMICO }}</span></td>
                            <td class="text-center">{{ h.qtd_registros }}</td>
                            <td class="text-end">R$ {{ "{:,.2f}".format(h.valor_total or 0).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                            <td class="text-center">
                                <a href="{{ url_for('siscalculo.resultados', dt_atualizacao=h.DT_ATUALIZACAO.strftime('%Y-%m-%d'), imovel=h.IMOVEL, id_indice=h.ID_INDICE_ECONOMICO, perc_honorarios=h.PERC_HONORARIOS if h.PERC_HONORARIOS else 10.00) }}"
                                   class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> Ver Resultados
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        {% if filtro_contrato %}
        Nenhum processamento encontrado para o contrato <strong>{{ filtro_contrato }}</strong>.
        {% else %}
        Nenhum processamento realizado ainda. Faça o upload de um arquivo Excel para começar.
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
// Função para mostrar/ocultar campos de prescrição
function togglePrescricao() {
    const checkbox = document.getElementById('aplicar_prescricao');
    const campos = document.getElementById('campos_prescricao');
    const mesAnoInicio = document.getElementById('mes_ano_prescricao_inicio');
    const mesAnoFim = document.getElementById('mes_ano_prescricao_fim');

    if (checkbox.checked) {
        campos.style.display = 'flex';
        mesAnoInicio.required = true;
        mesAnoFim.required = true;
    } else {
        campos.style.display = 'none';
        mesAnoInicio.required = false;
        mesAnoFim.required = false;
        mesAnoInicio.value = '';
        mesAnoFim.value = '';
    }
}

// Função para limpar formulário
function limparFormulario() {
    document.getElementById('formSiscalculo').reset();
    document.getElementById('perc_honorarios').value = '10.00';
    document.getElementById('campos_prescricao').style.display = 'none';
    document.getElementById('mes_ano_prescricao_inicio').required = false;
    document.getElementById('mes_ano_prescricao_fim').required = false;
}

// Validação do formulário
document.getElementById('formSiscalculo').addEventListener('submit', function(e) {
    const formData = new FormData(this);

    if (!formData.get('dt_atualizacao')) {
        alert('Por favor, informe a data de atualização!');
        e.preventDefault();
        return false;
    }

    if (!formData.get('id_indice')) {
        alert('Por favor, selecione um índice econômico!');
        e.preventDefault();
        return false;
    }

    if (!formData.get('perc_honorarios')) {
        alert('Por favor, informe o percentual de honorários!');
        e.preventDefault();
        return false;
    }

    if (!formData.get('arquivo_excel')?.name) {
        alert('Por favor, selecione um arquivo Excel!');
        e.preventDefault();
        return false;
    }

    const aplicarPrescricao = document.getElementById('aplicar_prescricao').checked;
    if (aplicarPrescricao) {
        const mesAnoInicio = formData.get('mes_ano_prescricao_inicio');
        const mesAnoFim = formData.get('mes_ano_prescricao_fim');

        if (!mesAnoInicio || !mesAnoFim) {
            alert('Por favor, informe o período completo da prescrição (mês/ano início e fim)!');
            e.preventDefault();
            return false;
        }

        if (mesAnoInicio > mesAnoFim) {
            alert('O mês/ano de início da prescrição deve ser anterior ou igual ao mês/ano de fim!');
            e.preventDefault();
            return false;
        }
    }

    const btn = document.getElementById('btnProcessar');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';

    return true;
});
</script>
{% endblock %}