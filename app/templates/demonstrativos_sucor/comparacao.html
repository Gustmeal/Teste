{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <a href="{{ url_for('demonstrativo_sucor.index') }}" class="btn-back mb-3">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>

    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h2 class="mb-0">
                <i class="fas fa-chart-bar"></i> {{ tipo_demonstrativo }}
            </h2>
            <div class="text-end">
                <small class="d-block">{{ periodo1 }} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {{ periodo2 }}</small>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="text-end px-3 py-2 bg-light">
                <strong>R$ em mil</strong>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="tabelaDemonstrativoSucor">
                    <thead style="background-color: #a8e6cf;">
                        <tr>
                            <th class="ps-4" style="min-width: 400px;">Item</th>
                            <th class="text-end" style="min-width: 200px;">{{ periodo1 }}</th>
                            <th class="text-end" style="min-width: 200px;">{{ periodo2 }}</th>
                            <th class="text-end" style="min-width: 200px;">Variação {{ tipo_demonstrativo[:3] }}</th>
                            <th class="text-center" style="width: 80px;">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in dados_comparacao %}
                        <tr class="linha-demonstrativo {% if item.tem_justificativa %}linha-editada{% endif %}"
                            data-co-demonstrativo="{{ item.co_demonstrativo }}"
                            data-ordem="{{ item.ordem }}">
                            <td class="ps-4">
                                <span class="text-muted me-2">{{ '%02d'|format(item.ordem) }}</span>
                                {{ item.grupo }}
                            </td>
                            <td class="text-end valor-periodo1">
                                {{ "{:,.2f}".format(item.valor_periodo1).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                            </td>
                            <td class="text-end valor-periodo2">
                                {{ "{:,.2f}".format(item.valor_periodo2).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                            </td>
                            <td class="text-end variacao-cell {% if item.variacao_justificada < 0 %}text-danger{% elif item.variacao_justificada > 0 %}text-success{% endif %}"
                                data-variacao-original="{{ item.variacao }}"
                                data-variacao-atual="{{ item.variacao_justificada }}">
                                <span class="valor-variacao">{{ "{:,.2f}".format(item.variacao_justificada).replace(',', 'X').replace('.', ',').replace('X', '.') }}</span>
                                {% if item.tem_justificativa %}
                                    <i class="fas fa-comment-dots text-warning ms-2 justificativa-icon"
                                       style="cursor: pointer; font-size: 1.1rem;"
                                       data-bs-toggle="popover"
                                       data-bs-trigger="hover focus"
                                       data-bs-placement="left"
                                       data-bs-html="true"
                                       title="Justificativa de Ajuste"
                                       data-bs-content="{{ item.descricao_justificativa or 'Sem descrição' }}"
                                       data-descricao="{{ item.descricao_justificativa or 'Sem descrição' }}">
                                    </i>
                                {% endif %}
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-primary btn-editar-variacao-sucor"
                                        title="Editar Justificativa"
                                        data-co-demonstrativo="{{ item.co_demonstrativo }}"
                                        data-ordem="{{ item.ordem }}"
                                        data-grupo="{{ item.grupo }}"
                                        data-variacao="{{ item.variacao_justificada }}"
                                        data-descricao="{{ item.descricao_justificativa or '' }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot style="background-color: #f0f0f0;">
                        <tr>
                            <th class="ps-4">TOTAL</th>
                            <th class="text-end">
                                {{ "{:,.2f}".format(dados_comparacao|sum(attribute='valor_periodo1')).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                            </th>
                            <th class="text-end">
                                {{ "{:,.2f}".format(dados_comparacao|sum(attribute='valor_periodo2')).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                            </th>
                            <th class="text-end {% if dados_comparacao|sum(attribute='variacao_justificada') < 0 %}text-danger{% elif dados_comparacao|sum(attribute='variacao_justificada') > 0 %}text-success{% endif %}">
                                {{ "{:,.2f}".format(dados_comparacao|sum(attribute='variacao_justificada')).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                            </th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edição de Justificativa -->
<div class="modal fade" id="modalJustificativaSucor" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> Editar Justificativa
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formJustificativaSucor">
                    <input type="hidden" id="co_demonstrativo_sucor" name="co_demonstrativo">
                    <input type="hidden" id="ordem_sucor" name="ordem">

                    <div class="mb-3">
                        <label class="form-label fw-bold">Item</label>
                        <input type="text" class="form-control-plaintext" id="item_grupo_sucor" readonly>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Valor Original</label>
                                <input type="text" class="form-control-plaintext" id="variacao_original_sucor" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="variacao_justificada_sucor" class="form-label fw-bold">Valor Ajustado</label>
                                <input type="number" class="form-control" id="variacao_justificada_sucor"
                                       name="variacao_justificada" step="0.01" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="descricao_sucor" class="form-label fw-bold">Descrição da Justificativa</label>
                        <textarea class="form-control" id="descricao_sucor" name="descricao"
                                  rows="4" placeholder="Descreva o motivo do ajuste..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="btnExcluirJustificativaSucor">
                    <i class="fas fa-trash"></i> Excluir
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnSalvarJustificativaSucor">
                    <i class="fas fa-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilo da tabela similar ao Power BI */
.table {
    font-size: 0.9rem;
}

.table > :not(caption) > * > * {
    padding: 0.5rem 0.75rem;
    vertical-align: middle;
}

.table thead th {
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
}

.linha-demonstrativo:hover {
    background-color: rgba(108, 99, 255, 0.05);
}

/* Estilo para linha editada */
.linha-editada {
    background-color: rgba(255, 193, 7, 0.05);
}

.linha-editada:hover {
    background-color: rgba(255, 193, 7, 0.1);
}

.variacao-cell {
    font-weight: 500;
}

.btn-editar-variacao-sucor {
    opacity: 0.7;
    transition: all 0.3s;
}

.btn-editar-variacao-sucor:hover {
    opacity: 1;
    transform: scale(1.1);
}

.modal-content {
    border-radius: 15px;
}

.form-control-plaintext {
    font-weight: 500;
}

/* Estilo para valores negativos */
.text-danger {
    color: #dc3545 !important;
}

.text-success {
    color: #28a745 !important;
}

/* Largura fixa para colunas numéricas */
.table td.text-end,
.table th.text-end {
    font-family: 'Courier New', monospace;
    white-space: nowrap;
}

/* Estilo do ícone de justificativa */
.justificativa-icon {
    transition: all 0.3s ease;
}

.justificativa-icon:hover {
    transform: scale(1.2);
    color: #ffc107 !important;
}

/* Personalização do popover */
.popover {
    max-width: 400px;
}

.popover-header {
    background-color: #ffc107;
    color: #212529;
    font-weight: 600;
}

.popover-body {
    font-size: 0.9rem;
    line-height: 1.5;
}

/* Estilo para o tooltip */
.tooltip-inner {
    max-width: 300px;
    text-align: left;
}
</style>

<script>
// Dados do período para uso no JavaScript
const periodo2DataSucor = {
    ano: {{ periodo2_data.ano }},
    mes: {{ periodo2_data.mes }}
};

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    // Inicializar popovers personalizados
    document.querySelectorAll('.justificativa-icon').forEach(icon => {
        // Tooltip ao passar o mouse
        const tooltip = new bootstrap.Tooltip(icon, {
            trigger: 'hover',
            placement: 'left',
            html: true,
            title: function() {
                const descricao = this.getAttribute('data-descricao');
                return `<strong>Justificativa:</strong><br>${descricao}`;
            }
        });

        // Popover ao clicar
        icon.addEventListener('click', function(e) {
            e.stopPropagation();

            // Fechar outros popovers abertos
            document.querySelectorAll('.popover').forEach(p => p.remove());

            const descricao = this.getAttribute('data-descricao');

            // Criar popover customizado
            const popover = document.createElement('div');
            popover.className = 'popover bs-popover-start show';
            popover.innerHTML = `
                <div class="popover-arrow"></div>
                <h3 class="popover-header">
                    Justificativa de Ajuste
                    <button type="button" class="btn-close btn-close-sm float-end" aria-label="Close"></button>
                </h3>
                <div class="popover-body">
                    ${descricao}
                </div>
            `;

            // Posicionar popover
            document.body.appendChild(popover);

            const iconRect = this.getBoundingClientRect();
            popover.style.position = 'absolute';
            popover.style.top = (iconRect.top + window.scrollY - popover.offsetHeight/2 + iconRect.height/2) + 'px';
            popover.style.left = (iconRect.left + window.scrollX - popover.offsetWidth - 10) + 'px';

            // Fechar ao clicar no X
            popover.querySelector('.btn-close').addEventListener('click', function() {
                popover.remove();
            });

            // Fechar ao clicar fora
            setTimeout(() => {
                document.addEventListener('click', function closePopover(e) {
                    if (!popover.contains(e.target) && e.target !== icon) {
                        popover.remove();
                        document.removeEventListener('click', closePopover);
                    }
                });
            }, 100);
        });
    });

    // Manipular clique no botão de editar
    document.querySelectorAll('.btn-editar-variacao-sucor').forEach(btn => {
        btn.addEventListener('click', function() {
            const co_demonstrativo = this.getAttribute('data-co-demonstrativo');
            const ordem = this.getAttribute('data-ordem');
            const grupo = this.getAttribute('data-grupo');
            const variacao = this.getAttribute('data-variacao');
            const descricao = this.getAttribute('data-descricao');

            // Buscar variação original da célula
            const linha = this.closest('tr');
            const variacaoOriginal = linha.querySelector('.variacao-cell').getAttribute('data-variacao-original');

            // Preencher modal
            document.getElementById('co_demonstrativo_sucor').value = co_demonstrativo;
            document.getElementById('ordem_sucor').value = ordem;
            document.getElementById('item_grupo_sucor').value = grupo;
            document.getElementById('variacao_original_sucor').value = formatarValor(parseFloat(variacaoOriginal));
            document.getElementById('variacao_justificada_sucor').value = variacao;
            document.getElementById('descricao_sucor').value = descricao;

            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('modalJustificativaSucor'));
            modal.show();
        });
    });

    // Salvar justificativa
    document.getElementById('btnSalvarJustificativaSucor').addEventListener('click', function() {
        const formData = {
            co_demonstrativo: parseInt(document.getElementById('co_demonstrativo_sucor').value),
            ordem: parseInt(document.getElementById('ordem_sucor').value),
            ano: periodo2DataSucor.ano,
            mes: periodo2DataSucor.mes,
            descricao: document.getElementById('descricao_sucor').value,
            variacao: parseFloat(document.getElementById('variacao_justificada_sucor').value)
        };

        fetch('{{ url_for("demonstrativo_sucor.salvar_justificativa") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Fechar modal
                bootstrap.Modal.getInstance(document.getElementById('modalJustificativaSucor')).hide();

                // Mostrar mensagem de sucesso
                showToast(data.message, 'success');

                // Recarregar página após 1 segundo
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showToast('Erro ao salvar: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            showToast('Erro ao salvar justificativa', 'danger');
            console.error('Error:', error);
        });
    });

    // Excluir justificativa
    document.getElementById('btnExcluirJustificativaSucor').addEventListener('click', function() {
        if (confirm('Tem certeza que deseja excluir esta justificativa?')) {
            const formData = {
                co_demonstrativo: parseInt(document.getElementById('co_demonstrativo_sucor').value),
                ordem: parseInt(document.getElementById('ordem_sucor').value),
                ano: periodo2DataSucor.ano,
                mes: periodo2DataSucor.mes
            };

            fetch('{{ url_for("demonstrativo_sucor.excluir_justificativa") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('modalJustificativaSucor')).hide();
                    showToast(data.message, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast('Erro ao excluir: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showToast('Erro ao excluir justificativa', 'danger');
                console.error('Error:', error);
            });
        }
    });
});

function formatarValor(valor) {
    return valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
</script>
{% endblock %}