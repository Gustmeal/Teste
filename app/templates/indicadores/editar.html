{% extends "base.html" %}

{% block title %}Editar Indicador - {{ indicador }}{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.geinc_index') }}">Início</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('indicador.index') }}">Indicadores</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('indicador.formulas') }}">Fórmulas</a></li>
                    <li class="breadcrumb-item active">Editar</li>
                </ol>
            </nav>
            <h1 class="h2 mb-0">Editar Indicador</h1>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-warning text-white">
            <h5 class="mb-0">
                <i class="fas fa-edit me-2"></i>{{ indicador }} - {{ dt_referencia.strftime('%d/%m/%Y') }}
            </h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('indicador.atualizar') }}" id="formEditar">
                <input type="hidden" name="dt_referencia" value="{{ dt_referencia }}">
                <input type="hidden" name="indicador" value="{{ indicador }}">

                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th width="10%">Variável</th>
                                <th width="45%">Nome da Variável</th>
                                <th width="25%">Fonte</th>
                                <th width="20%">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reg in registros %}
                            <tr>
                                <td class="text-center">{{ reg.VARIAVEL }}</td>
                                <td>{{ reg.NO_VARIAVEL or '-' }}</td>
                                <td>{{ reg.FONTE or '-' }}</td>
                                <td>
                                    <!-- Campo oculto com valor original -->
                                    <input type="hidden"
                                           name="valor_original_{{ reg.VARIAVEL }}"
                                           value="{{ '{:,.2f}'.format(reg.VR_VARIAVEL).replace(',', 'X').replace('.', ',').replace('X', '.') }}">

                                    <!-- Campo editável com máscara -->
                                    <input type="text"
                                           class="form-control text-end valor-monetario"
                                           name="valor_{{ reg.VARIAVEL }}"
                                           value="{{ '{:,.2f}'.format(reg.VR_VARIAVEL).replace(',', 'X').replace('.', ',').replace('X', '.') }}"
                                           required>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Atenção:</strong> Use vírgula como separador decimal e ponto como separador de milhar.
                    Exemplo: 1.234,56
                </div>

                <div class="d-flex justify-content-end gap-2 mt-4">
                    <a href="{{ url_for('indicador.formulas') }}" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save me-2"></i>Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript para máscara monetária -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para formatar valor monetário
    function formatarValor(valor) {
        // Remove tudo exceto números, vírgula e sinal negativo
        valor = valor.replace(/[^\d,-]/g, '');

        // Separa parte inteira e decimal
        const partes = valor.split(',');
        let inteiro = partes[0].replace(/\D/g, '');
        const decimal = partes[1] || '';

        // Adiciona separadores de milhar
        inteiro = inteiro.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

        // Retorna valor formatado
        return decimal ? inteiro + ',' + decimal.substring(0, 2) : inteiro;
    }

    // Aplicar máscara aos campos de valor
    document.querySelectorAll('.valor-monetario').forEach(function(input) {
        input.addEventListener('input', function(e) {
            const posicaoCursor = e.target.selectionStart;
            const valorAnterior = e.target.value;
            const valorFormatado = formatarValor(e.target.value);

            e.target.value = valorFormatado;

            // Ajustar posição do cursor
            const diferenca = valorFormatado.length - valorAnterior.length;
            e.target.setSelectionRange(posicaoCursor + diferenca, posicaoCursor + diferenca);
        });

        // Formatar ao carregar a página
        input.value = formatarValor(input.value);
    });

    // Validação ao submeter
    document.getElementById('formEditar').addEventListener('submit', function(e) {
        const inputs = document.querySelectorAll('.valor-monetario');
        for (let input of inputs) {
            if (!input.value || input.value === '0') {
                e.preventDefault();
                alert('Por favor, preencha todos os valores.');
                input.focus();
                return false;
            }
        }
    });
});
</script>

<style>
.valor-monetario {
    font-family: 'Courier New', monospace;
    font-weight: bold;
}
</style>
{% endblock %}