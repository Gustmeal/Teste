{% extends "base.html" %}

{% block title %}Editar Indicador - {{ indicador }}{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.geinc_index') }}">Início</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('indicador.index') }}">Indicadores</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('indicador.formulas') }}">Fórmulas</a></li>
                    <li class="breadcrumb-item active">Editar</li>
                </ol>
            </nav>
            <h1 class="h2 mb-0">Editar Indicador</h1>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-warning text-white">
            <h5 class="mb-0">
                <i class="fas fa-edit me-2"></i>{{ indicador }} - {{ dt_referencia.strftime('%d/%m/%Y') }}
            </h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('indicador.atualizar') }}" id="formEditar">
                <input type="hidden" name="dt_referencia" value="{{ dt_referencia }}">
                <input type="hidden" name="indicador" value="{{ indicador }}">

                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th width="10%">Variável</th>
                                <th width="45%">Nome da Variável</th>
                                <th width="25%">Fonte</th>
                                <th width="20%">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reg in registros %}
                            <tr>
                                <td class="text-center">{{ reg.VARIAVEL }}</td>
                                <td>{{ reg.NO_VARIAVEL or '-' }}</td>
                                <td>{{ reg.FONTE or '-' }}</td>
                                <td>
                                    <input type="hidden"
                                           name="valor_original_{{ reg.VARIAVEL }}"
                                           value="{{ '{:,.2f}'.format(reg.VR_VARIAVEL).replace(',', 'X').replace('.', ',').replace('X', '.') }}">

                                    <input type="text"
                                           class="form-control text-end valor-monetario"
                                           name="valor_{{ reg.VARIAVEL }}"
                                           value="{{ '{:,.2f}'.format(reg.VR_VARIAVEL).replace(',', 'X').replace('.', ',').replace('X', '.') }}"
                                           required>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Atenção:</strong> Use vírgula como separador decimal e ponto como separador de milhar.
                    Exemplo: 1.234,56
                </div>

                <div class="d-flex justify-content-end gap-2 mt-4">
                    <a href="{{ url_for('indicador.formulas') }}" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save me-2"></i>Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function aplicarMascaraMonetaria(input) {
        // 1. Pega apenas os dígitos do valor do input
        let valor = input.value.replace(/\D/g, '');

        // 2. Remove zeros à esquerda para evitar números como "00123"
        // mas garante que, se o valor for zero, ele permaneça "0"
        valor = String(parseInt(valor, 10) || 0);

        // 3. Garante que o valor tenha no mínimo 3 dígitos para os centavos (ex: "1" vira "001")
        valor = valor.padStart(3, '0');

        // 4. Separa a parte inteira e a parte decimal
        const parteInteira = valor.slice(0, -2);
        const parteDecimal = valor.slice(-2);

        // 5. Adiciona o separador de milhar (.) na parte inteira
        const parteInteiraFormatada = parteInteira.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

        // 6. Monta o valor final e atualiza o input
        input.value = `${parteInteiraFormatada},${parteDecimal}`;
    }

    // Seleciona todos os campos que precisam da máscara
    const camposMonetarios = document.querySelectorAll('.valor-monetario');

    camposMonetarios.forEach(function(input) {
        // Formata o valor inicial que vem do servidor
        aplicarMascaraMonetaria(input);

        // Adiciona o listener que aplica a máscara a cada alteração
        input.addEventListener('input', function() {
            aplicarMascaraMonetaria(input);
        });

        // Garante que o campo nunca fique vazio, resetando para 0,00
        input.addEventListener('blur', function() {
            if (input.value === '') {
                input.value = '0,00';
            }
        });
    });

    // A validação de submissão pode ser mantida ou ajustada
    document.getElementById('formEditar').addEventListener('submit', function(e) {
        const inputs = document.querySelectorAll('.valor-monetario');
        for (let input of inputs) {
            // Verifica se o valor não é "0,00" ou vazio, se isso for uma regra de negócio
            if (!input.value || input.value === '0,00') {
                // A validação original bloqueava o valor '0'. Ajuste conforme a necessidade.
                // Se o valor '0,00' for válido, remova este if.
                console.log(`Validação: O campo ${input.name} está com valor zero.`);
            }
        }
    });
});
</script>

<style>
.valor-monetario {
    font-family: 'Courier New', monospace;
    font-weight: bold;
}
</style>
{% endblock %}