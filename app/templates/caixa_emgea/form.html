{% extends "base.html" %}

{% block content %}
<div class="container-fluid fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold">
            <i class="fas fa-money-check-alt me-2"></i>
            {% if edit_mode %}Editar{% else %}Novo{% endif %} Registro - Caixa EMGEA
        </h1>
        <a href="{{ url_for('caixa_emgea.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar
        </a>
    </div>

    <form method="POST" id="formCaixaEmgea">
        <div class="row">
            <!-- Coluna Esquerda -->
            <div class="col-md-6">
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Dados Principais</h5>
                    </div>
                    <div class="card-body">
                        <!-- Número do Contrato -->
                        <div class="mb-3">
                            <label for="nu_contrato" class="form-label">Número do Contrato</label>
                            <input type="number" class="form-control" id="nu_contrato" name="nu_contrato"
                                   value="{{ registro.NU_CONTRATO if edit_mode else (dados.nu_contrato if dados else '') }}">
                        </div>

                        <!-- Número do Ofício -->
                        <div class="mb-3">
                            <label for="nu_oficio" class="form-label">Número do Ofício</label>
                            <input type="number" class="form-control" id="nu_oficio" name="nu_oficio"
                                   value="{{ registro.NU_OFICIO if edit_mode else (dados.nu_oficio if dados else '') }}">
                        </div>

                        <div class="mb-3">
                            <label for="dt_documento" class="form-label">Data do Documento</label>
                            <input type="date" class="form-control" id="dt_documento" name="dt_documento"
                                   value="{{ registro.DT_DOCUMENTO.strftime('%Y-%m-%d') if edit_mode and registro.DT_DOCUMENTO else (dados.dt_documento if dados else '') }}">
                        </div>

                        <!-- NOVO CAMPO: Número do Memorando -->
                        <div class="mb-3">
                            <label for="nu_memorando" class="form-label">Número do Memorando</label>
                            <input type="text" class="form-control" id="nu_memorando" name="nu_memorando"
                                   placeholder="Ex: 0132836"
                                   value="{{ registro.NU_MEMORANDO if edit_mode else (dados.nu_memorando if dados else '') }}">
                            <small class="text-muted">Formato numérico, ex: 0132836</small>
                        </div>

                        <!-- NOVO CAMPO: Processo SEI -->
                        <div class="mb-3">
                            <label for="nr_processo_sei" class="form-label">Processo SEI</label>
                            <input type="text" class="form-control" id="nr_processo_sei" name="nr_processo_sei"
                                   placeholder="Ex: 10034.013231/2025-14"
                                   value="{{ registro.NR_PROCESSO_SEI if edit_mode else (dados.nr_processo_sei if dados else '') }}">
                            <small class="text-muted">Formato: 10034.013231/2025-14</small>
                        </div>

                        <!-- Devedor (CAIXA ou EMGEA) -->
                        <div class="mb-3">
                            <label for="devedor" class="form-label">Devedor <span class="text-danger">*</span></label>
                            <select class="form-select" id="devedor" name="devedor" required>
                                <option value="">Selecione...</option>
                                {% for dev in devedores %}
                                <option value="{{ dev }}"
                                        {% if edit_mode and registro.DEVEDOR == dev %}selected
                                        {% elif dados and dados.devedor == dev %}selected{% endif %}>
                                    {{ dev }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">Selecione CAIXA ou EMGEA</small>
                        </div>

                        <!-- Valor da Falha -->
                        <div class="mb-3">
                            <label for="vr_falha" class="form-label">Valor da Falha <span class="text-danger">*</span></label>
                            <input type="number" step="0.01" class="form-control" id="vr_falha" name="vr_falha" required
                                   value="{{ registro.VR_FALHA if edit_mode else (dados.vr_falha if dados else '') }}">
                        </div>

                        <!-- Valor Real (Readonly, copia VR_FALHA) -->
                        <div class="mb-3">
                            <label for="vr_real" class="form-label">Valor Real</label>
                            <div class="input-group">
                                <span class="input-group-text" id="vr_real_simbolo">-</span>
                                <input type="text" class="form-control" id="vr_real" name="vr_real" readonly
                                       value="{{ registro.VR_REAL if edit_mode else '' }}">
                            </div>
                            <small class="text-muted">Copia VR_FALHA automaticamente (negativo para EMGEA)</small>
                        </div>

                        <!-- Valor ISS -->
                        <div class="mb-3">
                            <label for="vr_iss" class="form-label">Valor ISS</label>
                            <input type="number" step="0.01" class="form-control" id="vr_iss" name="vr_iss"
                                   value="{{ registro.VR_ISS if edit_mode else (dados.vr_iss if dados else '') }}">
                        </div>

                        <!-- Data de Pagamento -->
                        <div class="mb-3">
                            <label for="dt_pagto" class="form-label">Data de Pagamento</label>
                            <input type="date" class="form-control" id="dt_pagto" name="dt_pagto"
                                   value="{{ registro.DT_PAGTO.strftime('%Y-%m-%d') if edit_mode and registro.DT_PAGTO else (dados.dt_pagto if dados else '') }}">
                        </div>

                        <!-- Número do Ticket -->
                        <div class="mb-3">
                            <label for="nr_ticket" class="form-label">Número do Ticket</label>
                            <input type="number" class="form-control" id="nr_ticket" name="nr_ticket"
                                   value="{{ registro.NR_TICKET if edit_mode else (dados.nr_ticket if dados else '') }}">
                        </div>

                        <!-- Descrição do Documento -->
                        <div class="mb-3">
                            <label for="dsc_documento" class="form-label">Descrição do Documento</label>
                            <input type="text" class="form-control" id="dsc_documento" name="dsc_documento"
                                   value="{{ registro.DSC_DOCUMENTO if edit_mode else (dados.dsc_documento if dados else '') }}">
                        </div>
                    </div>
                </div>

                <!-- Relacionamentos -->
                <div class="card shadow mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Relacionamentos</h5>
                    </div>
                    <div class="card-body">
                        <!-- Ocorrência -->
                        <div class="mb-3">
                            <label for="id_ocorrencia" class="form-label">Ocorrência</label>
                            <select class="form-select" id="id_ocorrencia" name="id_ocorrencia">
                                <option value="">Selecione...</option>
                                {% for ocor in ocorrencias %}
                                <option value="{{ ocor.ID_OCORRENCIA }}"
                                        {% if edit_mode and registro.ID_OCORRENCIA == ocor.ID_OCORRENCIA %}selected{% endif %}>
                                    {{ ocor.DSC_OCORRENCIA }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Status -->
                        <div class="mb-3">
                            <label for="id_status" class="form-label">Status</label>
                            <select class="form-select" id="id_status" name="id_status">
                                <option value="">Selecione...</option>
                                {% for stat in status_list %}
                                <option value="{{ stat.ID_STATUS }}"
                                        {% if edit_mode and registro.ID_STATUS == stat.ID_STATUS %}selected{% endif %}>
                                    {{ stat.DSC_STATUS }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Carteira -->
                        <div class="mb-3">
                            <label for="id_carteira" class="form-label">Carteira</label>
                            <select class="form-select" id="id_carteira" name="id_carteira">
                                <option value="">Selecione...</option>
                                {% for cart in carteiras %}
                                <option value="{{ cart.ID_CARTEIRA }}"
                                        {% if edit_mode and registro.ID_CARTEIRA == cart.ID_CARTEIRA %}selected{% endif %}>
                                    {{ cart.DSC_CARTEIRA }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Coluna Direita -->
            <div class="col-md-6">
                <div class="card shadow mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Informações Adicionais</h5>
                    </div>
                    <div class="card-body">
                        <!-- Observação (Campo de Texto) -->
                        <div class="mb-3">
                            <label for="observacao_texto" class="form-label">Observação</label>
                            <textarea class="form-control" id="observacao_texto" name="observacao_texto" rows="3"
                                      placeholder="Digite a observação...">{{ observacao_atual if edit_mode else '' }}</textarea>
                            <small class="text-muted">Será salvo na tabela de observações</small>
                        </div>

                        <!-- Especificação (Campo de Texto) -->
                        <div class="mb-3">
                            <label for="especificacao_texto" class="form-label">Especificação</label>
                            <textarea class="form-control" id="especificacao_texto" name="especificacao_texto" rows="3"
                                      placeholder="Digite a especificação...">{{ especificacao_atual if edit_mode else '' }}</textarea>
                            <small class="text-muted">Será salvo na tabela de especificações</small>
                        </div>

                        <!-- IC Condenação -->
                        <div class="mb-3">
                            <label for="ic_condenacao" class="form-label">IC Condenação</label>
                            <select class="form-select" id="ic_condenacao" name="ic_condenacao">
                                <option value="">Não definido</option>
                                <option value="1" {% if edit_mode and registro.IC_CONDENACAO %}selected{% endif %}>Sim</option>
                                <option value="0" {% if edit_mode and registro.IC_CONDENACAO == False %}selected{% endif %}>Não</option>
                            </select>
                        </div>

                        {% if duplicidade %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Atenção:</strong> Registro duplicado detectado!
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="confirmar_duplicidade" name="confirmar_duplicidade" value="1">
                                <label class="form-check-label" for="confirmar_duplicidade">
                                    Confirmar inclusão/alteração mesmo com duplicidade
                                </label>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Botões de Ação -->
        <div class="card shadow">
            <div class="card-body text-center">
                <button type="submit" class="btn btn-success btn-lg me-2">
                    <i class="fas fa-save me-2"></i>
                    {% if edit_mode %}Atualizar{% else %}Salvar{% endif %}
                </button>
                <a href="{{ url_for('caixa_emgea.index') }}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-times me-2"></i>Cancelar
                </a>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const vrFalhaInput = document.getElementById('vr_falha');
    const vrRealInput = document.getElementById('vr_real');
    const devedorSelect = document.getElementById('devedor');
    const vrRealSimbolo = document.getElementById('vr_real_simbolo');

    function atualizarVrReal() {
        const vrFalha = parseFloat(vrFalhaInput.value) || 0;
        const devedor = devedorSelect.value;

        if (vrFalha > 0 && devedor) {
            if (devedor === 'EMGEA') {
                // EMGEA = Negativo
                vrRealInput.value = (-Math.abs(vrFalha)).toFixed(2);
                vrRealInput.style.color = '#dc3545';
                vrRealInput.style.fontWeight = 'bold';
                vrRealSimbolo.textContent = '-';
                vrRealSimbolo.style.backgroundColor = '#dc3545';
                vrRealSimbolo.style.color = 'white';
            } else {
                // CAIXA = Positivo
                vrRealInput.value = Math.abs(vrFalha).toFixed(2);
                vrRealInput.style.color = '#000';
                vrRealInput.style.fontWeight = 'normal';
                vrRealSimbolo.textContent = '-';
                vrRealSimbolo.style.backgroundColor = '#6c757d';
                vrRealSimbolo.style.color = 'white';
            }
        } else {
            vrRealInput.value = '';
            vrRealSimbolo.textContent = '-';
            vrRealSimbolo.style.backgroundColor = '#6c757d';
            vrRealSimbolo.style.color = 'white';
        }
    }

    // Eventos para atualizar VR_REAL automaticamente
    vrFalhaInput.addEventListener('input', atualizarVrReal);
    vrFalhaInput.addEventListener('change', atualizarVrReal);
    devedorSelect.addEventListener('change', atualizarVrReal);

    // Executar ao carregar a página (modo edição)
    atualizarVrReal();

    // Validação do formulário
    document.getElementById('formCaixaEmgea').addEventListener('submit', function(e) {
        const devedor = devedorSelect.value;
        const vrFalha = parseFloat(vrFalhaInput.value) || 0;

        if (!devedor) {
            e.preventDefault();
            alert('Por favor, selecione o Devedor (CAIXA ou EMGEA).');
            devedorSelect.focus();
            return false;
        }

        if (vrFalha <= 0) {
            e.preventDefault();
            alert('Por favor, informe um Valor da Falha válido.');
            vrFalhaInput.focus();
            return false;
        }
    });
});
</script>

<style>
.card {
    border-radius: 10px;
}

.card-header {
    border-radius: 10px 10px 0 0 !important;
}

.form-label {
    font-weight: 600;
}

#vr_real_simbolo {
    font-weight: bold;
    font-size: 1.2em;
    min-width: 45px;
    justify-content: center;
}

.alert-warning {
    border-left: 4px solid #ffc107;
}
</style>
{% endblock %}