{% extends "base.html" %}

{% block content %}
<div class="container-fluid fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold">
            <i class="fas fa-money-check-alt me-2"></i>Inclusão de Pendências
        </h1>
        <a href="{{ url_for('caixa_emgea.novo') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Novo Registro
        </a>
    </div>

    {% if registros %}
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Registros Cadastrados</h5>
        </div>
        <div class="card-body">
            <!-- Estrutura de Filtros -->
            <div class="row mb-3" id="filters-row">
                <div class="col-md-3">
                    <label for="filterOficio" class="form-label">Nº Ofício</label>
                    <input type="text" class="form-control form-control-sm" id="filterOficio" placeholder="Filtrar por Nº Ofício">
                </div>
                <div class="col-md-3">
                    <label for="filterContrato" class="form-label">Nº Contrato</label>
                    <input type="text" class="form-control form-control-sm" id="filterContrato" placeholder="Filtrar por Nº Contrato">
                </div>
                <div class="col-md-3">
                    <label for="filterOcorrencia" class="form-label">Ocorrência</label>
                    <input type="text" class="form-control form-control-sm" id="filterOcorrencia" placeholder="Filtrar por Ocorrência">
                </div>
                <div class="col-md-3">
                    <label for="filterValorFalha" class="form-label">Valor Falha</label>
                    <input type="text" class="form-control form-control-sm" id="filterValorFalha" placeholder="Filtrar por Valor Falha">
                </div>
            </div>
            <!-- Fim da Estrutura de Filtros -->

            <!-- Div para a barra de rolagem vertical -->
            <div class="table-scroll-container" style="max-height: 400px; overflow-y: auto;">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="registrosTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nº Ofício</th>
                                <th>Nº Contrato</th>
                                <th>Ocorrência</th>
                                <th>Status</th>
                                <th>Valor Falha</th>
                                <th>Valor Real</th>
                                <th>Devedor</th>
                                <th>Carteira</th>
                                <th>Usuário</th>
                                <th width="120">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for registro in registros %}
                            <tr data-oficio="{{ registro.NU_OFICIO or '' }}"
                                data-contrato="{{ registro.NU_CONTRATO or '' }}"
                                data-ocorrencia="{{ ocorrencias.get(registro.ID_OCORRENCIA, 'N/A') if registro.ID_OCORRENCIA else '' }}"
                                data-valorfalha="{{ registro.VR_FALHA or '' }}">
                                <td>{{ registro.ID_DETALHAMENTO }}</td>
                                <td>{{ registro.NU_OFICIO or '-' }}</td>
                                <td>{{ registro.NU_CONTRATO or '-' }}</td>
                                <td>
                                    {% if registro.ID_OCORRENCIA %}
                                        {{ ocorrencias.get(registro.ID_OCORRENCIA, 'N/A') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if registro.ID_STATUS %}
                                        <span class="badge bg-info">
                                            {{ status_list.get(registro.ID_STATUS, 'N/A') }}
                                        </span>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if registro.VR_FALHA %}
                                        R$ {{ "{:,.2f}".format(registro.VR_FALHA).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if registro.VR_REAL %}
                                        R$ {{ "{:,.2f}".format(registro.VR_REAL).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {{ registro.DEVEDOR or '-' }}
                                </td>
                                <td>
                                    {% if registro.ID_CARTEIRA %}
                                        {{ carteiras.get(registro.ID_CARTEIRA, 'N/A') }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ registro.USUARIO_CRIACAO or '-' }}
                                    </small>
                                </td>
                                <td>
                                    <a href="{{ url_for('caixa_emgea.editar', id=registro.ID_DETALHAMENTO) }}"
                                       class="btn btn-sm btn-warning" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-sm btn-danger"
                                            onclick="confirmarExclusao({{ registro.ID_DETALHAMENTO }})" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Fim da Div para a barra de rolagem vertical -->

        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        Nenhum registro encontrado.
        <a href="{{ url_for('caixa_emgea.novo') }}">Clique aqui</a> para adicionar o primeiro registro.
    </div>
    {% endif %}
</div>

<script>
function confirmarExclusao(id) {
    if (confirm('Tem certeza que deseja excluir este registro?')) {
        fetch(`{{ url_for('caixa_emgea.excluir', id=0) }}`.replace('0', id), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Erro: ' + data.message);
                console.error('Erro:', data.message);
            }
        })
        .catch(error => {
            alert('Erro ao excluir registro');
            console.error('Erro:', error);
        });
    }
}

// Lógica de Filtro
document.addEventListener('DOMContentLoaded', function() {
    const filters = document.querySelectorAll('#filters-row input');
    const tableBody = document.querySelector('#registrosTable tbody');
    const rows = tableBody ? tableBody.querySelectorAll('tr') : [];

    function applyFilters() {
        const filterOficio = document.getElementById('filterOficio').value.toLowerCase().trim();
        const filterContrato = document.getElementById('filterContrato').value.toLowerCase().trim();
        const filterOcorrencia = document.getElementById('filterOcorrencia').value.toLowerCase().trim();
        const filterValorFalha = document.getElementById('filterValorFalha').value.toLowerCase().trim();

        rows.forEach(row => {
            const oficio = row.getAttribute('data-oficio').toLowerCase();
            const contrato = row.getAttribute('data-contrato').toLowerCase();
            const ocorrencia = row.getAttribute('data-ocorrencia').toLowerCase();
            const valorFalha = row.getAttribute('data-valorfalha').toLowerCase();

            const matchOficio = oficio.includes(filterOficio);
            const matchContrato = contrato.includes(filterContrato);
            const matchOcorrencia = ocorrencia.includes(filterOcorrencia);
            const matchValorFalha = valorFalha.includes(filterValorFalha);

            if (matchOficio && matchContrato && matchOcorrencia && matchValorFalha) {
                row.style.display = ''; // Mostra a linha
            } else {
                row.style.display = 'none'; // Esconde a linha
            }
        });
    }

    filters.forEach(input => {
        input.addEventListener('keyup', applyFilters);
        input.addEventListener('change', applyFilters); // Para caso de inputs de seleção/data
    });
});
</script>
{% endblock %}
