{% extends "base.html" %}

{% block content %}
<div class="editais-container fade-in">
    <a href="{{ url_for('main.geinc_index') }}" class="btn-back">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>

    <div class="page-title-bar">
        <h1>Depósitos Judiciais</h1>
        <p class="text-muted">Sistema de gestão e controle de depósitos judiciais da SUFIN</p>
    </div>

    <!-- Cards de ações -->
    <div class="row g-4 mt-4">
        <div class="col-md-4">
            <div class="card shadow h-100">
                <div class="card-body text-center p-5">
                    <div class="mb-4">
                        <i class="fas fa-plus-circle fa-4x text-primary"></i>
                    </div>
                    <h3 class="card-title">Inclusão</h3>
                    <p class="text-muted mb-4">
                        Incluir novos registros de depósitos judiciais no sistema
                    </p>
                    <a href="{{ url_for('depositos_judiciais.inclusao') }}" class="btn btn-primary">
                        <i class="fas fa-arrow-right me-2"></i> Acessar Inclusão
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow h-100">
                <div class="card-body text-center p-5">
                    <div class="mb-4">
                        <i class="fas fa-edit fa-4x text-warning"></i>
                    </div>
                    <h3 class="card-title">Edição</h3>
                    <p class="text-muted mb-4">
                        Editar e atualizar registros existentes de depósitos judiciais
                    </p>
                    <a href="{{ url_for('depositos_judiciais.edicao') }}" class="btn btn-warning">
                        <i class="fas fa-arrow-right me-2"></i> Acessar Edição
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow h-100">
                <div class="card-body text-center p-5">
                    <div class="mb-4">
                        <i class="fas fa-sync-alt fa-4x text-success"></i>
                    </div>
                    <h3 class="card-title">Atualizar Relatórios</h3>
                    <p class="text-muted mb-4">
                        Executar scripts para atualizar relatórios e comparativos SISCOR
                    </p>
                    <button id="btnExecutarScripts" class="btn btn-success" onclick="executarScripts()">
                        <i class="fas fa-play me-2"></i> Executar Scripts
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Estatísticas -->
    <div class="row g-4 mt-5">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Informações do Sistema
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-0">
                        Este sistema permite o gerenciamento completo dos depósitos judiciais da SUFIN,
                        incluindo o controle de lançamentos, valores de rateio, memorandos e
                        acompanhamento de áreas e centros de resultado.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Loading -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <h5>Executando Scripts de Relatório</h5>
                <p class="text-muted mb-0">Por favor, aguarde enquanto os scripts são processados...</p>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15) !important;
    }

    .card-title {
        color: var(--primary-color);
        font-weight: 600;
    }
</style>

<script>
function executarScripts() {
    if (!confirm('Deseja executar os scripts de atualização de relatórios?\n\nEste processo pode demorar alguns minutos.')) {
        return;
    }

    // Mostrar modal de loading
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();

    // Desabilitar botão
    const btnExecutar = document.getElementById('btnExecutarScripts');
    btnExecutar.disabled = true;

    // Fazer a requisição
    fetch('{{ url_for("depositos_judiciais.executar_scripts_relatorio") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrf_token') // Se estiver usando CSRF
        }
    })
    .then(response => response.json())
    .then(data => {
        loadingModal.hide();

        if (data.success) {
            // Sucesso
            alert('Scripts executados com sucesso!\n\n' +
                  'Tabelas atualizadas:\n' +
                  '- DPJ_TB007_DJ_RELATORIO\n' +
                  '- DPJ_TB008_COMPARATIVO_SISCOR\n' +
                  '- DPJ_TB009_ALERTAS_SUFIN\n\n' +
                  'Tempo de execução: ' + data.tempo_execucao + ' segundos');
        } else {
            // Erro
            alert('Erro ao executar scripts:\n\n' + data.erro);
        }
    })
    .catch(error => {
        loadingModal.hide();
        alert('Erro ao comunicar com o servidor:\n\n' + error.message);
    })
    .finally(() => {
        btnExecutar.disabled = false;
    });
}

// Função para pegar cookie CSRF se necessário
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}