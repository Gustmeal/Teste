{% extends "base.html" %}

{% block content %}
<div class="editais-container fade-in">
    <a href="{{ url_for('depositos_judiciais.edicao') }}" class="btn-back">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>

    <div class="page-title-bar">
        <h1>Editar Depósito Judicial</h1>
        <p class="text-muted">Nº Linha: {{ deposito.NU_LINHA }} | Processo: {{ nr_processo or 'Não informado' }}</p>
    </div>

    <div class="alert alert-warning" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>Atenção:</strong> Ao alterar a carteira para uma opção diferente de "Institucional",
        será criada automaticamente uma linha de estorno com valor negativo.
    </div>

    <div class="card shadow">
        <div class="card-body">
            <form method="POST" id="formEdicao" action="{{ url_for('depositos_judiciais.editar', nu_linha=deposito.NU_LINHA) }}">
                <div class="row g-3">
                    <!-- Primeira Linha -->
                    <div class="col-md-4">
                        <label for="lancamento_rm" class="form-label">Lançamento RM <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="lancamento_rm" name="lancamento_rm"
                               maxlength="15" required value="{{ deposito.LANCAMENTO_RM or '' }}">
                    </div>

                    <div class="col-md-4">
                        <label for="dt_lancamento_dj" class="form-label">Data Lançamento DJ <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="dt_lancamento_dj" name="dt_lancamento_dj"
                               required value="{{ deposito.DT_LANCAMENTO_DJ.strftime('%Y-%m-%d') if deposito.DT_LANCAMENTO_DJ else '' }}">
                    </div>

                    <div class="col-md-4">
                        <label for="vr_rateio" class="form-label">Valor Rateio <span class="text-danger">*</span></label>
                        <input type="text" class="form-control money" id="vr_rateio" name="vr_rateio"
                               required value="{{ '{:.2f}'.format(deposito.VR_RATEIO).replace('.', ',') if deposito.VR_RATEIO else '' }}">
                    </div>

                    <!-- Segunda Linha com NR_PROCESSO -->
                    <div class="col-md-4">
                        <label for="nr_processo" class="form-label">Número do Processo</label>
                        <input type="text" class="form-control" id="nr_processo" name="nr_processo"
                               maxlength="100" value="{{ nr_processo or '' }}"
                               placeholder="Ex: 0000000-00.0000.0.00.0000">
                    </div>

                    <div class="col-md-4">
                        <label for="memo_sufin" class="form-label">Memo SUFIN</label>
                        <input type="text" class="form-control" id="memo_sufin" name="memo_sufin"
                               maxlength="15" value="{{ deposito.MEMO_SUFIN or '' }}">
                    </div>

                    <div class="col-md-4">
                        <label for="dt_memo" class="form-label">Data Memo</label>
                        <input type="date" class="form-control" id="dt_memo" name="dt_memo"
                               value="{{ deposito.DT_MEMO.strftime('%Y-%m-%d') if deposito.DT_MEMO else '' }}">
                        <small class="text-muted">Se preenchido, marca como identificado</small>
                    </div>

                    <!-- Terceira Linha -->
                    <div class="col-md-4">
                        <label for="dt_identificacao" class="form-label">Data Identificação</label>
                        <input type="date" class="form-control" id="dt_identificacao" name="dt_identificacao"
                               value="{{ deposito.DT_IDENTIFICACAO.strftime('%Y-%m-%d') if deposito.DT_IDENTIFICACAO else '' }}">
                    </div>

                    <div class="col-md-4">
                        <label for="id_area" class="form-label">Área <span class="text-danger">*</span></label>
                        <select class="form-select" id="id_area" name="id_area" required>
                            <option value="">Selecione uma área</option>
                            {% for area in areas %}
                            <option value="{{ area.ID_AREA }}"
                                    {% if deposito.ID_AREA == area.ID_AREA %}selected{% endif %}>
                                {{ area.NO_AREA }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="id_centro" class="form-label">Carteira <span class="text-danger">*</span></label>
                        <select class="form-select" id="id_centro" name="id_centro" required>
                            <option value="">Selecione uma carteira</option>
                            {% for centro in centros %}
                            <option value="{{ centro.ID_CENTRO }}"
                                    {% if deposito.ID_CENTRO == centro.ID_CENTRO %}selected{% endif %}>
                                {{ centro.NO_CARTEIRA }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Quarta Linha -->
                    <div class="col-md-4">
                        <label for="dt_ajuste_rm" class="form-label">Data Ajuste RM</label>
                        <input type="date" class="form-control" id="dt_ajuste_rm" name="dt_ajuste_rm"
                               value="{{ deposito.DT_AJUSTE_RM.strftime('%Y-%m-%d') if deposito.DT_AJUSTE_RM else '' }}">
                    </div>

                    <div class="col-md-4">
                        <label for="nu_contrato" class="form-label">Número Contrato</label>
                        <input type="number" class="form-control" id="nu_contrato" name="nu_contrato"
                               value="{{ deposito.NU_CONTRATO or '' }}">
                    </div>

                    <div class="col-md-4">
                        <label for="evento_contabil_anterior" class="form-label">Evento Contábil Anterior</label>
                        <input type="number" class="form-control" id="evento_contabil_anterior"
                               name="evento_contabil_anterior" value="{{ deposito.EVENTO_CONTABIL_ANTERIOR or '' }}">
                    </div>

                    <!-- Quinta Linha -->
                    <div class="col-md-4">
                        <label for="evento_contabil_atual" class="form-label">Evento Contábil Atual</label>
                        <input type="number" class="form-control" id="evento_contabil_atual"
                               name="evento_contabil_atual" value="{{ deposito.EVENTO_CONTABIL_ATUAL or '' }}">
                    </div>

                    <div class="col-md-4">
                        <label for="dt_siscor" class="form-label">Data SISCOR</label>
                        <input type="date" class="form-control" id="dt_siscor" name="dt_siscor"
                               value="{{ deposito.DT_SISCOR.strftime('%Y-%m-%d') if deposito.DT_SISCOR else '' }}">
                    </div>

                    <div class="col-md-4">
                        <!-- Espaço vazio para alinhamento -->
                    </div>

                    <!-- Observação -->
                    <div class="col-md-12">
                        <label for="obs" class="form-label">Observação</label>
                        <textarea class="form-control" id="obs" name="obs" rows="3"
                                  maxlength="70">{{ deposito.OBS or '' }}</textarea>
                    </div>
                </div>

                <!-- Botões -->
                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i> Salvar Alterações
                    </button>
                    <a href="{{ url_for('depositos_judiciais.edicao') }}" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para formatar valor monetário
    function formatarMoeda(valor) {
        // Remove tudo que não é número
        valor = valor.replace(/\D/g, '');

        // Converte para número e divide por 100
        valor = (parseInt(valor) / 100).toFixed(2);

        // Separa parte inteira e decimal
        let partes = valor.split('.');

        // Adiciona pontos como separador de milhar
        partes[0] = partes[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');

        // Junta com vírgula como separador decimal
        return partes.join(',');
    }

    // Função para limpar formatação e deixar só números
    function limparFormatacao(valor) {
        // Remove pontos e troca vírgula por ponto
        return valor.replace(/\./g, '').replace(',', '.');
    }

    // Aplica máscara nos campos monetários
    const moneyInputs = document.querySelectorAll('.money');
    moneyInputs.forEach(input => {
        // Formata valor inicial se existir
        if (input.value) {
            // Limpa formatação atual e reformata
            let valorLimpo = input.value.replace(/\./g, '').replace(',', '');
            if (valorLimpo) {
                input.value = formatarMoeda(valorLimpo);
            }
        }

        // Adiciona evento de formatação
        input.addEventListener('input', function(e) {
            let position = e.target.selectionStart;
            let valor = e.target.value;

            // Formata o valor
            e.target.value = formatarMoeda(valor);

            // Tenta manter a posição do cursor
            e.target.setSelectionRange(position, position);
        });

        // Adiciona evento para quando o campo perde o foco
        input.addEventListener('blur', function(e) {
            // Se o campo estiver vazio, coloca 0,00
            if (!e.target.value) {
                e.target.value = '0,00';
            }
        });
    });

    // Validação do formulário - SEM POPUP DE CONFIRMAÇÃO
    document.getElementById('formEdicao').addEventListener('submit', function(e) {
        const vrRateio = document.getElementById('vr_rateio').value;

        // Verifica se tem valor
        if (!vrRateio) {
            e.preventDefault();
            alert('Por favor, informe um valor de rateio.');
            return false;
        }

        // Converte para número para validar
        const valorNumerico = parseFloat(limparFormatacao(vrRateio));
        if (isNaN(valorNumerico) || valorNumerico <= 0) {
            e.preventDefault();
            alert('Por favor, informe um valor de rateio válido.');
            return false;
        }
    });
});
</script>

<style>
.btn-back {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    text-decoration: none;
    color: #495057;
    transition: color 0.3s;
}

.btn-back:hover {
    color: #007bff;
}

.page-title-bar {
    margin-bottom: 2rem;
}

.page-title-bar h1 {
    color: #333;
    font-weight: 300;
    margin-bottom: 0.5rem;
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.text-danger {
    color: #dc3545 !important;
}

.text-muted {
    font-size: 0.875rem;
}

.card {
    border: none;
    border-radius: 0.5rem;
}

.card-body {
    padding: 2rem;
}

.btn {
    padding: 0.5rem 1.5rem;
    font-weight: 500;
    border-radius: 0.375rem;
    transition: all 0.3s;
}

.btn-primary {
    background-color: #007bff;
    border-color: #007bff;
}

.btn-primary:hover {
    background-color: #0056b3;
    border-color: #004085;
}

.btn-secondary {
    background-color: #6c757d;
    border-color: #6c757d;
}

.btn-secondary:hover {
    background-color: #5a6268;
    border-color: #545b62;
}

.form-control:focus,
.form-select:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

textarea.form-control {
    resize: vertical;
}

.alert {
    border: none;
    border-radius: 0.5rem;
}

.alert-warning {
    background-color: #fff3cd;
    color: #856404;
}

.alert i {
    font-size: 1.2rem;
}
</style>
{% endblock %}