{% extends "base.html" %}

{% block title %}Lista de Contratos - Cobrado Vs Repassado{% endblock %}

{% block head %}
<style>
    /* Estilo para linhas clicáveis */
    .clickable-row {
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .clickable-row:hover {
        background-color: rgba(108, 99, 255, 0.1) !important;
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .clickable-row:active {
        transform: translateX(3px);
    }

    /* Impedir que o botão dispare o click da linha */
    .clickable-row .btn {
        position: relative;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2">
                <a href="{{ url_for('cobrado_repassado.index') }}" class="text-decoration-none">
                    <i class="fas fa-arrow-left text-secondary me-2"></i>
                </a>
                Lista de Contratos - Cobrado Vs Repassado
            </h1>
        </div>
    </div>

    <!-- Filtro por Carteira -->
    <div class="row mb-3">
        <div class="col-md-6">
            <form method="GET" action="{{ url_for('cobrado_repassado.listar_contratos') }}">
                <div class="input-group">
                    <select class="form-select" name="carteira" id="carteira">
                        <option value="">Todas as Carteiras</option>
                        {% for carteira in carteiras_unicas %}
                        <option value="{{ carteira }}" {% if carteira == carteira_selecionada %}selected{% endif %}>
                            {{ carteira }}
                        </option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-primary" type="submit">
                        <i class="fas fa-filter me-2"></i>Filtrar
                    </button>
                </div>
            </form>
        </div>
        <div class="col-md-6 text-end">
            <div class="alert alert-info d-inline-block mb-0 py-2">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Dica:</strong> Clique em qualquer linha para consultar o contrato
            </div>
        </div>
    </div>

    <!-- Tabela de Contratos -->
    <div class="row">
        <div class="col">
            <div class="card shadow">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-file-contract me-2"></i>
                        Contratos com Valores Cobrados ({{ contratos|length }} registros)
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if contratos %}
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Nº Contrato</th>
                                        <th>Carteira</th>
                                        <th>Ocorrência</th>
                                        <th>Status</th>
                                        <th>Valor Cobrado</th>
                                        <th>Nº Ofício</th>
                                        <th>Data Ofício</th>
                                        <th>Data Pagto</th>
                                        <th>Nº Processo</th>
                                        <th>Vinculado</th>
                                        <th width="150">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for contrato in contratos %}
                                    <tr class="clickable-row" data-contrato="{{ contrato.PenDetalhamento.NU_CONTRATO }}">
                                        <td>{{ contrato.PenDetalhamento.ID_DETALHAMENTO }}</td>
                                        <td>
                                            <strong>{{ contrato.PenDetalhamento.NU_CONTRATO }}</strong>
                                        </td>
                                        <td>{{ contrato.DSC_CARTEIRA or 'N/A' }}</td>
                                        <td>{{ contrato.DSC_OCORRENCIA or 'N/A' }}</td>
                                        <td>
                                            <span class="badge bg-info">{{ contrato.DSC_STATUS or 'N/A' }}</span>
                                        </td>
                                        <td>
                                            <strong class="text-success">
                                                R$ {{ '{:,.2f}'.format(contrato.PenDetalhamento.VR_FALHA or 0).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                                            </strong>
                                        </td>
                                        <td>{{ contrato.PenDetalhamento.NU_OFICIO or 'N/A' }}</td>
                                        <td>
                                            {% if contrato.DT_OFICIO %}
                                                {{ contrato.DT_OFICIO.strftime('%d/%m/%Y') if contrato.DT_OFICIO.__class__.__name__ == 'date' else 'N/A' }}
                                            {% else %}
                                                N/A
                                            {% endif %}
                                        </td>
                                        <td>{{ contrato.PenDetalhamento.DT_PAGTO.strftime('%d/%m/%Y') if contrato.PenDetalhamento.DT_PAGTO else 'N/A' }}</td>
                                        <td>{{ contrato.PenDetalhamento.NR_PROCESSO or 'N/A' }}</td>
                                        <td class="text-center">
                                            {% if contrato.PenDetalhamento.NU_CONTRATO in contratos_com_vinculacao %}
                                                <i class="fas fa-check-circle text-success" title="Possui vinculação"></i>
                                            {% else %}
                                                <i class="fas fa-times-circle text-muted" title="Sem vinculação"></i>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-primary btn-consultar" data-contrato="{{ contrato.PenDetalhamento.NU_CONTRATO }}">
                                                <i class="fas fa-search me-1"></i>Consultar
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0 m-3">
                            <i class="fas fa-info-circle me-2"></i>
                            Nenhum contrato encontrado com valores cobrados.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para consultar contrato
    function consultarContrato(nuContrato) {
        // Criar um formulário temporário e submeter
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("cobrado_repassado.consultar") }}';

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'nu_contrato';
        input.value = nuContrato;

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }

    // Tornar as linhas clicáveis
    document.querySelectorAll('.clickable-row').forEach(row => {
        row.addEventListener('click', function(e) {
            // Não fazer nada se clicou no botão
            if (e.target.closest('.btn-consultar')) {
                return;
            }

            const nuContrato = this.getAttribute('data-contrato');
            consultarContrato(nuContrato);
        });
    });

    // Botões de consulta
    document.querySelectorAll('.btn-consultar').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation(); // Impedir que o click da linha seja disparado
            const nuContrato = this.getAttribute('data-contrato');
            consultarContrato(nuContrato);
        });
    });
});
</script>
{% endblock %}