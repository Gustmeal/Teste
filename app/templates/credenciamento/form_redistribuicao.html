{% extends "base.html" %}

{% block content %}
<style>
    .redistribuicao-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .card-redistribuicao {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 30px;
    }

    .empresa-item {
        padding: 15px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .empresa-item:hover {
        border-color: #dc3545;
        background-color: #f8f9fa;
    }

    .empresa-item.selected {
        border-color: #dc3545;
        background-color: #fff5f5;
    }

    .empresa-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .sd-info {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .preview-section {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }

    /* Estilos para a tabela completa */
    .tabela-redistribuicao {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }

    .tabela-redistribuicao th,
    .tabela-redistribuicao td {
        border: 1px solid #dee2e6;
        padding: 5px;
        text-align: center;
    }

    .tabela-redistribuicao th {
        background-color: #f8f9fa;
        font-weight: bold;
    }

    .col-empresa {
        text-align: left !important;
        min-width: 200px;
    }

    .valor-monetario {
        text-align: right !important;
        white-space: nowrap;
        font-family: monospace;
    }

    .linha-total {
        font-weight: bold;
        background-color: #e9ecef;
    }

    .linha-meta-estendida {
        background-color: #d1ecf1;
        font-weight: bold;
    }

    .empresa-descredenciada {
        background-color: #f8d7da;
    }

    .tabela-container {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
        overflow-x: auto;
    }
</style>

<div class="redistribuicao-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="fas fa-exchange-alt me-2"></i>Redistribuição de Metas
        </h1>
        <a href="{{ url_for('meta.lista_metas') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar
        </a>
    </div>

    <div class="card-redistribuicao">
        <form id="formRedistribuicao">
            <!-- Seleção de Edital e Período -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <label for="edital_id" class="form-label">Edital <span class="text-danger">*</span></label>
                    <select class="form-select" id="edital_id" name="edital_id" required>
                        <option value="">Selecione um edital...</option>
                        {% for edital in editais %}
                        <option value="{{ edital.ID }}">
                            {{ edital.NU_EDITAL }}/{{ edital.ANO }} - {{ edital.DESCRICAO }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6">
                    <label for="periodo_id" class="form-label">Período <span class="text-danger">*</span></label>
                    <select class="form-select" id="periodo_id" name="periodo_id" required>
                        <option value="">Selecione um período...</option>
                        {% for periodo in periodos %}
                        <option value="{{ periodo.ID }}">
                            Período {{ periodo.ID_PERIODO }} -
                            {{ periodo.DT_INICIO.strftime('%d/%m/%Y') }} a
                            {{ periodo.DT_FIM.strftime('%d/%m/%Y') }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Data de Descredenciamento e Incremento -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <label for="data_descredenciamento" class="form-label">
                        Data de Redistribuição <span class="text-danger">*</span>
                    </label>
                    <input type="date" class="form-control" id="data_descredenciamento"
                           name="data_descredenciamento" required>
                    <div class="form-text">Data em que as metas serão redistribuídas</div>
                </div>

                <div class="col-md-6">
                    <label for="incremento_meta" class="form-label">
                        Incremento na Meta
                    </label>
                    <input type="number" class="form-control" id="incremento_meta"
                           name="incremento_meta" step="0.01" value="1.00" required>
                    <div class="form-text">Fator de incremento (1.00 = sem incremento)</div>
                </div>
            </div>

            <!-- Seleção de Empresa -->
            <div class="mb-4">
                <label class="form-label">
                    Selecione a Empresa Descredenciada <span class="text-danger">*</span>
                </label>
                <div class="form-text mb-2">
                    <i class="fas fa-info-circle"></i>
                    Apenas empresas com status "DESCREDENCIADA NO PERÍODO" que ainda não tiveram suas metas redistribuídas
                </div>
                <div id="empresasContainer" class="border rounded p-3" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center text-muted p-4">
                        <i class="fas fa-building fa-3x mb-3"></i>
                        <p>Selecione um edital e período para visualizar as empresas</p>
                    </div>
                </div>
            </div>

            <!-- Preview do Cálculo -->
            <div id="previewSection" class="preview-section" style="display: none;">
                <h5 class="mb-3">
                    <i class="fas fa-calculator me-2"></i>Prévia da Redistribuição
                </h5>
                <div id="previewContent">
                    <!-- Conteúdo será inserido dinamicamente -->
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="d-flex justify-content-end gap-3 mt-4">
                <button type="button" class="btn btn-outline-secondary" id="btnLimpar">
                    <i class="fas fa-eraser me-2"></i>Limpar
                </button>
                <button type="button" class="btn btn-primary" id="btnCalcular" disabled>
                    <i class="fas fa-calculator me-2"></i>Calcular Redistribuição
                </button>
            </div>
        </form>
    </div>

    <!-- Modal de Resultado -->
    <div class="modal fade" id="modalResultado" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-lg-down modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle me-2"></i>Resultado da Redistribuição
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalResultadoContent" style="max-height: 80vh; overflow-y: auto;">
                    <!-- Conteúdo será inserido dinamicamente -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" id="btnConfirmarSalvar">
                        <i class="fas fa-save me-2"></i>Confirmar e Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const editalSelect = document.getElementById('edital_id');
    const periodoSelect = document.getElementById('periodo_id');
    const dataDescred = document.getElementById('data_descredenciamento');
    const incrementoInput = document.getElementById('incremento_meta');
    const empresasContainer = document.getElementById('empresasContainer');
    const btnCalcular = document.getElementById('btnCalcular');
    const btnLimpar = document.getElementById('btnLimpar');
    const previewSection = document.getElementById('previewSection');
    const modalResultado = new bootstrap.Modal(document.getElementById('modalResultado'));

    let empresaSelecionada = null;
    let resultadoCalculado = null;

    // Carregar empresas quando edital e período forem selecionados
    function carregarEmpresas() {
        const editalId = editalSelect.value;
        const periodoId = periodoSelect.value;

        if (!editalId || !periodoId) {
            empresasContainer.innerHTML = `
                <div class="text-center text-muted p-4">
                    <i class="fas fa-building fa-3x mb-3"></i>
                    <p>Selecione um edital e período para visualizar as empresas</p>
                </div>
            `;
            return;
        }

        empresasContainer.innerHTML = `
            <div class="text-center p-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
            </div>
        `;

        fetch(`/credenciamento/metas/buscar-empresas-ativas?edital_id=${editalId}&periodo_id=${periodoId}`)
            .then(response => response.json())
            .then(data => {
                if (data.sucesso) {
                    exibirEmpresas(data.empresas);
                } else {
                    showToast('Erro ao carregar empresas: ' + data.erro, 'danger');
                }
            })
            .catch(error => {
                showToast('Erro ao carregar empresas: ' + error, 'danger');
            });
    }

    // Exibir empresas disponíveis
    function exibirEmpresas(empresas) {
        if (empresas.length === 0) {
            empresasContainer.innerHTML = `
                <div class="text-center text-muted p-4">
                    <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                    <p>Nenhuma empresa descredenciada encontrada</p>
                    <small>Todas as empresas descredenciadas já tiveram suas metas redistribuídas</small>
                </div>
            `;
            return;
        }

        let html = '';
        empresas.forEach(empresa => {
            html += `
                <div class="empresa-item" data-empresa-id="${empresa.id_empresa}">
                    <div class="empresa-info">
                        <div>
                            <h6 class="mb-1">${empresa.nome_empresa}</h6>
                            <div class="sd-info">
                                <span>SD: ${formatarMoeda(empresa.saldo_devedor)}</span>
                                <span class="ms-3">Percentual: ${empresa.percentual.toFixed(8)}%</span>
                            </div>
                        </div>
                        <div>
                            <span class="badge bg-danger">DESCREDENCIADA NO PERÍODO</span>
                        </div>
                    </div>
                </div>
            `;
        });

        empresasContainer.innerHTML = html;

        // Adicionar eventos de clique
        document.querySelectorAll('.empresa-item').forEach(item => {
            item.addEventListener('click', function() {
                // Remover seleção anterior
                document.querySelectorAll('.empresa-item').forEach(el => {
                    el.classList.remove('selected');
                });

                // Adicionar seleção atual
                this.classList.add('selected');

                const empresaId = this.dataset.empresaId;
                empresaSelecionada = empresas.find(e => e.id_empresa == empresaId);

                // Habilitar botão calcular
                btnCalcular.disabled = false;

                // Atualizar preview
                atualizarPreview();
            });
        });
    }

    // Atualizar preview
    function atualizarPreview() {
        if (!empresaSelecionada) {
            previewSection.style.display = 'none';
            return;
        }

        const dataDesc = dataDescred.value;
        const incremento = incrementoInput.value;

        let html = `
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Empresa selecionada:</strong> ${empresaSelecionada.nome_empresa}</p>
                    <p><strong>Saldo Devedor:</strong> ${formatarMoeda(empresaSelecionada.saldo_devedor)}</p>
                    <p><strong>Percentual atual:</strong> ${empresaSelecionada.percentual.toFixed(8)}%</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Data de redistribuição:</strong> ${dataDesc ? formatarData(dataDesc) : 'Não informada'}</p>
                    <p><strong>Incremento na meta:</strong> ${incremento || '1.00'}</p>
                    <p><strong>Status:</strong> <span class="badge bg-danger">DESCREDENCIADA NO PERÍODO</span></p>
                </div>
            </div>
            <div class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Importante:</strong> O sistema irá:
                <ul class="mb-0 mt-2">
                    <li>Buscar a última tabela de visualização de metas</li>
                    <li>Preservar todos os valores anteriores à data de redistribuição</li>
                    <li>Calcular proporcionalmente aos dias úteis no mês da redistribuição</li>
                    <li>Redistribuir o percentual entre as empresas ativas</li>
                </ul>
            </div>
        `;

        document.getElementById('previewContent').innerHTML = html;
        previewSection.style.display = 'block';
    }

    // Calcular redistribuição
    btnCalcular.addEventListener('click', function() {
        if (!validarFormulario()) {
            return;
        }

        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Calculando...';

        const dados = {
            edital_id: editalSelect.value,
            periodo_id: periodoSelect.value,
            empresa_id: empresaSelecionada.id_empresa,
            data_descredenciamento: dataDescred.value,
            incremento_meta: parseFloat(incrementoInput.value)
        };

        fetch('/credenciamento/metas/calcular-nova-redistribuicao', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        })
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                resultadoCalculado = data.resultado;
                exibirResultado(data.resultado);
            } else {
                showToast('Erro ao calcular redistribuição: ' + data.erro, 'danger');
            }
        })
        .catch(error => {
            showToast('Erro ao calcular redistribuição: ' + error, 'danger');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-calculator me-2"></i>Calcular Redistribuição';
        });
    });

    // Exibir resultado
    function exibirResultado(resultado) {
        let html = `
            <h5 class="mb-3">Resumo da Redistribuição</h5>

            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                A empresa <strong>${resultado.empresa_saindo.nome}</strong>
                (SD: <strong>${formatarMoeda(resultado.empresa_saindo.saldo_devedor)}</strong>,
                Percentual: <strong>${resultado.empresa_saindo.percentual.toFixed(8)}%</strong>)
                terá suas metas redistribuídas a partir de <strong>${formatarData(resultado.data_descredenciamento)}</strong>.
            </div>

            <h6 class="mt-4 mb-3">Novos Percentuais após Redistribuição:</h6>
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Empresa</th>
                        <th class="text-end">Saldo Devedor</th>
                        <th class="text-end">% Anterior</th>
                        <th class="text-end">% Novo</th>
                        <th class="text-end">Diferença</th>
                    </tr>
                </thead>
                <tbody>
        `;

        resultado.novas_distribuicoes.forEach(dist => {
            const diferenca = dist.percentual_novo - dist.percentual_anterior;
            html += `
                <tr>
                    <td>${dist.nome_empresa}</td>
                    <td class="text-end">${formatarMoeda(dist.saldo_devedor)}</td>
                    <td class="text-end">${dist.percentual_anterior.toFixed(8)}%</td>
                    <td class="text-end">${dist.percentual_novo.toFixed(8)}%</td>
                    <td class="text-end text-success">+${diferenca.toFixed(8)}%</td>
                </tr>
            `;
        });

        html += `
                </tbody>
                <tfoot>
                    <tr class="table-secondary">
                        <th>Total</th>
                        <th class="text-end">-</th>
                        <th class="text-end">${resultado.total_percentual_anterior.toFixed(8)}%</th>
                        <th class="text-end">${resultado.total_percentual_novo.toFixed(8)}%</th>
                        <th class="text-end">-</th>
                    </tr>
                </tfoot>
            </table>
        `;

        // Adicionar tabela completa se existir
        if (resultado.tabela_completa) {
            html += `
                <div class="tabela-container">
                    <h5 class="mb-3">
                        <i class="fas fa-table me-2"></i>
                        Tabela Completa de Metas após Redistribuição
                    </h5>
                    <p class="text-muted mb-3">
                        Esta tabela mostra o estado final das metas considerando todas as redistribuições anteriores
                        e a nova redistribuição da empresa ${resultado.empresa_saindo.nome}.
                    </p>
            `;
            html += criarTabelaCompleta(resultado.tabela_completa, resultado.empresa_saindo.id);
            html += '</div>';
        }

        document.getElementById('modalResultadoContent').innerHTML = html;
        modalResultado.show();
    }

    // Criar tabela completa
    function criarTabelaCompleta(dados, empresaSaindoId) {
        let html = '<div class="table-responsive">';
        html += '<table class="tabela-redistribuicao">';

        // Cabeçalho
        html += '<thead>';
        html += '<tr>';
        html += '<th rowspan="2" class="col-empresa">DISTRIBUIÇÃO MÊS A MÊS</th>';
        html += '<th colspan="7" class="text-center">MESES DO PERÍODO</th>';
        html += '<th rowspan="2" style="vertical-align: middle;">TOTAL</th>';
        html += '</tr>';
        html += '<tr>';
        dados.meses.forEach(mes => {
            html += `<th class="text-center">${mes.nome}</th>`;
        });
        html += '</tr>';
        html += '</thead>';

        html += '<tbody>';

        // Linha dias úteis
        html += '<tr>';
        html += '<td class="col-empresa">DIAS ÚTEIS DO MÊS</td>';
        let totalDiasUteis = 0;
        dados.meses.forEach(mes => {
            html += `<td class="text-center">${mes.dias_uteis}</td>`;
            totalDiasUteis += mes.dias_uteis;
        });
        html += `<td class="text-center">${totalDiasUteis}</td>`;
        html += '</tr>';

        // Linha meta mensal SISCOR
        html += '<tr>';
        html += '<td class="col-empresa">META MENSAL SISCOR</td>';
        let totalSiscor = 0;
        dados.meses.forEach(mes => {
            html += `<td class="valor-monetario">${formatarMoeda(mes.meta_siscor)}</td>`;
            totalSiscor += mes.meta_siscor;
        });
        html += `<td class="valor-monetario">${formatarMoeda(totalSiscor)}</td>`;
        html += '</tr>';

        // Linha dias úteis período avaliativo
        html += '<tr>';
        html += '<td class="col-empresa">DIAS ÚTEIS POR MÊS DO PERÍODO AVALIATIVO</td>';
        dados.meses.forEach(mes => {
            html += `<td class="text-center">${mes.dias_uteis_periodo}</td>`;
        });
        html += `<td class="text-center">${dados.total_dias_uteis_periodo}</td>`;
        html += '</tr>';

        // Linha meta período avaliativo
        html += '<tr>';
        html += '<td class="col-empresa">META MENSAL PERÍODO AVALIATIVO</td>';
        dados.meses.forEach(mes => {
            html += `<td class="valor-monetario">${formatarMoeda(mes.meta_periodo)}</td>`;
        });
        html += `<td class="valor-monetario">${formatarMoeda(totalSiscor)}</td>`;
        html += '</tr>';

        // Linha incremento
        html += '<tr>';
        html += '<td class="col-empresa">INCREMENTO NA META</td>';
        dados.meses.forEach(mes => {
            html += `<td class="text-center">${dados.incremento.toFixed(2)}</td>`;
        });
        html += `<td class="text-center">${dados.incremento.toFixed(2)}</td>`;
        html += '</tr>';

        // Linha meta estendida
        html += '<tr class="linha-meta-estendida">';
        html += '<td class="col-empresa"><strong>META ESTENDIDA</strong></td>';
        dados.meses.forEach(mes => {
            html += `<td class="valor-monetario"><strong>${formatarMoeda(mes.meta_estendida)}</strong></td>`;
        });
        html += `<td class="valor-monetario"><strong>${formatarMoeda(totalSiscor * dados.incremento)}</strong></td>`;
        html += '</tr>';

        // Separador
        html += '<tr><td colspan="9" style="height: 10px; background-color: #f8f9fa;"></td></tr>';

        // Cabeçalho empresas
        html += '<tr>';
        html += '<td class="col-empresa"># EMPRESA SD (1) %SD</td>';
        dados.meses.forEach(mes => {
            html += `<td class="text-center">${mes.nome}</td>`;
        });
        html += '<td class="text-center">TOTAL</td>';
        html += '</tr>';

        // Linhas das empresas
        dados.empresas.forEach((empresa, index) => {
            const isDescredenciada = empresa.percentual === 0;
            const isSaindoAgora = empresa.id == empresaSaindoId;
            let rowClass = '';

            if (isSaindoAgora) {
                rowClass = 'table-warning'; // Destaca a empresa que está saindo
            } else if (isDescredenciada) {
                rowClass = 'empresa-descredenciada';
            }

            html += `<tr class="${rowClass}">`;
            html += `<td class="col-empresa" style="font-size: 11px;">`;
            html += `${index + 1} ${empresa.nome} `;
            html += `${formatarMoeda(empresa.saldo_devedor)} `;
            html += `${empresa.percentual.toFixed(8)}%`;
            if (isSaindoAgora) {
                html += ` <span class="badge bg-warning text-dark">REDISTRIBUÍDA</span>`;
            }
            html += `</td>`;

            let totalEmpresa = 0;
            dados.meses.forEach(mes => {
                const valor = empresa.metas[mes.competencia] || 0;
                html += `<td class="valor-monetario">${formatarMoeda(valor)}</td>`;
                totalEmpresa += valor;
            });

            html += `<td class="valor-monetario">${formatarMoeda(totalEmpresa)}</td>`;
            html += '</tr>';
        });

        // Linha total
        html += '<tr class="linha-total">';
        html += `<td class="col-empresa"><strong>TOTAL ${formatarMoeda(dados.total_saldo_devedor)} 100,00000000%</strong></td>`;

        dados.meses.forEach(mes => {
            let totalMes = 0;
            dados.empresas.forEach(emp => {
                totalMes += emp.metas[mes.competencia] || 0;
            });
            html += `<td class="valor-monetario"><strong>${formatarMoeda(totalMes)}</strong></td>`;
        });

        html += `<td class="valor-monetario"><strong>${formatarMoeda(totalSiscor * dados.incremento)}</strong></td>`;
        html += '</tr>';

        // Nota de rodapé
        html += '<tr>';
        html += '<td colspan="9" style="text-align: left; font-size: 10px; padding: 10px; background-color: #f8f9fa;">';
        html += '(1) Saldo devedor calculado na distribuição dos contratos';
        html += '</td>';
        html += '</tr>';

        html += '</tbody>';
        html += '</table>';
        html += '</div>';

        return html;
    }

    // Salvar redistribuição
    document.getElementById('btnConfirmarSalvar').addEventListener('click', function() {
        if (!resultadoCalculado) {
            showToast('Nenhum cálculo para salvar', 'warning');
            return;
        }

        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvando...';

        fetch('/credenciamento/metas/salvar-redistribuicao', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                edital_id: editalSelect.value,
                periodo_id: periodoSelect.value,
                empresa_id: empresaSelecionada.id_empresa,
                data_descredenciamento: dataDescred.value,
                incremento_meta: parseFloat(incrementoInput.value),
                resultado: resultadoCalculado
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                showToast('Redistribuição salva com sucesso!', 'success');
                modalResultado.hide();
                setTimeout(() => {
                    window.location.href = '{{ url_for("meta.lista_metas") }}';
                }, 2000);
            } else {
                showToast('Erro ao salvar redistribuição: ' + data.erro, 'danger');
            }
        })
        .catch(error => {
            showToast('Erro ao salvar redistribuição: ' + error, 'danger');
        })
        .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-save me-2"></i>Confirmar e Salvar';
        });
    });

    // Validar formulário
    function validarFormulario() {
        if (!editalSelect.value || !periodoSelect.value) {
            showToast('Por favor, selecione um edital e período', 'warning');
            return false;
        }

        if (!empresaSelecionada) {
            showToast('Selecione uma empresa para redistribuir', 'warning');
            return false;
        }

        if (!dataDescred.value) {
            showToast('Informe a data de redistribuição', 'warning');
            return false;
        }

        if (!incrementoInput.value || parseFloat(incrementoInput.value) <= 0) {
            showToast('Informe um incremento válido', 'warning');
            return false;
        }

        return true;
    }

    // Limpar formulário
    btnLimpar.addEventListener('click', function() {
        document.getElementById('formRedistribuicao').reset();
        empresaSelecionada = null;
        resultadoCalculado = null;
        btnCalcular.disabled = true;
        previewSection.style.display = 'none';
        carregarEmpresas();
    });

    // Eventos de mudança
    editalSelect.addEventListener('change', carregarEmpresas);
    periodoSelect.addEventListener('change', carregarEmpresas);
    dataDescred.addEventListener('change', atualizarPreview);
    incrementoInput.addEventListener('change', atualizarPreview);

    // Funções auxiliares
    function formatarMoeda(valor) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(valor);
    }

    function formatarData(data) {
        const [ano, mes, dia] = data.split('-');
        return `${dia}/${mes}/${ano}`;
    }
});
</script>
{% endblock %}