{% extends "base.html" %}

{% block title %}Lista de Vinculações - GEINC{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2">
                <a href="{{ url_for('codigo_contabil.index') }}" class="text-decoration-none">
                    <i class="fas fa-arrow-left text-secondary me-2"></i>
                </a>
                Lista de Vinculações SISCOR
            </h1>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col">
            <div class="card shadow">
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Ano</label>
                            <select name="ano" class="form-select">
                                <option value="">Todos</option>
                                {% for ano in anos_disponiveis %}
                                    <option value="{{ ano }}" {% if ano == ano_filtro %}selected{% endif %}>
                                        {{ ano }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Código</label>
                            <select name="codigo" class="form-select">
                                <option value="">Todos</option>
                                {% for codigo in codigos_disponiveis %}
                                    <option value="{{ codigo }}" {% if codigo == codigo_filtro %}selected{% endif %}>
                                        {{ codigo }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Arquivo</label>
                            <select name="arquivo" class="form-select">
                                <option value="">Todos</option>
                                {% for arquivo in arquivos_disponiveis %}
                                    <option value="{{ arquivo }}" {% if arquivo == arquivo_filtro %}selected{% endif %}>
                                        {{ arquivo }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter me-2"></i>Filtrar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Vinculações -->
    <div class="row">
        <div class="col">
            <div class="card shadow">
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="mb-0">
                                <i class="fas fa-link me-2"></i>
                                Vinculações Cadastradas
                            </h5>
                        </div>
                        <div class="col-auto">
                            <a href="{{ url_for('vinculacao.nova_vinculacao') }}" class="btn btn-success btn-sm">
                                <i class="fas fa-plus me-2"></i>Nova Vinculação
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if vinculacoes %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>ID Item</th>
                                        <th>Descrição Item SISCOR</th>
                                        <th>Código Contábil</th>
                                        <th>Ano</th>
                                        <th>Arquivo</th>
                                        <th>Arquivo 7</th>
                                        <th width="120">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for vinc in vinculacoes %}
                                    <tr>
                                        <td>{{ vinc.ID_ITEM }}</td>
                                        <td>{{ vinc.dsc_item_orcamento }}</td>
                                        <td>
                                            <strong class="text-primary">{{ vinc.CODIGO }}</strong>
                                        </td>
                                        <td>{{ vinc.ANO }}</td>
                                        <td>{{ vinc.DSC_ARQUIVO or '-' }}</td>
                                        <td>
                                            {% if vinc.ARQUIVO7 == 1 %}
                                                <span class="badge bg-success">Sim</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Não</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{{ url_for('vinculacao.editar_vinculacao', id_item=vinc.ID_ITEM, codigo=vinc.CODIGO, ano=vinc.ANO) }}"
                                               class="btn btn-sm btn-warning" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button onclick="excluirVinculacao({{ vinc.ID_ITEM }}, '{{ vinc.CODIGO }}', {{ vinc.ANO }})"
                                                    class="btn btn-sm btn-danger" title="Excluir">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-0 m-4">
                            <i class="fas fa-info-circle me-2"></i>
                            Nenhuma vinculação encontrada com os filtros aplicados.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
async function excluirVinculacao(idItem, codigo, ano) {
    // Confirmação antes de excluir
    if (!confirm('Tem certeza que deseja excluir esta vinculação?\n\nItem: ' + idItem + '\nCódigo: ' + codigo + '\nAno: ' + ano)) {
        return;
    }

    try {
        // Fazer requisição AJAX para excluir a vinculação
        const response = await fetch(`/codigos-contabeis/vinculacao/excluir/${idItem}/${encodeURIComponent(codigo)}/${ano}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest' // Importante para o backend identificar que é uma requisição AJAX
            }
        });

        const data = await response.json();

        if (data.success) {
            // Exibir mensagem de sucesso
            alert(data.message);
            // Recarregar a página para atualizar a lista
            window.location.reload();
        } else {
            // Exibir mensagem de erro
            alert('Erro: ' + data.message);
        }
    } catch (error) {
        console.error('Erro ao excluir vinculação:', error);
        alert('Erro ao excluir vinculação. Verifique o console para mais detalhes.');
    }
}
</script>
{% endblock %}