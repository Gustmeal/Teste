{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <a href="{{ url_for('codigo_contabil.index') }}" class="btn-back">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold header-with-back">Lista de Vinculações SISCOR</h1>
        <div>
            <a href="{{ url_for('vinculacao.nova_vinculacao') }}" class="btn btn-success">
                <i class="fas fa-plus me-2"></i>Nova Vinculação
            </a>
        </div>
    </div>

    <!-- Card de Filtros -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>Filtros
            </h5>
        </div>
        <div class="card-body">
            <form method="get" action="{{ url_for('vinculacao.lista_vinculacoes') }}">
                <div class="row">
                    <!-- Filtro Ano -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Ano</label>
                        <select name="ano" class="form-select">
                            <option value="">Todos os anos</option>
                            {% for ano in anos_disponiveis %}
                                <option value="{{ ano }}" {% if ano_filtro == ano %}selected{% endif %}>
                                    {{ ano }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filtro Código Contábil -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Código Contábil</label>
                        <select name="codigo" class="form-select">
                            <option value="">Todos os códigos</option>
                            {% for codigo in codigos_disponiveis %}
                                <option value="{{ codigo }}" {% if codigo_filtro == codigo %}selected{% endif %}>
                                    {{ codigo }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filtro Arquivo -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Arquivo</label>
                        <select name="arquivo" class="form-select">
                            <option value="">Todos os arquivos</option>
                            {% for arquivo in arquivos_disponiveis %}
                                <option value="{{ arquivo }}" {% if arquivo_filtro == arquivo %}selected{% endif %}>
                                    {{ arquivo }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Filtro ID Item (NOVO - CAMPO DE DIGITAÇÃO LIVRE) -->
                    <div class="col-md-3 mb-3">
                        <label class="form-label">ID Item SISCOR</label>
                        <input type="number"
                               name="id_item"
                               id="id_item"
                               class="form-control"
                               placeholder="Digite o ID Item"
                               value="{{ id_item_filtro if id_item_filtro else '' }}">
                        <small class="text-muted">Deixe em branco para ver todos</small>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="row">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-2"></i>Filtrar
                        </button>
                        <a href="{{ url_for('vinculacao.lista_vinculacoes') }}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Limpar Filtros
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Card com Tabela de Vinculações -->
    <div class="card shadow">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Vinculações Cadastradas
            </h5>
        </div>
        <div class="card-body p-0">
            {% if vinculacoes %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID Item</th>
                                <th>Descrição Item</th>
                                <th>Código Contábil</th>
                                <th>Ano</th>
                                <th>Arquivo</th>
                                <th>Arquivo 7</th>
                                <th class="text-center" width="150">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vinculacao in vinculacoes %}
                            <tr>
                                <td><strong>{{ vinculacao.ID_ITEM }}</strong></td>
                                <td>{{ vinculacao.dsc_item_orcamento }}</td>
                                <td>{{ vinculacao.CODIGO }}</td>
                                <td>{{ vinculacao.ANO }}</td>
                                <td>{{ vinculacao.DSC_ARQUIVO or '-' }}</td>
                                <td class="text-center">
                                    {% if vinculacao.ARQUIVO7 == 1 %}
                                        <span class="badge bg-success">Sim</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Não</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <a href="{{ url_for('vinculacao.editar_vinculacao', id_item=vinculacao.ID_ITEM, codigo=vinculacao.CODIGO, ano=vinculacao.ANO) }}"
                                       class="btn btn-sm btn-primary"
                                       title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button"
                                            class="btn btn-sm btn-danger"
                                            onclick="confirmarExclusao({{ vinculacao.ID_ITEM }}, '{{ vinculacao.CODIGO }}', {{ vinculacao.ANO }})"
                                            title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info m-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Nenhuma vinculação encontrada com os filtros selecionados.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="modalExcluir" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirmar Exclusão</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir esta vinculação?</p>
                <p><strong>ID Item:</strong> <span id="modal-id-item"></span></p>
                <p><strong>Código:</strong> <span id="modal-codigo"></span></p>
                <p><strong>Ano:</strong> <span id="modal-ano"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="formExcluir" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Excluir</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function confirmarExclusao(idItem, codigo, ano) {
    // Preencher dados no modal
    document.getElementById('modal-id-item').textContent = idItem;
    document.getElementById('modal-codigo').textContent = codigo;
    document.getElementById('modal-ano').textContent = ano;

    // Configurar action do formulário
    const form = document.getElementById('formExcluir');
    form.action = `/codigos-contabeis/vinculacao/excluir/${idItem}/${codigo}/${ano}`;

    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('modalExcluir'));
    modal.show();
}
</script>
{% endblock %}