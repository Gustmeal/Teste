{% extends "base.html" %}

{% block content %}
<div class="editais-container fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold">
            <i class="fas fa-ban me-2 text-danger"></i>
            Bloquear Dias
        </h1>
        <a href="{{ url_for('teletrabalho.listar_bloqueios') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar
        </a>
    </div>

    <!-- Instruções -->
    <div class="alert alert-info">
        <h5 class="alert-heading">
            <i class="fas fa-info-circle me-2"></i>Como funciona o bloqueio de dias?
        </h5>
        <ul class="mb-0">
            <li>Selecione os dias que deseja bloquear para teletrabalho</li>
            <li>Ninguém da área poderá marcar teletrabalho nos dias bloqueados</li>
            <li>Teletrabalhos já marcados não serão afetados</li>
            <li>O motivo do bloqueio será exibido aos usuários</li>
        </ul>
    </div>

    <!-- Formulário -->
    <div class="card shadow">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="fas fa-calendar-times me-2"></i>Selecionar Dias para Bloquear</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('teletrabalho.adicionar_bloqueio') }}" id="formBloquear">

                <!-- Seleção de Área (apenas para Admin/Moderador) -->
                {% if areas_disponiveis|length > 1 %}
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Área: <span class="text-danger">*</span></label>
                        <select name="area" id="areaSelect" class="form-select" required>
                            <option value="">Selecione a área</option>
                            {% for area in areas_disponiveis %}
                            <option value="{{ area }}">{{ area }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Mês de Referência: <span class="text-danger">*</span></label>
                        <select name="mes_referencia" id="mesSelect" class="form-select" required>
                            <option value="">Selecione o mês</option>
                            {% for periodo in periodos %}
                            <option value="{{ periodo.valor }}">{{ periodo.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                {% else %}
                <input type="hidden" name="area" value="{{ areas_disponiveis[0] }}" id="areaSelect">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Área:</label>
                        <input type="text" class="form-control" value="{{ areas_disponiveis[0] }}" disabled>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Mês de Referência: <span class="text-danger">*</span></label>
                        <select name="mes_referencia" id="mesSelect" class="form-select" required>
                            <option value="">Selecione o mês</option>
                            {% for periodo in periodos %}
                            <option value="{{ periodo.valor }}">{{ periodo.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                {% endif %}

                <!-- Motivo do Bloqueio -->
                <div class="mb-4">
                    <label class="form-label fw-bold">Motivo do Bloqueio:</label>
                    <textarea name="motivo" class="form-control" rows="3"
                              placeholder="Ex: Reunião importante da área, Evento corporativo, etc."></textarea>
                    <small class="text-muted">Este motivo será exibido aos usuários quando tentarem marcar teletrabalho</small>
                </div>

                <!-- Calendário -->
                <div id="calendarioContainer" style="display: none;">
                    <hr>
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-calendar-alt me-2"></i>
                        <span id="nomeCalendario">Selecione os dias</span>
                    </h5>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Atenção:</strong> Dias já com teletrabalhos agendados são mostrados, mas o bloqueio não os cancela.
                    </div>

                    <div class="calendario-bloqueio-grid" id="calendarioGrid">
                        <!-- Preenchido via JavaScript -->
                    </div>

                    <div class="mt-3">
                        <div class="alert alert-secondary">
                            <strong>Dias selecionados:</strong> <span id="contadorDias">0</span>
                        </div>
                    </div>
                </div>

                <!-- Botões -->
                <div class="mt-4">
                    <button type="submit" class="btn btn-danger btn-lg" id="btnBloquear" disabled>
                        <i class="fas fa-ban me-2"></i>Bloquear Dias Selecionados
                    </button>
                    <a href="{{ url_for('teletrabalho.listar_bloqueios') }}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.editais-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.fade-in {
    animation: fadeIn 0.5s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Grid do Calendário */
.calendario-bloqueio-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}

.dia-header {
    background: #343a40;
    color: white;
    padding: 10px;
    text-align: center;
    font-weight: bold;
    border-radius: 5px;
}

.dia-bloqueio {
    border: 2px solid #dee2e6;
    padding: 15px;
    text-align: center;
    border-radius: 8px;
    min-height: 100px;
    background: white;
    position: relative;
    transition: all 0.3s;
}

.dia-bloqueio.vazio {
    background: #f8f9fa;
    border: 1px dashed #dee2e6;
}

.dia-bloqueio.nao-util {
    background: #e9ecef;
    color: #6c757d;
}

.dia-bloqueio.feriado {
    background: #fff3cd;
}

.dia-bloqueio.ja-bloqueado {
    background: #f8d7da;
    border-color: #dc3545;
}

.dia-bloqueio.selecionavel:hover {
    border-color: #dc3545;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    cursor: pointer;
}

.dia-bloqueio.selecionado {
    background: #dc3545 !important;
    color: white !important;
    border-color: #dc3545 !important;
    transform: scale(1.05);
}

.dia-numero {
    font-size: 1.2rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.dia-info {
    font-size: 0.75rem;
    margin-top: 5px;
}

.dia-checkbox-container {
    position: absolute;
    top: 5px;
    right: 5px;
}

.dia-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.badge-teletrabalhos {
    font-size: 0.7rem;
    margin-top: 5px;
}
</style>

<script>
let diasSelecionados = [];

document.addEventListener('DOMContentLoaded', function() {
    const mesSelect = document.getElementById('mesSelect');
    const areaSelect = document.getElementById('areaSelect');
    const calendarioContainer = document.getElementById('calendarioContainer');
    const btnBloquear = document.getElementById('btnBloquear');

    // Quando selecionar mês E área, carregar calendário
    function verificarCarregarCalendario() {
        const mes = mesSelect.value;
        const area = areaSelect.value;

        if (mes && area) {
            carregarCalendario(mes, area);
            calendarioContainer.style.display = 'block';
        } else {
            calendarioContainer.style.display = 'none';
            btnBloquear.disabled = true;
        }
    }

    mesSelect.addEventListener('change', verificarCarregarCalendario);
    areaSelect.addEventListener('change', verificarCarregarCalendario);
});

function carregarCalendario(mesRef, area) {
    fetch(`/teletrabalho/bloqueios/calendario/${mesRef}?area=${area}&tipo_area=superintendencia`)
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                renderizarCalendario(data.dias, data.primeiro_dia_grid, mesRef);
            } else {
                alert('Erro ao carregar calendário: ' + (data.erro || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao carregar calendário');
        });
}

function renderizarCalendario(dias, primeiroDiaGrid, mesRef) {
    const grid = document.getElementById('calendarioGrid');
    const nomeCalendario = document.getElementById('nomeCalendario');

    // Atualizar título
    const [ano, mes] = [mesRef.substring(0, 4), mesRef.substring(4, 6)];
    const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                   'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    nomeCalendario.textContent = `${meses[parseInt(mes) - 1]} de ${ano}`;

    // Limpar grid
    grid.innerHTML = '';
    diasSelecionados = [];

    // Cabeçalho
    const diasSemana = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SÁB'];
    diasSemana.forEach(dia => {
        const header = document.createElement('div');
        header.className = 'dia-header';
        header.textContent = dia;
        grid.appendChild(header);
    });

    // Dias vazios no início
    for (let i = 0; i < primeiroDiaGrid; i++) {
        const vazio = document.createElement('div');
        vazio.className = 'dia-bloqueio vazio';
        grid.appendChild(vazio);
    }

    // Dias do mês
    dias.forEach(dia => {
        const divDia = document.createElement('div');
        divDia.className = 'dia-bloqueio';
        divDia.dataset.data = dia.data;

        let html = `<div class="dia-numero">${dia.dia}</div>`;

        if (dia.ja_bloqueado) {
            divDia.classList.add('ja-bloqueado');
            html += `<div class="dia-info">
                        <span class="badge bg-danger">JÁ BLOQUEADO</span><br>
                        <small>${dia.motivo_bloqueio || ''}</small>
                     </div>`;
        } else if (!dia.eh_util) {
            divDia.classList.add('nao-util');
            html += `<div class="dia-info">
                        <span class="badge bg-secondary">${dia.feriado || 'Fim de semana'}</span>
                     </div>`;
        } else {
            // Dia útil e não bloqueado - pode ser selecionado
            divDia.classList.add('selecionavel');

            if (dia.qtd_teletrabalhos > 0) {
                html += `<div class="badge-teletrabalhos">
                            <span class="badge bg-warning text-dark">
                                ${dia.qtd_teletrabalhos} teletrabalho(s)
                            </span>
                         </div>`;
            }

            divDia.addEventListener('click', function() {
                toggleDia(dia.data, divDia);
            });
        }

        divDia.innerHTML = html;
        grid.appendChild(divDia);
    });

    atualizarContador();
}

function toggleDia(data, elemento) {
    if (diasSelecionados.includes(data)) {
        // Remover
        diasSelecionados = diasSelecionados.filter(d => d !== data);
        elemento.classList.remove('selecionado');
    } else {
        // Adicionar
        diasSelecionados.push(data);
        elemento.classList.add('selecionado');
    }

    atualizarContador();
}

function atualizarContador() {
    document.getElementById('contadorDias').textContent = diasSelecionados.length;
    document.getElementById('btnBloquear').disabled = diasSelecionados.length === 0;
}

// Adicionar dias selecionados ao form antes de submeter
document.getElementById('formBloquear').addEventListener('submit', function(e) {
    // Remover inputs antigos
    const inputsAntigos = document.querySelectorAll('input[name="datas[]"]');
    inputsAntigos.forEach(input => input.remove());

    // Adicionar novos inputs
    diasSelecionados.forEach(data => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'datas[]';
        input.value = data;
        this.appendChild(input);
    });
});
</script>
{% endblock %}