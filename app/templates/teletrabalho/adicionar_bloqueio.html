{% extends "base.html" %}

{% block content %}
<div class="editais-container fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold">
            <i class="fas fa-ban me-2 text-danger"></i>
            Bloquear Dias
        </h1>
        <a href="{{ url_for('teletrabalho.listar_bloqueios') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Voltar
        </a>
    </div>

    <!-- Instru√ß√µes -->
    <div class="alert alert-info">
        <h5 class="alert-heading">
            <i class="fas fa-info-circle me-2"></i>Como funciona o bloqueio de dias?
        </h5>
        <ul class="mb-0">
            <li>Selecione os dias que deseja bloquear para teletrabalho</li>
            <li>Ningu√©m da √°rea poder√° marcar teletrabalho nos dias bloqueados</li>
            <li>Teletrabalhos j√° marcados n√£o ser√£o afetados</li>
            <li>O motivo do bloqueio ser√° exibido aos usu√°rios</li>
        </ul>
    </div>

    <!-- Formul√°rio -->
    <div class="card shadow">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="fas fa-calendar-times me-2"></i>Selecionar Dias para Bloquear</h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('teletrabalho.adicionar_bloqueio') }}" id="formBloquear">

                <!-- Sele√ß√£o de √Årea e M√™s -->
                {% if areas_disponiveis|length > 1 %}
                <div class="row mb-3">
                    <div class="col-md-5">
                        <label class="form-label fw-bold">√Årea: <span class="text-danger">*</span></label>
                        <select name="area" id="areaSelect" class="form-select" required>
                            <option value="">Selecione a √°rea</option>
                            {% for area in areas_disponiveis %}
                            <option value="{{ area }}">{{ area }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label fw-bold">M√™s de Refer√™ncia: <span class="text-danger">*</span></label>
                        <select name="mes_referencia" id="mesSelect" class="form-select" required>
                            <option value="">Selecione o m√™s</option>
                            {% for periodo in periodos %}
                            <option value="{{ periodo.valor }}">{{ periodo.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">&nbsp;</label>
                        <button type="button" class="btn btn-primary w-100" id="btnCarregar" onclick="manualCarregarCalendario()">
                            <i class="fas fa-sync me-2"></i>Carregar
                        </button>
                    </div>
                </div>
                {% else %}
                <input type="hidden" name="area" value="{{ areas_disponiveis[0] }}" id="areaHidden">
                <div class="row mb-3">
                    <div class="col-md-5">
                        <label class="form-label fw-bold">√Årea:</label>
                        <input type="text" class="form-control" value="{{ areas_disponiveis[0] }}" disabled>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label fw-bold">M√™s de Refer√™ncia: <span class="text-danger">*</span></label>
                        <select name="mes_referencia" id="mesSelect" class="form-select" required>
                            <option value="">Selecione o m√™s</option>
                            {% for periodo in periodos %}
                            <option value="{{ periodo.valor }}">{{ periodo.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">&nbsp;</label>
                        <button type="button" class="btn btn-primary w-100" id="btnCarregar" onclick="manualCarregarCalendario()">
                            <i class="fas fa-sync me-2"></i>Carregar
                        </button>
                    </div>
                </div>
                {% endif %}

                <!-- Motivo do Bloqueio -->
                <div class="mb-4">
                    <label class="form-label fw-bold">Motivo do Bloqueio:</label>
                    <textarea name="motivo" class="form-control" rows="3"
                              placeholder="Ex: Reuni√£o importante da √°rea, Evento corporativo, etc."></textarea>
                    <small class="text-muted">Este motivo ser√° exibido aos usu√°rios quando tentarem marcar teletrabalho</small>
                </div>

                <!-- Calend√°rio -->
                <div id="calendarioContainer" style="display: none;">
                    <hr>
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-calendar-alt me-2"></i>
                        <span id="nomeCalendario">Selecione os dias</span>
                    </h5>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Aten√ß√£o:</strong> Dias j√° com teletrabalhos agendados s√£o mostrados, mas o bloqueio n√£o os cancela.
                    </div>

                    <div class="calendario-bloqueio-grid" id="calendarioGrid">
                        <!-- Preenchido via JavaScript -->
                    </div>

                    <div class="mt-3">
                        <div class="alert alert-secondary">
                            <strong>Dias selecionados:</strong> <span id="contadorDias">0 dia(s)</span>
                        </div>
                    </div>
                </div>

                <!-- Container para inputs hidden das datas -->
                <div id="datasContainer"></div>

                <!-- Bot√µes -->
                <div class="mt-4">
                    <button type="submit" class="btn btn-secondary btn-lg" id="btnBloquear" disabled>
                        <i class="fas fa-ban me-2"></i>Bloquear Dias Selecionados
                    </button>
                    <a href="{{ url_for('teletrabalho.listar_bloqueios') }}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.editais-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.fade-in {
    animation: fadeIn 0.5s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Grid do Calend√°rio */
.calendario-bloqueio-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}

.dia-header {
    background: #343a40;
    color: white;
    padding: 10px;
    text-align: center;
    font-weight: bold;
    border-radius: 5px;
}

.dia-bloqueio {
    border: 2px solid #dee2e6;
    padding: 15px;
    text-align: center;
    border-radius: 8px;
    min-height: 100px;
    background: white;
    position: relative;
    transition: all 0.3s;
}

.dia-bloqueio.vazio {
    background: #f8f9fa;
    border: 1px dashed #dee2e6;
    cursor: default;
}

.dia-bloqueio.nao-util {
    background: #e9ecef;
    color: #6c757d;
    cursor: not-allowed;
}

.dia-bloqueio.feriado {
    background: #fff3cd;
    cursor: not-allowed;
}

.dia-bloqueio.ja-bloqueado {
    background: #f8d7da;
    border-color: #dc3545;
    cursor: not-allowed;
}

.dia-bloqueio.selecionavel {
    cursor: pointer;
}

.dia-bloqueio.selecionavel:hover {
    border-color: #dc3545;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.dia-bloqueio.selecionado {
    background: #dc3545 !important;
    color: white !important;
    border-color: #dc3545 !important;
    transform: scale(1.05);
}

.dia-bloqueio.selecionado .dia-numero,
.dia-bloqueio.selecionado .dia-info,
.dia-bloqueio.selecionado .badge {
    color: white !important;
}

.dia-numero {
    font-size: 1.2rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.dia-info {
    font-size: 0.75rem;
    margin-top: 5px;
}

.badge-teletrabalhos {
    font-size: 0.7rem;
    margin-top: 5px;
}
</style>

<script>
let diasSelecionados = [];

document.addEventListener('DOMContentLoaded', function() {
    const mesSelect = document.getElementById('mesSelect');
    const areaSelect = document.getElementById('areaSelect');
    const calendarioContainer = document.getElementById('calendarioContainer');
    const btnBloquear = document.getElementById('btnBloquear');

    console.log('‚úÖ P√°gina carregada!');

    // Evento de submit do formul√°rio
    document.getElementById('formBloquear').addEventListener('submit', function(e) {
        e.preventDefault();

        console.log('üì§ Tentando submeter formul√°rio...');
        console.log('üì§ Dias selecionados:', diasSelecionados);

        if (diasSelecionados.length === 0) {
            alert('‚ùå Selecione pelo menos um dia para bloquear!');
            return false;
        }

        // Limpar container de datas
        const datasContainer = document.getElementById('datasContainer');
        datasContainer.innerHTML = '';

        // Adicionar inputs hidden com as datas selecionadas
        diasSelecionados.forEach(data => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'datas[]';
            input.value = data;
            datasContainer.appendChild(input);
            console.log('üì§ Input adicionado:', data);
        });

        console.log('üì§ Submetendo formul√°rio...');
        // Submeter o formul√°rio
        this.submit();
    });
});

// Fun√ß√£o para carregar calend√°rio manualmente via bot√£o
function manualCarregarCalendario() {
    const mesSelect = document.getElementById('mesSelect');
    const areaSelect = document.getElementById('areaSelect');
    const areaHidden = document.getElementById('areaHidden');

    const mes = mesSelect ? mesSelect.value : '';
    let area = '';

    // ‚úÖ CORRIGIDO: Tentar pegar √°rea de v√°rias formas
    if (areaSelect && areaSelect.value) {
        area = areaSelect.value;
    } else if (areaHidden && areaHidden.value) {
        area = areaHidden.value;
    }

    console.log('üîç Tentando carregar calend√°rio...');
    console.log('üîç M√™s selecionado:', mes);
    console.log('üîç √Årea selecionada:', area);
    console.log('üîç mesSelect existe?', !!mesSelect);
    console.log('üîç areaSelect existe?', !!areaSelect);
    console.log('üîç areaHidden existe?', !!areaHidden);

    if (!mes || mes === '') {
        console.error('‚ùå M√™s n√£o selecionado!');
        alert('‚ùå Selecione o m√™s de refer√™ncia!');
        return;
    }

    if (!area || area === '') {
        console.error('‚ùå √Årea n√£o identificada!');
        alert('‚ùå √Årea n√£o identificada! Entre em contato com o suporte.');
        return;
    }

    console.log('‚úÖ Valida√ß√£o OK, carregando...');

    // Mostrar loading no bot√£o
    const btnCarregar = document.getElementById('btnCarregar');
    const textOriginal = btnCarregar.innerHTML;
    btnCarregar.disabled = true;
    btnCarregar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Carregando...';

    carregarCalendario(mes, area, function() {
        // Callback de sucesso
        btnCarregar.disabled = false;
        btnCarregar.innerHTML = textOriginal;
    }, function() {
        // Callback de erro
        btnCarregar.disabled = false;
        btnCarregar.innerHTML = textOriginal;
    });
}

function carregarCalendario(mesRef, area, successCallback, errorCallback) {
    const grid = document.getElementById('calendarioGrid');
    const calendarioContainer = document.getElementById('calendarioContainer');

    calendarioContainer.style.display = 'block';
    grid.innerHTML = '<div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-3x text-primary"></i><br><small class="text-muted mt-2">Carregando calend√°rio...</small></div>';

    const url = `/teletrabalho/bloqueios/calendario/${mesRef}?area=${encodeURIComponent(area)}&tipo_area=superintendencia`;
    console.log('üåê Fazendo requisi√ß√£o para:', url);

    fetch(url)
        .then(response => {
            console.log('üåê Resposta recebida:', response.status);
            if (!response.ok) {
                throw new Error('Erro na requisi√ß√£o: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('üåê Dados recebidos:', data);
            if (data.sucesso) {
                renderizarCalendario(data.dias, data.primeiro_dia_grid, mesRef);
                if (successCallback) successCallback();
            } else {
                alert('‚ùå Erro ao carregar calend√°rio: ' + (data.erro || 'Erro desconhecido'));
                calendarioContainer.style.display = 'none';
                if (errorCallback) errorCallback();
            }
        })
        .catch(error => {
            console.error('‚ùå Erro:', error);
            alert('‚ùå Erro ao carregar calend√°rio: ' + error.message);
            calendarioContainer.style.display = 'none';
            if (errorCallback) errorCallback();
        });
}

function renderizarCalendario(dias, primeiroDiaGrid, mesRef) {
    const grid = document.getElementById('calendarioGrid');
    const nomeCalendario = document.getElementById('nomeCalendario');

    // Atualizar t√≠tulo
    const [ano, mes] = [mesRef.substring(0, 4), mesRef.substring(4, 6)];
    const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                   'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    nomeCalendario.textContent = `${meses[parseInt(mes) - 1]} de ${ano}`;

    // Limpar grid e array de selecionados
    grid.innerHTML = '';
    diasSelecionados = [];

    console.log('üîµ Renderizando calend√°rio...');

    // Cabe√ßalho
    const diasSemana = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'S√ÅB'];
    diasSemana.forEach(dia => {
        const header = document.createElement('div');
        header.className = 'dia-header';
        header.textContent = dia;
        grid.appendChild(header);
    });

    // Dias vazios no in√≠cio
    for (let i = 0; i < primeiroDiaGrid; i++) {
        const vazio = document.createElement('div');
        vazio.className = 'dia-bloqueio vazio';
        grid.appendChild(vazio);
    }

    // Dias do m√™s
    let diasSelecionaveis = 0;
    dias.forEach(dia => {
        const divDia = document.createElement('div');
        divDia.className = 'dia-bloqueio';
        divDia.dataset.data = dia.data;

        let html = `<div class="dia-numero">${dia.dia}</div>`;

        if (dia.ja_bloqueado) {
            divDia.classList.add('ja-bloqueado');
            html += `<div class="dia-info">
                        <span class="badge bg-danger">J√Å BLOQUEADO</span><br>
                        <small class="text-muted">${dia.motivo_bloqueio || 'Sem motivo'}</small>
                     </div>`;
        } else if (!dia.eh_util) {
            divDia.classList.add('nao-util');
            html += `<div class="dia-info">
                        <span class="badge bg-secondary">${dia.feriado || 'Fim de semana'}</span>
                     </div>`;
        } else {
            // Dia √∫til e n√£o bloqueado - pode ser selecionado
            divDia.classList.add('selecionavel');
            diasSelecionaveis++;

            if (dia.qtd_teletrabalhos > 0) {
                html += `<div class="badge-teletrabalhos">
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-users"></i> ${dia.qtd_teletrabalhos}
                            </span>
                         </div>`;
            }
        }

        // ‚úÖ CORRIGIDO: Definir HTML PRIMEIRO
        divDia.innerHTML = html;

        // ‚úÖ DEPOIS adicionar ao grid
        grid.appendChild(divDia);

        // ‚úÖ E S√ì ENT√ÉO adicionar evento de click (se for selecion√°vel)
        if (divDia.classList.contains('selecionavel')) {
            divDia.style.cursor = 'pointer';
            divDia.addEventListener('click', function(e) {
                console.log('üü¢ Dia clicado:', dia.data);
                toggleDia(dia.data, divDia);
            });
        }
    });

    console.log('üîµ Total de dias selecion√°veis:', diasSelecionaveis);

    atualizarContador();
}

function toggleDia(data, elemento) {
    console.log('üü° toggleDia chamado para:', data);
    console.log('üü° Array antes:', [...diasSelecionados]);

    if (diasSelecionados.includes(data)) {
        // Remover
        diasSelecionados = diasSelecionados.filter(d => d !== data);
        elemento.classList.remove('selecionado');
        console.log('üî¥ Dia removido:', data);
    } else {
        // Adicionar
        diasSelecionados.push(data);
        elemento.classList.add('selecionado');
        console.log('üü¢ Dia adicionado:', data);
    }

    console.log('üü° Array depois:', [...diasSelecionados]);

    atualizarContador();
}

function atualizarContador() {
    const contador = document.getElementById('contadorDias');
    const btnBloquear = document.getElementById('btnBloquear');

    console.log('üîµ Atualizando contador. Dias selecionados:', diasSelecionados.length);

    contador.textContent = diasSelecionados.length + ' dia(s)';

    // ‚úÖ CORRIGIDO: Garantir que o bot√£o seja habilitado
    if (diasSelecionados.length > 0) {
        btnBloquear.disabled = false;
        btnBloquear.classList.remove('btn-secondary');
        btnBloquear.classList.add('btn-danger');
        contador.parentElement.classList.remove('alert-secondary');
        contador.parentElement.classList.add('alert-success');
        console.log('‚úÖ Bot√£o HABILITADO');
    } else {
        btnBloquear.disabled = true;
        btnBloquear.classList.remove('btn-danger');
        btnBloquear.classList.add('btn-secondary');
        contador.parentElement.classList.remove('alert-success');
        contador.parentElement.classList.add('alert-secondary');
        console.log('‚ùå Bot√£o DESABILITADO');
    }
}
</script>
{% endblock %}