{% extends "base.html" %}

{% block content %}
<div class="editais-container fade-in">
    <a href="{{ url_for('teletrabalho.index') }}" class="btn-back">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold header-with-back">
            <i class="fas fa-calendar-alt me-2"></i>
            Calendário - {{ nome_mes }}
        </h1>
        <div>
            <select id="selectPeriodo" class="form-select" onchange="mudarPeriodo()" style="width: 250px;">
                {% for periodo in periodos_disponiveis %}
                <option value="{{ periodo.valor }}" {% if periodo.valor == mes_referencia %}selected{% endif %}>
                    {{ periodo.nome }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Informações da Área -->
    <div class="card shadow mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informações</h5>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-3">
                    <h6>Área</h6>
                    <p class="mb-0 fw-bold text-primary">{{ area }}</p>
                </div>
                <div class="col-md-3">
                    <h6>Total de Pessoas</h6>
                    <p class="mb-0">{{ total_pessoas }}</p>
                </div>
                <div class="col-md-3">
                    <h6>Limite por Dia</h6>
                    <p class="mb-0 fw-bold text-success">{{ limite }} pessoas</p>
                </div>
                <div class="col-md-3">
                    <h6>Seus Dias Marcados</h6>
                    <p class="mb-0 fw-bold">{{ meus_dias|length }}/5</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Legenda -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="legenda-container">
                <div class="legenda-item">
                    <div class="legenda-box" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: 3px solid #28a745;"></div>
                    <span>Meus Dias Marcados</span>
                </div>
                <div class="legenda-item">
                    <div class="legenda-box" style="background: white; border: 2px solid #667eea;"></div>
                    <span>Disponível</span>
                </div>
                <div class="legenda-item">
                    <div class="legenda-box" style="background: linear-gradient(135deg, #ffe6e6 0%, #ffcccc 100%);"></div>
                    <span>Lotado</span>
                </div>
                <div class="legenda-item">
                    <div class="legenda-box" style="background: #f5f5f5;"></div>
                    <span>Não Útil / Feriado</span>
                </div>
                <div class="legenda-item">
                    <div class="legenda-box" style="background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border: 2px solid #dc3545;"></div>
                    <span>Bloqueado</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulário -->
    {% if pode_solicitar %}
    <form method="POST" action="{{ url_for('teletrabalho.solicitar') }}" id="formTeletrabalho">
    {% else %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Apenas usuários vinculados podem solicitar.
    </div>
    <div style="pointer-events: none; opacity: 0.6;">
    {% endif %}

        <input type="hidden" name="mes_referencia" value="{{ mes_referencia }}">

        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-0">Selecione os Dias</h5>
                    </div>
                    <div class="col-md-6 text-end">
                        <span id="contadorDias" class="badge bg-light text-dark fs-6">0 dias selecionados</span>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="p-3 bg-light border-bottom">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Tipo de Período: <span class="text-danger">*</span></label>
                            <select name="tipo_periodo" id="tipoPeriodo" class="form-select" required>
                                <option value="">Selecione...</option>
                                <option value="ALTERNADO">Dias Alternados (com intervalo)</option>
                                <option value="CINCO_DIAS_CORRIDOS">5 Dias Corridos</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Observação (opcional):</label>
                            <input type="text" name="observacao" class="form-control"
                                   placeholder="Ex: Projeto específico">
                        </div>
                    </div>
                </div>

                <!-- Calendário -->
                <div class="calendario-container p-4">
                    <div class="calendario-grid">
                        <!-- Cabeçalhos -->
                        <div class="dia-semana-header">DOM</div>
                        <div class="dia-semana-header">SEG</div>
                        <div class="dia-semana-header">TER</div>
                        <div class="dia-semana-header">QUA</div>
                        <div class="dia-semana-header">QUI</div>
                        <div class="dia-semana-header">SEX</div>
                        <div class="dia-semana-header">SÁB</div>

                        <!-- Células vazias iniciais -->
                        {% for i in range(primeiro_dia_grid) %}
                        <div class="dia-cell vazio"></div>
                        {% endfor %}

                        <!-- Dias do mês -->
                        {% for dia in dias %}
                        <div class="dia-cell
                                    {% if dia.bloqueado %}bloqueado{% endif %}
                                    {% if not dia.eh_util and not dia.bloqueado %}nao-util{% endif %}
                                    {% if dia.lotado and not dia.bloqueado %}lotado{% endif %}
                                    {% if dia.data in meus_dias %}meu-dia{% endif %}"
                             data-date="{{ dia.data }}">

                            <div class="dia-numero">{{ dia.dia }}</div>

                            {% if dia.bloqueado %}
                            <!-- ✅ DIA BLOQUEADO -->
                            <div class="dia-bloqueio-badge">
                                <span class="badge bg-danger w-100 mb-2">
                                    <i class="fas fa-ban me-1"></i>BLOQUEADO
                                </span>
                                {% if dia.motivo_bloqueio %}
                                <small class="d-block text-danger fw-bold" style="font-size: 0.7rem;">
                                    {{ dia.motivo_bloqueio }}
                                </small>
                                {% endif %}
                                {% if dia.bloqueado_por %}
                                <small class="d-block text-muted mt-1" style="font-size: 0.65rem;">
                                    Por: {{ dia.bloqueado_por }}
                                </small>
                                {% endif %}
                            </div>

                            {% elif dia.feriado %}
                            <div class="dia-feriado">
                                <i class="fas fa-flag"></i> {{ dia.feriado[:15] }}
                            </div>

                            {% elif not dia.eh_util %}
                            <div class="dia-info text-danger">
                                <small>Não útil</small>
                            </div>

                            {% else %}
                            <!-- Dia útil normal -->
                            <div class="dia-info">
                                <small class="{{ 'text-danger fw-bold' if dia.lotado else '' }}">
                                    <i class="fas fa-users"></i> {{ dia.qtd_pessoas }}/{{ limite }}
                                </small>
                            </div>

                            {% if dia.lotado %}
                            <div class="dia-badge">
                                <span class="badge bg-danger">Lotado</span>
                            </div>
                            {% elif dia.data in meus_dias %}
                            <div class="dia-badge">
                                <span class="badge bg-success">Seu Dia</span>
                            </div>
                            {% else %}
                            <div class="dia-checkbox-container">
                                <input type="checkbox" class="dia-checkbox" name="datas[]" value="{{ dia.data }}">
                            </div>
                            {% endif %}

                            <!-- Botão de pessoas (se houver) -->
                            {% if dia.pessoas %}
                            <button type="button" class="btn-pessoas"
                                    onclick="mostrarPessoas('{{ dia.data }}', {{ dia.pessoas|tojson }})">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            {% endif %}
                            {% endif %}

                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Botão de Submit -->
                <div class="p-3 bg-light border-top">
                    <div class="row">
                        <div class="col-md-12 text-center">
                            <button type="submit" class="btn btn-success btn-lg px-5" id="btnSolicitar" disabled>
                                <i class="fas fa-check me-2"></i>Solicitar Teletrabalho
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% if pode_solicitar %}
    </form>
    {% else %}
    </div>
    {% endif %}
</div>

<style>
.calendario-container { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
.calendario-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
.dia-semana-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; padding: 15px; font-weight: bold; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.dia-cell { background: white; border-radius: 12px; padding: 15px; min-height: 140px; position: relative; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
.dia-cell.vazio { background: transparent; box-shadow: none; cursor: default; }
.dia-cell:not(.nao-util):not(.lotado):not(.meu-dia):not(.vazio):not(.bloqueado):hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(108, 99, 255, 0.3); background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); }
.dia-cell.nao-util { background: #f5f5f5; cursor: not-allowed; opacity: 0.6; }
.dia-cell.lotado { background: linear-gradient(135deg, #ffe6e6 0%, #ffcccc 100%); cursor: not-allowed; }
.dia-cell.meu-dia { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: 3px solid #28a745; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4); }
.dia-cell.bloqueado { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border: 2px solid #dc3545; cursor: not-allowed; opacity: 0.9; }
.dia-numero { font-size: 1.8rem; font-weight: bold; color: #333; margin-bottom: 8px; }
.dia-cell.nao-util .dia-numero { color: #999; }
.dia-cell.bloqueado .dia-numero { color: #dc3545; }
.dia-info { font-size: 0.85rem; margin-bottom: 8px; }
.dia-feriado { font-size: 0.75rem; color: #dc3545; font-weight: 600; margin-bottom: 8px; text-align: center; }
.dia-bloqueio-badge { text-align: center; margin-top: 5px; }
.dia-checkbox-container { margin-top: auto; text-align: center; }
.dia-checkbox { width: 25px; height: 25px; cursor: pointer; border: 2px solid #667eea; border-radius: 5px; }
.dia-checkbox:checked { background-color: #667eea; border-color: #667eea; }
.dia-badge { margin-top: auto; }
.dia-badge .badge { font-size: 0.7rem; padding: 5px; }
.btn-pessoas { position: absolute; bottom: 10px; left: 10px; background: rgba(108, 99, 255, 0.9); color: white; border: none; border-radius: 20px; padding: 5px 12px; font-size: 0.8rem; cursor: pointer; transition: all 0.3s ease; }
.btn-pessoas:hover { background: rgba(108, 99, 255, 1); transform: scale(1.05); }
.legenda-container { display: flex; gap: 15px; flex-wrap: wrap; }
.legenda-item { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
.legenda-box { width: 20px; height: 20px; border-radius: 4px; display: inline-block; }
#contadorDias { padding: 8px 15px; font-weight: 600; }
@media (max-width: 768px) {
    .calendario-grid { gap: 5px; }
    .dia-cell { min-height: 100px; padding: 10px; }
    .dia-numero { font-size: 1.4rem; }
    .dia-semana-header { padding: 10px; font-size: 0.8rem; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.dia-checkbox');
    const contadorDias = document.getElementById('contadorDias');
    const btnSolicitar = document.getElementById('btnSolicitar');
    const tipoPeriodo = document.getElementById('tipoPeriodo');

    const meusDiasMarcados = [{% for dia in meus_dias %}'{{ dia }}'{% if not loop.last %},{% endif %}{% endfor %}];

    function atualizarContador() {
        const selecionados = document.querySelectorAll('.dia-checkbox:checked').length;
        contadorDias.textContent = `${selecionados} dia(s) selecionado(s)`;

        contadorDias.classList.remove('bg-light', 'bg-warning', 'bg-success', 'text-dark');
        if (selecionados === 0) {
            contadorDias.classList.add('bg-light', 'text-dark');
        } else if (selecionados < 5) {
            contadorDias.classList.add('bg-warning');
        } else {
            contadorDias.classList.add('bg-success');
        }

        btnSolicitar.disabled = selecionados === 0 || !tipoPeriodo.value;
    }

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', atualizarContador);
    });

    tipoPeriodo.addEventListener('change', atualizarContador);

    if (btnSolicitar) {
        document.getElementById('formTeletrabalho').addEventListener('submit', function(e) {
            const selecionados = document.querySelectorAll('.dia-checkbox:checked').length;
            const tipo = tipoPeriodo.value;

            if (selecionados === 0) {
                e.preventDefault();
                alert('⚠️ Selecione pelo menos um dia!');
                return false;
            }

            if (!tipoPeriodo.value) {
                e.preventDefault();
                alert('⚠️ Selecione o tipo de período!');
                return false;
            }

            if (tipoPeriodo.value === 'CINCO_DIAS_CORRIDOS' && selecionados !== 5) {
                e.preventDefault();
                alert('⚠️ Selecione exatamente 5 dias consecutivos!');
                return false;
            }

            return confirm(`Confirmar ${selecionados} dia(s)?`);
        });
    }

    atualizarContador();
});

function mudarPeriodo() {
    const mes = document.getElementById('selectPeriodo').value;
    window.location.href = `/teletrabalho/calendario/${mes}`;
}

function mostrarPessoas(data, pessoas) {
    const nomes = pessoas.map(p => p.usuario).join('\n');
    alert(`Pessoas em teletrabalho em ${data}:\n\n${nomes}`);
}
</script>
{% endblock %}