{% extends "base.html" %}

{% block content %}
<div class="editais-container fade-in">
    <a href="{{ url_for('teletrabalho.index') }}" class="btn-back">
        <i class="fas fa-arrow-left"></i> Voltar
    </a>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold header-with-back">
            <i class="fas fa-umbrella-beach me-2"></i>
            Marcar Férias
        </h1>
    </div>

    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Informação:</strong> Marque aqui os dias em que você estará de férias.
        Você não poderá marcar teletrabalho nestes dias e não será sorteado automaticamente.
    </div>

    <!-- Seleção de Mês -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-calendar me-2"></i>Selecione o Mês</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <select id="selectMes" class="form-select">
                        {% for periodo in periodos %}
                        <option value="{{ periodo.mes_ref }}">{{ periodo.nome }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" onclick="carregarCalendario()">
                        <i class="fas fa-search me-2"></i>Carregar Calendário
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendário -->
    <div id="containerCalendario" style="display: none;">
        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Selecione os Dias de Férias</h5>
            </div>
            <div class="card-body">
                <div class="legenda mb-3">
                    <span class="badge bg-success me-2">Disponível</span>
                    <span class="badge bg-warning me-2">Já marcado (Férias)</span>
                    <span class="badge bg-danger me-2">Teletrabalho marcado</span>
                    <span class="badge bg-secondary me-2">Não útil</span>
                </div>

                <div class="calendario-grid" id="calendarioGrid"></div>
            </div>
            <div class="card-footer">
                <button class="btn btn-success btn-lg" onclick="salvarFerias()">
                    <i class="fas fa-save me-2"></i>Salvar Férias
                </button>
            </div>
        </div>
    </div>

    <!-- Férias Marcadas -->
    {% if ferias_marcadas %}
    <div class="card shadow">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Férias Já Marcadas</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Mês</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ferias in ferias_marcadas %}
                        <tr>
                            <td>{{ ferias.DATA_TELETRABALHO.strftime('%d/%m/%Y') }}</td>
                            <td>{{ ferias.MES_REFERENCIA[:4] }}/{{ ferias.MES_REFERENCIA[4:] }}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="excluirFerias({{ ferias.ID }})">
                                    <i class="fas fa-trash"></i> Remover
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.calendario-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
.dia-header { background: #667eea; color: white; text-align: center; padding: 10px; font-weight: bold; border-radius: 5px; }
.dia-cell { background: white; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; min-height: 100px; cursor: pointer; transition: all 0.3s; }
.dia-cell:hover:not(.nao-util):not(.ja-marcado-teletrabalho) { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
.dia-cell.nao-util { background: #f5f5f5; cursor: not-allowed; opacity: 0.6; }
.dia-cell.ja-marcado-ferias { background: #fff3cd; border-color: #ffc107; }
.dia-cell.ja-marcado-teletrabalho { background: #f8d7da; border-color: #dc3545; cursor: not-allowed; }
.dia-cell.selecionado { background: #d4edda; border-color: #28a745; }
.dia-numero { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; }
.dia-checkbox { width: 20px; height: 20px; margin-top: 10px; }
</style>

<script>
let dadosCalendario = null;

function carregarCalendario() {
    const mesRef = document.getElementById('selectMes').value;

    fetch(`/teletrabalho/ferias/calendario/${mesRef}`)
        .then(r => r.json())
        .then(data => {
            if (data.sucesso) {
                dadosCalendario = data;
                renderizarCalendario(data);
                document.getElementById('containerCalendario').style.display = 'block';
            } else {
                alert('Erro: ' + data.erro);
            }
        })
        .catch(e => alert('Erro: ' + e));
}

function renderizarCalendario(data) {
    const grid = document.getElementById('calendarioGrid');
    let html = '';

    // Headers
    ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SÁB'].forEach(dia => {
        html += `<div class="dia-header">${dia}</div>`;
    });

    // Espaços vazios
    for (let i = 0; i < data.primeiro_dia_grid; i++) {
        html += '<div></div>';
    }

    // Dias
    data.dias.forEach(dia => {
        let classes = 'dia-cell';
        let disabled = '';

        if (!dia.eh_util) {
            classes += ' nao-util';
            disabled = 'disabled';
        } else if (dia.ja_marcado_teletrabalho) {
            classes += ' ja-marcado-teletrabalho';
            disabled = 'disabled';
        } else if (dia.ja_marcado_ferias) {
            classes += ' ja-marcado-ferias';
        }

        html += `<div class="${classes}">`;
        html += `<div class="dia-numero">${dia.dia}</div>`;

        if (dia.feriado) {
            html += `<small class="text-danger">${dia.feriado.substring(0, 10)}</small>`;
        } else if (dia.ja_marcado_teletrabalho) {
            html += '<small class="text-danger">Teletrabalho</small>';
        } else if (dia.ja_marcado_ferias) {
            html += '<small class="text-warning">Férias</small>';
        } else if (!dia.eh_util) {
            html += '<small class="text-muted">Não útil</small>';
        } else {
            html += `<input type="checkbox" class="dia-checkbox" value="${dia.data}" ${disabled}>`;
        }

        html += '</div>';
    });

    grid.innerHTML = html;
}

function salvarFerias() {
    const mesRef = document.getElementById('selectMes').value;
    const checkboxes = document.querySelectorAll('.dia-checkbox:checked');
    const datas = Array.from(checkboxes).map(cb => cb.value);

    if (datas.length === 0) {
        alert('Selecione pelo menos um dia!');
        return;
    }

    fetch('/teletrabalho/ferias/salvar', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({datas, mes_referencia: mesRef})
    })
    .then(r => r.json())
    .then(data => {
        if (data.sucesso) {
            alert(data.mensagem);
            location.reload();
        } else {
            alert('Erro: ' + data.erro);
        }
    })
    .catch(e => alert('Erro: ' + e));
}

function excluirFerias(id) {
    if (!confirm('Remover este dia de férias?')) return;

    fetch(`/teletrabalho/ferias/excluir/${id}`, {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.sucesso) {
            alert(data.mensagem);
            location.reload();
        } else {
            alert('Erro: ' + data.erro);
        }
    })
    .catch(e => alert('Erro: ' + e));
}
</script>
{% endblock %}